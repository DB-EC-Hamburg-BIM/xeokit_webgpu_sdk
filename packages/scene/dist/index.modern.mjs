import{Component as e,EventEmitter as t,SDKError as r}from"@xeokit/core";import{newFloatArray as n,MAX_DOUBLE as o,MIN_DOUBLE as i,DEGTORAD as s}from"@xeokit/math";import{EventDispatcher as a}from"strongly-typed-events";import{createVec3 as c,createMat4 as l,subVec3 as u,lenVec3 as d,transformPositions3 as h,createVec4 as f,identityMat4 as g,dotVec3 as p,cross3Vec3 as m,normalizeVec3 as y}from"@xeokit/matrix";import{decompressPoint3 as w,decompressPositions3 as b,quantizePositions3 as v}from"@xeokit/compression";var x=0;function S(e){return"__private_"+x+++"_"+e}function T(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}function M(e,t){if(!e)throw new Error(t||"loader assertion failed.")}const k=Boolean("object"!=typeof process||"[object process]"!==String(process)||process.browser);function _(e,t){if(!e)throw new Error(t||"loaders.gl assertion failed.")}"undefined"!=typeof process&&process.version&&/v([0-9]*)/.exec(process.version);const A={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:"undefined"!=typeof global&&global,document:"undefined"!=typeof document&&document},B=A.global||A.self||A.window||{},I="object"!=typeof process||"[object process]"!==String(process)||process.browser,j="function"==typeof importScripts,C="undefined"!=typeof window&&void 0!==window.orientation;function E(e){return E="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},E(e)}function P(e,t,r){return(t=function(e){var t=function(e,t){if("object"!==E(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,"string");if("object"!==E(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"===E(t)?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}"undefined"!=typeof process&&process.version&&/v([0-9]*)/.exec(process.version);class L{constructor(e,t){P(this,"name",void 0),P(this,"workerThread",void 0),P(this,"isRunning",!0),P(this,"result",void 0),P(this,"_resolve",()=>{}),P(this,"_reject",()=>{}),this.name=e,this.workerThread=t,this.result=new Promise((e,t)=>{this._resolve=e,this._reject=t})}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){_(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){_(this.isRunning),this.isRunning=!1,this._reject(e)}}class F{terminate(){}}const O=new Map;function U(e){const t=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(t)}function R(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2?arguments[2]:void 0;const n=r||new Set;if(e)if(D(e))n.add(e);else if(D(e.buffer))n.add(e.buffer);else if(ArrayBuffer.isView(e));else if(t&&"object"==typeof e)for(const r in e)R(e[r],t,n);return void 0===r?Array.from(n):[]}function D(e){return!!e&&(e instanceof ArrayBuffer||"undefined"!=typeof MessagePort&&e instanceof MessagePort||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas)}function G(e){if(null===e)return{};const t=Object.assign({},e);return Object.keys(t).forEach(r=>{t[r]="object"!=typeof e[r]||ArrayBuffer.isView(e[r])||e[r]instanceof Array?"function"==typeof t[r]||t[r]instanceof RegExp?{}:e[r]:G(e[r])}),t}const W=()=>{};class N{static isSupported(){return"undefined"!=typeof Worker&&I||void 0!==F&&!I}constructor(e){P(this,"name",void 0),P(this,"source",void 0),P(this,"url",void 0),P(this,"terminated",!1),P(this,"worker",void 0),P(this,"onMessage",void 0),P(this,"onError",void 0),P(this,"_loadableURL","");const{name:t,source:r,url:n}=e;_(r||n),this.name=t,this.source=r,this.url=n,this.onMessage=W,this.onError=e=>console.log(e),this.worker=I?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=W,this.onError=W,this.worker.terminate(),this.terminated=!0}get isRunning(){return Boolean(this.onMessage)}postMessage(e,t){t=t||R(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+="worker ".concat(this.name," from ").concat(this.url,". "),e.message&&(t+="".concat(e.message," in ")),e.lineno&&(t+=":".concat(e.lineno,":").concat(e.colno)),new Error(t)}_createBrowserWorker(){this._loadableURL=function(e){_(e.source&&!e.url||!e.source&&e.url);let t=O.get(e.source||e.url);return t||(e.url&&(t=(r=e.url).startsWith("http")?U("try {\n  importScripts('".concat(r,"');\n} catch (error) {\n  console.error(error);\n  throw error;\n}")):r,O.set(e.url,t)),e.source&&(t=U(e.source),O.set(e.source,t))),_(t),t;var r}({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=e=>{e.data?this.onMessage(e.data):this.onError(new Error("No data received"))},e.onerror=e=>{this.onError(this._getErrorFromErrorEvent(e)),this.terminated=!0},e.onmessageerror=e=>console.error(e),e}_createNodeWorker(){let e;if(this.url){const t=this.url.includes(":/")||this.url.startsWith("/")?this.url:"./".concat(this.url);e=new F(t,{eval:!1})}else{if(!this.source)throw new Error("no worker");e=new F(this.source,{eval:!0})}return e.on("message",e=>{this.onMessage(e)}),e.on("error",e=>{this.onError(e)}),e.on("exit",e=>{}),e}}class ${static isSupported(){return N.isSupported()}constructor(e){P(this,"name","unnamed"),P(this,"source",void 0),P(this,"url",void 0),P(this,"maxConcurrency",1),P(this,"maxMobileConcurrency",1),P(this,"onDebug",()=>{}),P(this,"reuseWorkers",!0),P(this,"props",{}),P(this,"jobQueue",[]),P(this,"idleQueue",[]),P(this,"count",0),P(this,"isDestroyed",!1),this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},void 0!==e.name&&(this.name=e.name),void 0!==e.maxConcurrency&&(this.maxConcurrency=e.maxConcurrency),void 0!==e.maxMobileConcurrency&&(this.maxMobileConcurrency=e.maxMobileConcurrency),void 0!==e.reuseWorkers&&(this.reuseWorkers=e.reuseWorkers),void 0!==e.onDebug&&(this.onDebug=e.onDebug)}async startJob(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(e,t,r)=>e.done(r),r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(e,t)=>e.error(t);const n=new Promise(n=>(this.jobQueue.push({name:e,onMessage:t,onError:r,onStart:n}),this));return this._startQueuedJob(),await n}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});const r=new L(t.name,e);e.onMessage=e=>t.onMessage(r,e.type,e.payload),e.onError=e=>t.onError(r,e),t.onStart(r);try{await r.result}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e="".concat(this.name.toLowerCase()," (#").concat(this.count," of ").concat(this.maxConcurrency,")");return new N({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return C?this.maxMobileConcurrency:this.maxConcurrency}}const H={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}};class V{static isSupported(){return N.isSupported()}static getWorkerFarm(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return V._workerFarm=V._workerFarm||new V({}),V._workerFarm.setProps(e),V._workerFarm}constructor(e){P(this,"props",void 0),P(this,"workerPools",new Map),this.props={...H},this.setProps(e),this.workerPools=new Map}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const e of this.workerPools.values())e.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:t,source:r,url:n}=e;let o=this.workerPools.get(t);return o||(o=new $({name:t,source:r,url:n}),o.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,o)),o}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}P(V,"_workerFarm",void 0);const Q="latest",J="3.3.1";function z(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=t[e.id]||{},n="".concat(e.id,"-worker.js");let o=r.workerUrl;if(o||"compression"!==e.id||(o=t.workerUrl),"test"===t._workerType&&(o="modules/".concat(e.module,"/dist/").concat(n)),!o){let t=e.version;"latest"===t&&(t=Q);const r=t?"@".concat(t):"";o="https://unpkg.com/@loaders.gl/".concat(e.module).concat(r,"/dist/").concat(n)}return _(o),o}async function q(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const o=function(e){const t=e.version!==J?" (worker-utils@".concat(J,")"):"";return"".concat(e.name,"@").concat(e.version).concat(t)}(e),i=V.getWorkerFarm(r),{source:s}=r,a={name:o,source:s};s||(a.url=z(e,r));const c=i.getWorkerPool(a),l=r.jobName||e.name,u=await c.startJob(l,K.bind(null,n)),d=G(r);return u.postMessage("process",{input:t,options:d}),(await u.result).result}async function K(e,t,r,n){switch(r){case"done":t.done(n);break;case"error":t.error(new Error(n.error));break;case"process":const{id:o,input:i,options:s}=n;try{if(!e.process)return void t.postMessage("error",{id:o,error:"Worker not set up to process on main thread"});const r=await e.process(i,s);t.postMessage("done",{id:o,result:r})}catch(e){const r=e instanceof Error?e.message:"unknown error";t.postMessage("error",{id:o,error:r})}break;default:console.warn("process-on-worker: unknown message ".concat(r))}}var Y={__proto__:null,default:{}};const X={};async function Z(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return t&&(e=function(e,t,r){if(e.startsWith("http"))return e;const n=r.modules||{};return n[e]?n[e]:I?r.CDN?(_(r.CDN.startsWith("http")),"".concat(r.CDN,"/").concat(t,"@").concat("3.3.1","/dist/libs/").concat(e)):j?"../src/libs/".concat(e):"modules/".concat(t,"/src/libs/").concat(e):"modules/".concat(t,"/dist/libs/").concat(e)}(e,t,arguments.length>2&&void 0!==arguments[2]?arguments[2]:{})),X[e]=X[e]||async function(e){if(e.endsWith("wasm")){const t=await fetch(e);return await t.arrayBuffer()}if(!I)try{return Y&&void 0}catch{return null}if(j)return importScripts(e);const t=await fetch(e);return function(e,t){if(!I)return;if(j)return eval.call(B,e),null;const r=document.createElement("script");r.id=t;try{r.appendChild(document.createTextNode(e))}catch(t){r.text=e}return document.body.appendChild(r),null}(await t.text(),e)}(e),await X[e]}async function ee(e,t,r,n,o){const i=e.id,s=z(e,r),a=V.getWorkerFarm(r).getWorkerPool({name:i,url:s});r=JSON.parse(JSON.stringify(r)),n=JSON.parse(JSON.stringify(n||{}));const c=await a.startJob("process-on-worker",te.bind(null,o));c.postMessage("process",{input:t,options:r,context:n});const l=await c.result;return await l.result}async function te(e,t,r,n){switch(r){case"done":t.done(n);break;case"error":t.error(new Error(n.error));break;case"process":const{id:o,input:i,options:s}=n;try{const r=await e(i,s);t.postMessage("done",{id:o,result:r})}catch(e){const r=e instanceof Error?e.message:"unknown error";t.postMessage("error",{id:o,error:r})}break;default:console.warn("parse-with-worker unknown message ".concat(r))}}function re(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];const n=t.map(e=>e instanceof ArrayBuffer?new Uint8Array(e):e),o=n.reduce((e,t)=>e+t.byteLength,0),i=new Uint8Array(o);let s=0;for(const e of n)i.set(e,s),s+=e.byteLength;return i.buffer}let ne="";const oe={};function ie(e){for(const t in oe)e.startsWith(t)&&(e=e.replace(t,oe[t]));return e.startsWith("http://")||e.startsWith("https://")||(e="".concat(ne).concat(e)),e}function se(e){if((t=e)&&"object"==typeof t&&t.isBuffer)return(void 0)(e);var t;if(e instanceof ArrayBuffer)return e;if(ArrayBuffer.isView(e))return 0===e.byteOffset&&e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength);if("string"==typeof e){const t=e;return(new TextEncoder).encode(t).buffer}if(e&&"object"==typeof e&&e._toArrayBuffer)return e._toArrayBuffer();throw new Error("toArrayBuffer")}const ae="3.3.1",ce="https://unpkg.com/@loaders.gl/textures@".concat(ae,"/dist/libs/basis_encoder.wasm"),le="https://unpkg.com/@loaders.gl/textures@".concat(ae,"/dist/libs/basis_encoder.js");let ue;const de={name:"Basis Universal Supercompressed GPU Texture",id:"ktx2-basis-writer",module:"textures",version:"3.3.1",extensions:["ktx2"],options:{useSRGB:!1,qualityLevel:10,encodeUASTC:!1,mipmaps:!1},encode:async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{useSRGB:r=!1,qualityLevel:n=10,encodeUASTC:o=!1,mipmaps:i=!1}=t,{BasisEncoder:s}=await async function(e){const t=e.modules||{};return t.basisEncoder?t.basisEncoder:(ue=ue||async function(e){let t=null,r=null;return[t,r]=await Promise.all([await Z(le,"textures",e),await Z(ce,"textures",e)]),t=t||globalThis.BASIS,await function(e,t){const r={};return t&&(r.wasmBinary=t),new Promise(t=>{e(r).then(e=>{const{BasisFile:r,KTX2File:n,initializeBasis:o,BasisEncoder:i}=e;o(),t({BasisFile:r,KTX2File:n,BasisEncoder:i})})})}(t,r)}(e),await ue)}(t),a=new s;try{const t=new Uint8Array(e.width*e.height*4);a.setCreateKTX2File(!0),a.setKTX2UASTCSupercompression(!0),a.setKTX2SRGBTransferFunc(!0),a.setSliceSourceImage(0,e.data,e.width,e.height,!1),a.setPerceptual(r),a.setMipSRGB(r),a.setQualityLevel(n),a.setUASTC(o),a.setMipGen(i);const s=a.encode(t);return t.subarray(0,s).buffer}catch(e){throw console.error("Basis Universal Supercompressed GPU Texture encoder Error: ",e),e}finally{a.delete()}}},{_parseImageNode:he}=globalThis,fe="undefined"!=typeof Image,ge="undefined"!=typeof ImageBitmap,pe=Boolean(he),me=!!k||pe,ye=/^data:image\/svg\+xml/,we=/\.svg((\?|#).*)?$/;function be(e){return e&&(ye.test(e)||we.test(e))}function ve(e,t){if(be(t))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(e)])}async function xe(e,t,r){const n=function(e,t){if(be(t)){let t=(new TextDecoder).decode(e);try{"function"==typeof unescape&&"function"==typeof encodeURIComponent&&(t=unescape(encodeURIComponent(t)))}catch(e){throw new Error(e.message)}return"data:image/svg+xml;base64,".concat(btoa(t))}return ve(e,t)}(e,r),o=self.URL||self.webkitURL,i="string"!=typeof n&&o.createObjectURL(n);try{return await async function(e,t){const r=new Image;return r.src=e,t.image&&t.image.decode&&r.decode?(await r.decode(),r):await new Promise((t,n)=>{try{r.onload=()=>t(r),r.onerror=t=>n(new Error("Could not load image ".concat(e,": ").concat(t)))}catch(e){n(e)}})}(i||n,t)}finally{i&&o.revokeObjectURL(i)}}const Se={};let Te=!0;const Me=!1,ke=!0;function _e(e){const t=Ae(e);return function(e){const t=Ae(e);return t.byteLength>=24&&2303741511===t.getUint32(0,Me)?{mimeType:"image/png",width:t.getUint32(16,Me),height:t.getUint32(20,Me)}:null}(t)||function(e){const t=Ae(e);if(!(t.byteLength>=3&&65496===t.getUint16(0,Me)&&255===t.getUint8(2)))return null;const{tableMarkers:r,sofMarkers:n}=function(){const e=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)e.add(t);return{tableMarkers:e,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}();let o=2;for(;o+9<t.byteLength;){const e=t.getUint16(o,Me);if(n.has(e))return{mimeType:"image/jpeg",height:t.getUint16(o+5,Me),width:t.getUint16(o+7,Me)};if(!r.has(e))return null;o+=2,o+=t.getUint16(o,Me)}return null}(t)||function(e){const t=Ae(e);return t.byteLength>=10&&1195984440===t.getUint32(0,Me)?{mimeType:"image/gif",width:t.getUint16(6,ke),height:t.getUint16(8,ke)}:null}(t)||function(e){const t=Ae(e);return t.byteLength>=14&&16973===t.getUint16(0,Me)&&t.getUint32(2,ke)===t.byteLength?{mimeType:"image/bmp",width:t.getUint32(18,ke),height:t.getUint32(22,ke)}:null}(t)}function Ae(e){if(e instanceof DataView)return e;if(ArrayBuffer.isView(e))return new DataView(e.buffer);if(e instanceof ArrayBuffer)return new DataView(e);throw new Error("toDataView")}const Be={id:"image",module:"images",name:"Images",version:"3.3.1",mimeTypes:["image/png","image/jpeg","image/gif","image/webp","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],extensions:["png","jpg","jpeg","gif","webp","bmp","ico","svg"],parse:async function(e,t,r){const n=((t=t||{}).image||{}).type||"auto",{url:o}=r||{};let i;switch(function(e){switch(e){case"auto":case"data":return function(){if(ge)return"imagebitmap";if(fe)return"image";if(me)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}();default:return function(e){switch(e){case"auto":return ge||fe||me;case"imagebitmap":return ge;case"image":return fe;case"data":return me;default:throw new Error("@loaders.gl/images: image ".concat(e," not supported in this environment"))}}(e),e}}(n)){case"imagebitmap":i=await async function(e,t,r){let n;n=be(r)?await xe(e,t,r):ve(e,r);const o=t&&t.imagebitmap;return await async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!function(e){for(const t in e||Se)return!1;return!0}(t)&&Te||(t=null),t)try{return await createImageBitmap(e,t)}catch(e){console.warn(e),Te=!1}return await createImageBitmap(e)}(n,o)}(e,t,o);break;case"image":i=await xe(e,t,o);break;case"data":i=await async function(e,t){const{mimeType:r}=_e(e)||{},n=globalThis._parseImageNode;return M(n),await n(e,r)}(e);break;default:M(!1)}return"data"===n&&(i=function(e){switch(function(e){const t=function(e){return"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?"imagebitmap":"undefined"!=typeof Image&&e instanceof Image?"image":e&&"object"==typeof e&&e.data&&e.width&&e.height?"data":null}(e);if(!t)throw new Error("Not an image");return t}(e)){case"data":return e;case"image":case"imagebitmap":const t=document.createElement("canvas"),r=t.getContext("2d");if(!r)throw new Error("getImageData");return t.width=e.width,t.height=e.height,r.drawImage(e,0,0),r.getImageData(0,0,e.width,e.height);default:throw new Error("getImageData")}}(i)),i},tests:[e=>Boolean(_e(new DataView(e)))],options:{image:{type:"auto",decode:!0}}};var Ie=1e3,je=2e4,Ce=20001,Ee=20002,Pe=20003,Le=20004;function Fe(e){return new Float64Array(e||6)}function Oe(e){return void 0===e&&(e=Fe()),e[0]=o,e[1]=o,e[2]=o,e[3]=i,e[4]=i,e[5]=i,e}function Ue(e,t){for(var r,n,o,i=0,s=t.length;i<s;i+=3)n=t[i+1],o=t[i+2],e[0]>(r=t[i])&&(e[0]=r),e[1]>n&&(e[1]=n),e[2]>o&&(e[2]=o),e[3]<r&&(e[3]=r),e[4]<n&&(e[4]=n),e[5]<o&&(e[5]=o);return e}c(),c(),l(),n(3),n(3),n(3),n(3),n(3),n(3),n(3);class Re{constructor(e){this.positionsCompressed=void 0,this.uvsCompressed=void 0,this.colorsCompressed=void 0,this.indices=void 0,this.edgeIndices=void 0,this.positionsCompressed=e.positionsCompressed,this.uvsCompressed=e.uvsCompressed,this.colorsCompressed=e.colorsCompressed,this.indices=e.indices,this.edgeIndices=e.edgeIndices}}class De{constructor(e){this.id=void 0,this.primitive=void 0,this.positionsDecompressMatrix=void 0,this.aabb=void 0,this.uvsDecompressMatrix=void 0,this.geometryBuckets=void 0,this.rendererGeometry=void 0,this.geometryBuckets=[];for(let t=0,r=e.geometryBuckets.length;t<r;t++)this.geometryBuckets[t]=new Re(e.geometryBuckets[t]);this.id=e.id,this.positionsDecompressMatrix=e.positionsDecompressMatrix,this.primitive=e.primitive}}var Ge=/*#__PURE__*/S("positionsDecompressed"),We=/*#__PURE__*/S("positionsWorld");const Ne=new class{constructor(){this.object=void 0,this.mesh=void 0,this.meshIndex=void 0,this.geometry=void 0,this.geometryBucket=void 0,this.geometryBucketIndex=void 0,Object.defineProperty(this,Ge,{writable:!0,value:void 0}),Object.defineProperty(this,We,{writable:!0,value:void 0}),this.object=null,this.mesh=null,this.meshIndex=0,this.geometry=null,this.geometryBucket=null,this.geometryBucketIndex=0,T(this,Ge)[Ge]=null,T(this,We)[We]=null}get totalGeometryBuckets(){let e=0;if(this.object)for(let t=0,r=this.object.meshes.length;t<r;t++)e+=this.object.meshes[t].geometry.geometryBuckets.length;return e}get numPrimitives(){const e=this.geometry.primitive;return this.geometryBucket.indices.length/(e===Ee?3:e===Ce?2:1)}get positionsDecompressed(){return T(this,Ge)[Ge]||(T(this,Ge)[Ge]=new Float32Array(this.geometryBucket.positionsCompressed.length),b(this.geometryBucket.positionsCompressed,this.geometry.positionsDecompressMatrix,T(this,Ge)[Ge])),T(this,Ge)[Ge]}get positionsWorld(){if(!T(this,We)[We]){const e=this.positionsDecompressed;T(this,We)[We]=new Float64Array(e.length),h(e,this.mesh.matrix,T(this,We)[We])}return T(this,We)[We]}get uvsDecompressed(){return null}reset(){T(this,Ge)[Ge]=null,T(this,We)[We]=null}};function $e(e,t){Ne.reset(),Ne.object=e;for(let r=0,n=e.meshes.length;r<n;r++){const n=e.meshes[r];Ne.mesh=n,Ne.meshIndex=r;const o=n.geometry;Ne.geometry=o;for(let e=0,r=o.geometryBuckets.length;e<r;e++)if(Ne.geometryBucket=o.geometryBuckets[e],Ne.geometryBucketIndex=e,t(Ne))return!0}return!1}var He=/*#__PURE__*/S("aabb"),Ve=/*#__PURE__*/S("aabbDirty");class Qe{constructor(e){this.model=void 0,this.id=void 0,this.meshes=void 0,this.layerId=void 0,this.rendererObject=void 0,Object.defineProperty(this,He,{writable:!0,value:void 0}),Object.defineProperty(this,Ve,{writable:!0,value:void 0}),this.id=e.id,this.layerId=e.layerId,this.meshes=e.meshes,T(this,He)[He]=Fe(),T(this,Ve)[Ve]=!0,this.rendererObject=null}get aabb(){return T(this,Ve)[Ve]&&(Oe(T(this,He)[He]),$e(this,e=>(Ue(T(this,He)[He],e.positionsWorld),!1)),T(this,Ve)[Ve]=!1),T(this,He)[He]}setAABBDirty(){T(this,Ve)[Ve]=!0}}class Je{constructor(e,t){this.id=void 0,this.colorTexture=void 0,this.metallicRoughnessTexture=void 0,this.occlusionTexture=void 0,this.emissiveTexture=void 0,this.rendererTextureSet=void 0,this.id=e.id,this.colorTexture=t.colorTexture,this.metallicRoughnessTexture=t.metallicRoughnessTexture,this.occlusionTexture=t.occlusionTexture,this.emissiveTexture=t.emissiveTexture,this.rendererTextureSet=null}}class ze{constructor(e){this.rendererTexture=void 0,this.id=void 0,this.src=void 0,this.imageData=void 0,this.buffers=void 0,this.image=void 0,this.height=void 0,this.width=void 0,this.compressed=void 0,this.mediaType=void 0,this.magFilter=void 0,this.minFilter=void 0,this.wrapS=void 0,this.wrapT=void 0,this.wrapR=void 0,this.flipY=void 0,this.encoding=void 0,this.preloadColor=void 0,this.channel=void 0,this.id=e.id,this.imageData=e.imageData,this.src=e.src,this.mediaType=e.mediaType,this.minFilter=e.minFilter||1007,this.magFilter=e.magFilter||1007,this.wrapS=e.wrapS||Ie,this.wrapT=e.wrapT||Ie,this.wrapR=e.wrapR||Ie,this.encoding=e.encoding||3e3,this.preloadColor=f(e.preloadColor||[1,1,1,1]),this.channel=0,this.rendererTexture=null}}var qe=/*#__PURE__*/S("color"),Ke=/*#__PURE__*/S("matrix"),Ye=/*#__PURE__*/S("metallic"),Xe=/*#__PURE__*/S("roughness"),Ze=/*#__PURE__*/S("opacity");class et{constructor(e){this.id=void 0,this.geometry=void 0,this.textureSet=void 0,this.rendererMesh=void 0,this.object=void 0,Object.defineProperty(this,qe,{writable:!0,value:void 0}),Object.defineProperty(this,Ke,{writable:!0,value:void 0}),Object.defineProperty(this,Ye,{writable:!0,value:void 0}),Object.defineProperty(this,Xe,{writable:!0,value:void 0}),Object.defineProperty(this,Ze,{writable:!0,value:void 0}),this.id=e.id,T(this,Ke)[Ke]=e.matrix?l(e.matrix):g(),this.geometry=e.geometry,this.textureSet=e.textureSet,this.rendererMesh=null,this.color=e.color||c([1,1,1]),this.metallic=null!=e.metallic?e.metallic:0,this.roughness=null!=e.roughness?e.roughness:1,this.opacity=null!=e.opacity?e.opacity:1}get color(){return T(this,qe)[qe]}set color(e){let t=T(this,qe)[qe];t||(t=T(this,qe)[qe]=new Float32Array(4),t[3]=1),e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.rendererMesh&&this.rendererMesh.setColor(T(this,qe)[qe])}get matrix(){return T(this,Ke)[Ke]}set matrix(e){e?T(this,Ke)[Ke].set(e):g(T(this,Ke)[Ke]),this.rendererMesh&&this.rendererMesh.setMatrix(T(this,Ke)[Ke]),this.object&&this.object.setAABBDirty()}get metallic(){return T(this,Ye)[Ye]}set metallic(e){e=null!=e?e:1,T(this,Ye)[Ye]!==e&&(T(this,Ye)[Ye]=e,this.rendererMesh&&this.rendererMesh.setMetallic(T(this,Ye)[Ye]))}get roughness(){return T(this,Xe)[Xe]}set roughness(e){e=null!=e?e:1,T(this,Xe)[Xe]!==e&&(T(this,Xe)[Xe]=e,this.rendererMesh&&this.rendererMesh.setRoughness(T(this,Xe)[Xe]))}get opacity(){return T(this,Ze)[Ze]}set opacity(e){e=null!=e?e:1,T(this,Ze)[Ze]!==e&&(T(this,Ze)[Ze]=e)}}const tt=[],rt=[],nt=[],ot=[],it=[];let st=0;const at=new Uint16Array(3),ct=new Uint16Array(3),lt=new Uint16Array(3),ut=c(),dt=c(),ht=c(),ft=c(),gt=c(),pt=c(),mt=c();let yt=null;function wt(e,t){let r;for(let n=0;n<3;n++)if(0!=(r=yt[3*e+n]-yt[3*t+n]))return r;return 0}let bt=null,vt=null;function xt(e,t){let r,n,o,i,s,a,c=3*e,l=3*t;const u=Math.min(r=vt[c],n=vt[c+1],o=vt[c+2]),d=Math.min(i=vt[l],s=vt[l+1],a=vt[l+2]);if(u!=d)return u-d;const h=Math.max(r,n,o),f=Math.max(i,s,a);return h!=f?h-f:0}function St(e){const t=l(),r=Oe();Ue(r,e.positions);const n=v(e.positions,r,t),o=e.primitive!==Pe&&e.primitive!==Le&&e.primitive!==Ee||!e.indices?null:function(e,t,r,n){!function(e,t){const r={};let n,o,i,s;const a=Math.pow(10,4);let c,l,u=0;for(c=0,l=e.length;c<l;c+=3)n=e[c],o=e[c+1],i=e[c+2],s=Math.round(n*a)+"_"+Math.round(o*a)+"_"+Math.round(i*a),void 0===r[s]&&(r[s]=u/3,tt[u++]=n,tt[u++]=o,tt[u++]=i),rt[c/3]=r[s];for(c=0,l=t.length;c<l;c++)ot[c]=rt[t[c]],nt[ot[c]]=t[c]}(e,t),function(e,t){st=0;for(let r=0,n=e;r<n;r+=3){const e=3*ot[r],n=3*ot[r+1],o=3*ot[r+2];t?(at[0]=tt[e],at[1]=tt[e+1],at[2]=tt[e+2],ct[0]=tt[n],ct[1]=tt[n+1],ct[2]=tt[n+2],lt[0]=tt[o],lt[1]=tt[o+1],lt[2]=tt[o+2],w(at,t,ut),w(ct,t,dt),w(lt,t,ht)):(ut[0]=tt[e],ut[1]=tt[e+1],ut[2]=tt[e+2],dt[0]=tt[n],dt[1]=tt[n+1],dt[2]=tt[n+2],ht[0]=tt[o],ht[1]=tt[o+1],ht[2]=tt[o+2]),u(ht,dt,ft),u(ut,dt,gt),m(ft,gt,pt),y(pt,mt);const i=it[st]||(it[st]={normal:c()});i.normal[0]=mt[0],i.normal[1]=mt[1],i.normal[2]=mt[2],st++}}(t.length,r);const o=[],i=Math.cos(10*s),a={};let l,d,h,f,g,b,v,x,S,T,M,k=!1;for(let e=0,r=t.length;e<r;e+=3){const t=e/3;for(let r=0;r<3;r++)l=ot[e+r],d=ot[e+(r+1)%3],h=Math.min(l,d),f=Math.max(l,d),g=h+","+f,void 0===a[g]?a[g]={index1:h,index2:f,face1:t,face2:void 0}:a[g].face2=t}for(g in a)b=a[g],void 0!==b.face2&&(v=it[b.face1].normal,x=it[b.face2].normal,S=p(v,x),S>i)||(T=nt[b.index1],M=nt[b.index2],(!k&&T>65535||M>65535)&&(k=!0),o.push(T),o.push(M));return k?new Uint32Array(o):new Uint16Array(o)}(n,e.indices,t);let i,a,d;[i,a,d]=function(e){let t=e.positionsCompressed,r=e.indices,n=e.edgeIndices;!function(e){if(!(null!==bt&&bt.length>=e)){bt=new Uint32Array(e);for(let t=0;t<e;t++)bt[t]=t}}(t.length/3);let o=bt.slice(0,t.length/3),i=bt.slice(0,t.length/3);yt=t,o.sort(wt);let s=0;i[o[0]]=0;for(let e=1,t=o.length;e<t;e++)0!=wt(o[e],o[e-1])&&s++,i[o[e]]=s;const a=new Uint16Array(3*(s+1));s=0,a[3*s+0]=t[3*o[0]+0],a[3*s+1]=t[3*o[0]+1],a[3*s+2]=t[3*o[0]+2];for(let e=1,r=o.length;e<r;e++)0!==wt(o[e],o[e-1])&&(s++,a[3*s+0]=t[3*o[e]+0],a[3*s+1]=t[3*o[e]+1],a[3*s+2]=t[3*o[e]+2]),i[o[e]]=s;yt=null;let c,l=new Uint32Array(r.length);for(let e=0,t=r.length;e<t;e++)l[e]=i[r[e]];if(n){c=new Uint32Array(n.length);for(let e=0,t=n.length;e<t;e++)c[e]=i[n[e]]}return[a,l,c]}({positionsCompressed:n,uvs:e.uvs,indices:e.indices,edgeIndices:o});const h=function(e,t,r=!1){const n=e.positionsCompressed||[],o=function(e,t){let r=new Int32Array(e.length/3);for(let e=0,t=r.length;e<t;e++)r[e]=e;vt=new Int32Array(e.length);for(let r=0,n=e.length;r<n;r++)vt[r]=e[r]>>t;r.sort(xt);const n=new Int32Array(e.length);for(let t=0,o=r.length;t<o;t++)n[3*t+0]=e[3*r[t]+0],n[3*t+1]=e[3*r[t]+1],n[3*t+2]=e[3*r[t]+2];return n}(e.indices||[],t),i=[];function s(e,t){if(e>t){let r=e;e=t,t=r}function r(r,n){return r!=e?e-r:n!=t?t-n:0}for(var n=0,o=(i.length>>1)-1;n<=o;){var s=o+n>>1,a=r(i[2*s],i[2*s+1]);if(a>0)n=s+1;else{if(!(a<0))return s;o=s-1}}return-n-1}const a=new Int32Array(i.length/2);a.fill(0);const c=n.length/3;if(c>8*(1<<t))return[e];const l=new Int32Array(c);l.fill(-1);const u=[];function d(){l.fill(-1);let e={positionsCompressed:[],indices:[],edgeIndices:[],maxNumPositions:(1<<t)-t,numPositions:0,bucketNumber:u.length};return u.push(e),e}let h=d();for(let t=0,r=o.length;t<r;t+=3){let r=0;const c=o[t],u=o[t+1],f=o[t+2];if(-1==l[c]&&r++,-1==l[u]&&r++,-1==l[f]&&r++,r+h.numPositions>h.maxNumPositions&&(h=d()),h.bucketNumber>8)return[e];let g;-1==l[c]&&(l[c]=h.numPositions++,h.positionsCompressed.push(n[3*c]),h.positionsCompressed.push(n[3*c+1]),h.positionsCompressed.push(n[3*c+2])),-1==l[u]&&(l[u]=h.numPositions++,h.positionsCompressed.push(n[3*u]),h.positionsCompressed.push(n[3*u+1]),h.positionsCompressed.push(n[3*u+2])),-1==l[f]&&(l[f]=h.numPositions++,h.positionsCompressed.push(n[3*f]),h.positionsCompressed.push(n[3*f+1]),h.positionsCompressed.push(n[3*f+2])),h.indices.push(l[c]),h.indices.push(l[u]),h.indices.push(l[f]),(g=s(c,u))>=0&&0==a[g]&&(a[g]=1,h.edgeIndices.push(l[i[2*g]]),h.edgeIndices.push(l[i[2*g+1]])),(g=s(c,f))>=0&&0==a[g]&&(a[g]=1,h.edgeIndices.push(l[i[2*g]]),h.edgeIndices.push(l[i[2*g+1]])),(g=s(u,f))>=0&&0==a[g]&&(a[g]=1,h.edgeIndices.push(l[i[2*g]]),h.edgeIndices.push(l[i[2*g+1]]))}const f=t/8,g=2*n.length+(o.length+i.length)*(t/8*2);let p=0;return u.forEach(e=>{p+=2*e.positionsCompressed.length+(e.indices.length+e.edgeIndices.length)*f}),p>g?[e]:(r&&function(e,t){const r={};e.forEach(e=>{let t=e.indices,n=e.edgeIndices,o=e.positionsCompressed;for(var i=0,s=t.length;i<s;i+=3)r[o[3*t[i]]+"_"+o[3*t[i]+1]+"_"+o[3*t[i]+2]+"/"+o[3*t[i+1]]+"_"+o[3*t[i+1]+1]+"_"+o[3*t[i+1]+2]+"/"+o[3*t[i+2]]+"_"+o[3*t[i+2]+1]+"_"+o[3*t[i+2]+2]]=!0;for(i=0,s=n.length;i<s;i+=2);});{let e=t.indices,s=t.positionsCompressed;for(var n=0,o=e.length;n<o;n+=3){var i=s[3*e[n]]+"_"+s[3*e[n]+1]+"_"+s[3*e[n]+2]+"/"+s[3*e[n+1]]+"_"+s[3*e[n+1]+1]+"_"+s[3*e[n+1]+2]+"/"+s[3*e[n+2]]+"_"+s[3*e[n+2]+1]+"_"+s[3*e[n+2]+2];if(!(i in r))throw console.log("Not found "+i),"Ohhhh!"}}}(u,e),u)}({positionsCompressed:i,indices:a,edgeIndices:d},i.length/3>65536?16:8);return{id:e.id,primitive:e.primitive===Pe&&h.length>1?Ee:e.primitive,aabb:r,positionsDecompressMatrix:t,uvsDecompressMatrix:void 0,geometryBuckets:h}}const Tt=e=>"function"==typeof e,Mt=e=>null!==e&&"object"==typeof e,kt=e=>Mt(e)&&e.constructor==={}.constructor,_t=e=>e&&"function"==typeof e[Symbol.iterator],At=e=>e&&"function"==typeof e[Symbol.asyncIterator],Bt=e=>"undefined"!=typeof Response&&e instanceof Response||e&&e.arrayBuffer&&e.text&&e.json,It=e=>"undefined"!=typeof Blob&&e instanceof Blob,jt=e=>e&&"object"==typeof e&&e.isBuffer,Ct=e=>(e=>"undefined"!=typeof ReadableStream&&e instanceof ReadableStream||Mt(e)&&Tt(e.tee)&&Tt(e.cancel)&&Tt(e.getReader))(e)||(e=>Mt(e)&&Tt(e.read)&&Tt(e.pipe)&&(e=>"boolean"==typeof e)(e.readable))(e),Et=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,Pt=/^([-\w.]+\/[-\w.+]+)/;function Lt(e){const t=Pt.exec(e);return t?t[1]:e}function Ft(e){const t=Et.exec(e);return t?t[1]:""}const Ot=/\?.*/;function Ut(e){if(Bt(e)){const t=Rt(e.url||"");return{url:t,type:Lt(e.headers.get("content-type")||"")||Ft(t)}}return It(e)?{url:Rt(e.name||""),type:e.type||""}:"string"==typeof e?{url:Rt(e),type:Ft(e)}:{url:"",type:""}}function Rt(e){return e.replace(Ot,"")}async function Dt(e){if(Bt(e))return e;const t={},r=function(e){return Bt(e)?e.headers["content-length"]||-1:It(e)?e.size:"string"==typeof e?e.length:e instanceof ArrayBuffer||ArrayBuffer.isView(e)?e.byteLength:-1}(e);r>=0&&(t["content-length"]=String(r));const{url:n,type:o}=Ut(e);o&&(t["content-type"]=o);const i=await async function(e){if("string"==typeof e)return"data:,".concat(e.slice(0,5));if(e instanceof Blob){const t=e.slice(0,5);return await new Promise(e=>{const r=new FileReader;r.onload=t=>{var r;return e(null==t||null===(r=t.target)||void 0===r?void 0:r.result)},r.readAsDataURL(t)})}if(e instanceof ArrayBuffer){const t=function(e){let t="";const r=new Uint8Array(e);for(let e=0;e<r.byteLength;e++)t+=String.fromCharCode(r[e]);return btoa(t)}(e.slice(0,5));return"data:base64,".concat(t)}return null}(e);i&&(t["x-first-bytes"]=i),"string"==typeof e&&(e=(new TextEncoder).encode(e));const s=new Response(e,{headers:t});return Object.defineProperty(s,"url",{value:n}),s}async function Gt(e,t){if("string"==typeof e){e=ie(e);let r=t;return null!=t&&t.fetch&&"function"!=typeof(null==t?void 0:t.fetch)&&(r=t.fetch),await fetch(e,r)}return await Dt(e)}function Wt(){return!("object"==typeof process&&"[object process]"===String(process)&&!process.browser)||function(e){if("undefined"!=typeof window&&"object"==typeof window.process&&"renderer"===window.process.type)return!0;if("undefined"!=typeof process&&"object"==typeof process.versions&&Boolean(process.versions.electron))return!0;const t="object"==typeof navigator&&"string"==typeof navigator.userAgent&&navigator.userAgent;return!!(t&&t.indexOf("Electron")>=0)}()}const Nt={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:"undefined"!=typeof global&&global,document:"undefined"!=typeof document&&document,process:"object"==typeof process&&process},$t=Nt.window||Nt.self||Nt.global,Ht=Nt.process||{},Vt="undefined"!=typeof __VERSION__?__VERSION__:"untranspiled source";Wt();class Qt{constructor(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"sessionStorage";P(this,"storage",void 0),P(this,"id",void 0),P(this,"config",void 0),this.storage=function(e){try{const t=window[e],r="__storage_test__";return t.setItem(r,r),t.removeItem(r),t}catch(e){return null}}(r),this.id=e,this.config=t,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){if(Object.assign(this.config,e),this.storage){const e=JSON.stringify(this.config);this.storage.setItem(this.id,e)}}_loadConfiguration(){let e={};if(this.storage){const t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}}function Jt(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:600;const o=e.src.replace(/\(/g,"%28").replace(/\)/g,"%29");e.width>n&&(r=Math.min(r,n/e.width));const i=e.width*r,s=e.height*r,a=["font-size:1px;","padding:".concat(Math.floor(s/2),"px ").concat(Math.floor(i/2),"px;"),"line-height:".concat(s,"px;"),"background:url(".concat(o,");"),"background-size:".concat(i,"px ").concat(s,"px;"),"color:transparent;"].join("");return["".concat(t," %c+"),a]}let zt;function qt(e){return"string"==typeof e?zt[e.toUpperCase()]||zt.WHITE:e}function Kt(e,t){if(!e)throw new Error(t||"Assertion failed")}function Yt(){let e;var t,r;if(Wt&&"performance"in $t)e=null==$t||null===(t=$t.performance)||void 0===t||null===(r=t.now)||void 0===r?void 0:r.call(t);else if("hrtime"in Ht){var n;const t=null==Ht||null===(n=Ht.hrtime)||void 0===n?void 0:n.call(Ht);e=1e3*t[0]+t[1]/1e6}else e=Date.now();return e}!function(e){e[e.BLACK=30]="BLACK",e[e.RED=31]="RED",e[e.GREEN=32]="GREEN",e[e.YELLOW=33]="YELLOW",e[e.BLUE=34]="BLUE",e[e.MAGENTA=35]="MAGENTA",e[e.CYAN=36]="CYAN",e[e.WHITE=37]="WHITE",e[e.BRIGHT_BLACK=90]="BRIGHT_BLACK",e[e.BRIGHT_RED=91]="BRIGHT_RED",e[e.BRIGHT_GREEN=92]="BRIGHT_GREEN",e[e.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",e[e.BRIGHT_BLUE=94]="BRIGHT_BLUE",e[e.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",e[e.BRIGHT_CYAN=96]="BRIGHT_CYAN",e[e.BRIGHT_WHITE=97]="BRIGHT_WHITE"}(zt||(zt={}));const Xt={debug:Wt&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},Zt={enabled:!0,level:0};function er(){}const tr={},rr={once:!0};class nr{constructor(){let{id:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{id:""};P(this,"id",void 0),P(this,"VERSION",Vt),P(this,"_startTs",Yt()),P(this,"_deltaTs",Yt()),P(this,"_storage",void 0),P(this,"userData",{}),P(this,"LOG_THROTTLE_TIMEOUT",0),this.id=e,this.userData={},this._storage=new Qt("__probe-".concat(this.id,"__"),Zt),this.timeStamp("".concat(this.id," started")),function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:["constructor"];const r=Object.getPrototypeOf(e),n=Object.getOwnPropertyNames(r);for(const r of n)"function"==typeof e[r]&&(t.find(e=>r===e)||(e[r]=e[r].bind(e)))}(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((Yt()-this._startTs).toPrecision(10))}getDelta(){return Number((Yt()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(){return this._storage.setConfiguration({enabled:!(arguments.length>0&&void 0!==arguments[0])||arguments[0]}),this}setLevel(e){return this._storage.setConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.setConfiguration({[e]:t})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,t){Kt(e,t)}warn(e){return this._getLogFunction(0,e,Xt.warn,arguments,rr)}error(e){return this._getLogFunction(0,e,Xt.error,arguments)}deprecated(e,t){return this.warn("`".concat(e,"` is deprecated and will be removed in a later version. Use `").concat(t,"` instead"))}removed(e,t){return this.error("`".concat(e,"` has been removed. Use `").concat(t,"` instead"))}probe(e,t){return this._getLogFunction(e,t,Xt.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,Xt.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){for(var r=arguments.length,n=new Array(r>2?r-2:0),o=2;o<r;o++)n[o-2]=arguments[o];return this._getLogFunction(e,t,Xt.debug||Xt.info,arguments,rr)}table(e,t,r){return t?this._getLogFunction(e,t,console.table||er,r&&[r],{tag:sr(t)}):er}image(e){let{logLevel:t,priority:r,image:n,message:o="",scale:i=1}=e;return this._shouldLog(t||r)?Wt?function(e){let{image:t,message:r="",scale:n=1}=e;if("string"==typeof t){const e=new Image;return e.onload=()=>{const t=Jt(e,r,n);console.log(...t)},e.src=t,er}const o=t.nodeName||"";if("img"===o.toLowerCase())return console.log(...Jt(t,r,n)),er;if("canvas"===o.toLowerCase()){const e=new Image;return e.onload=()=>console.log(...Jt(e,r,n)),e.src=t.toDataURL(),er}return er}({image:n,message:o,scale:i}):(console.warn("removed"),er):er}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||er)}group(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{collapsed:!1};const n=ir({logLevel:e,message:t,opts:r}),{collapsed:o}=r;return n.method=(o?console.groupCollapsed:console.group)||console.info,this._getLogFunction(n)}groupCollapsed(e,t){return this.group(e,t,Object.assign({},arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||er)}withGroup(e,t,r){this.group(e,t)();try{r()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=or(e)}_getLogFunction(e,t,r,n,o){if(this._shouldLog(e)){o=ir({logLevel:e,message:t,args:n,opts:o}),Kt(r=r||o.method),o.total=this.getTotal(),o.delta=this.getDelta(),this._deltaTs=Yt();const i=o.tag||o.message;if(o.once){if(tr[i])return er;tr[i]=Yt()}return t=function(e,t,r){if("string"==typeof t){const s=r.time?function(e){const t=Math.max((arguments.length>1&&void 0!==arguments[1]?arguments[1]:8)-e.length,0);return"".concat(" ".repeat(t)).concat(e)}(function(e){let t;return t=e<10?"".concat(e.toFixed(2),"ms"):e<100?"".concat(e.toFixed(1),"ms"):e<1e3?"".concat(e.toFixed(0),"ms"):"".concat((e/1e3).toFixed(2),"s"),t}(r.total)):"";n=t=r.time?"".concat(e,": ").concat(s,"  ").concat(t):"".concat(e,": ").concat(t),o=r.color,i=r.background,Wt||"string"!=typeof n||(o&&(o=qt(o),n="[".concat(o,"m").concat(n,"[39m")),i&&(o=qt(i),n="[".concat(i+10,"m").concat(n,"[49m"))),t=n}var n,o,i;return t}(this.id,o.message,o),r.bind(console,t,...o.args)}return er}}function or(e){if(!e)return 0;let t;switch(typeof e){case"number":t=e;break;case"object":t=e.logLevel||e.priority||0;break;default:return 0}return Kt(Number.isFinite(t)&&t>=0),t}function ir(e){const{logLevel:t,message:r}=e;e.logLevel=or(t);const n=e.args?Array.from(e.args):[];for(;n.length&&n.shift()!==r;);switch(typeof t){case"string":case"function":void 0!==r&&n.unshift(r),e.message=t;break;case"object":Object.assign(e,t)}"function"==typeof e.message&&(e.message=e.message());const o=typeof e.message;return Kt("string"===o||"object"===o),Object.assign(e,{args:n},e.opts)}function sr(e){for(const t in e)for(const r in e[t])return r||"untitled";return"empty"}P(nr,"VERSION",Vt);const ar=new nr({id:"loaders.gl"});class cr{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}const lr={fetch:null,mimeType:void 0,nothrow:!1,log:new class{constructor(){P(this,"console",void 0),this.console=console}log(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return this.console.log.bind(this.console,...t)}info(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return this.console.info.bind(this.console,...t)}warn(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return this.console.warn.bind(this.console,...t)}error(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return this.console.error.bind(this.console,...t)}},CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:k,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},ur={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function dr(){globalThis.loaders=globalThis.loaders||{};const{loaders:e}=globalThis;return e._state=e._state||{},e._state}const hr=()=>{const e=dr();return e.globalOptions=e.globalOptions||{...lr},e.globalOptions};function fr(e,t){const r=hr(),n=e||r;return"function"==typeof n.fetch?n.fetch:Mt(n.fetch)?e=>Gt(e,n):null!=t&&t.fetch?null==t?void 0:t.fetch:Gt}function gr(e,t,r,n,o){const i=t||"Top level",s=t?"".concat(t,"."):"";for(const a in e){const c=!t&&Mt(e[a]);if(!(a in r)&&("baseUri"!==a||t)&&("workerUrl"!==a||!t))if(a in n)ar.warn("".concat(i," loader option '").concat(s).concat(a,"' no longer supported, use '").concat(n[a],"'"))();else if(!c){const e=pr(a,o);ar.warn("".concat(i," loader option '").concat(s).concat(a,"' not recognized. ").concat(e))()}}}function pr(e,t){const r=e.toLowerCase();let n="";for(const o of t)for(const t in o.options){if(e===t)return"Did you mean '".concat(o.id,".").concat(t,"'?");const i=t.toLowerCase();(r.startsWith(i)||i.startsWith(r))&&(n=n||"Did you mean '".concat(o.id,".").concat(t,"'?"))}return n}function mr(e,t){for(const r in t)r in t&&(e[r]=kt(t[r])&&kt(e[r])?{...e[r],...t[r]}:t[r])}function yr(e){var t;return!!e&&(Array.isArray(e)&&(e=e[0]),Array.isArray(null===(t=e)||void 0===t?void 0:t.extensions))}function wr(e){var t,r;let n;return M(e,"null loader"),M(yr(e),"invalid loader"),Array.isArray(e)&&(n=e[1],e=e[0],e={...e,options:{...e.options,...n}}),(null!==(t=e)&&void 0!==t&&t.parseTextSync||null!==(r=e)&&void 0!==r&&r.parseText)&&(e.text=!0),e.text||(e.binary=!0),e}const br=()=>{const e=dr();return e.loaderRegistry=e.loaderRegistry||[],e.loaderRegistry},vr=new nr({id:"loaders.gl"}),xr=/\.([^.]+)$/;function Sr(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0;if(!Tr(e))return null;if(t&&!Array.isArray(t))return wr(t);let o=[];t&&(o=o.concat(t)),null!=r&&r.ignoreRegisteredLoaders||o.push(...br()),function(e){for(const t of e)wr(t)}(o);const i=function(e,t,r,n){const{url:o,type:i}=Ut(e),s=o||(null==n?void 0:n.url);let a=null,c="";var l;return null!=r&&r.mimeType&&(a=kr(t,null==r?void 0:r.mimeType),c="match forced by supplied MIME type ".concat(null==r?void 0:r.mimeType)),a=a||function(e,t){const r=t&&xr.exec(t),n=r&&r[1];return n?function(e,t){t=t.toLowerCase();for(const r of e)for(const e of r.extensions)if(e.toLowerCase()===t)return r;return null}(e,n):null}(t,s),c=c||(a?"matched url ".concat(s):""),a=a||kr(t,i),c=c||(a?"matched MIME type ".concat(i):""),a=a||function(e,t){if(!t)return null;for(const r of e)if("string"==typeof t){if(_r(t,r))return r}else if(ArrayBuffer.isView(t)){if(Ar(t.buffer,t.byteOffset,r))return r}else if(t instanceof ArrayBuffer&&Ar(t,0,r))return r;return null}(t,e),c=c||(a?"matched initial data ".concat(Br(e)):""),a=a||kr(t,null==r?void 0:r.fallbackMimeType),c=c||(a?"matched fallback MIME type ".concat(i):""),c&&vr.log(1,"selectLoader selected ".concat(null===(l=a)||void 0===l?void 0:l.name,": ").concat(c,".")),a}(e,o,r,n);if(!(i||null!=r&&r.nothrow))throw new Error(Mr(e));return i}function Tr(e){return!(e instanceof Response&&204===e.status)}function Mr(e){const{url:t,type:r}=Ut(e);let n="No valid loader found (";n+=t?"".concat(function(e){const t=e&&e.lastIndexOf("/");return t>=0?e.substr(t+1):""}(t),", "):"no url provided, ",n+="MIME type: ".concat(r?'"'.concat(r,'"'):"not provided",", ");const o=e?Br(e):"";return n+=o?' first bytes: "'.concat(o,'"'):"first bytes: not available",n+=")",n}function kr(e,t){for(const r of e){if(r.mimeTypes&&r.mimeTypes.includes(t))return r;if(t==="application/x.".concat(r.id))return r}return null}function _r(e,t){return t.testText?t.testText(e):(Array.isArray(t.tests)?t.tests:[t.tests]).some(t=>e.startsWith(t))}function Ar(e,t,r){return(Array.isArray(r.tests)?r.tests:[r.tests]).some(n=>function(e,t,r,n){if(n instanceof ArrayBuffer)return function(e,t,r){if(e.byteLength<(r=r||e.byteLength)||t.byteLength<r)return!1;const n=new Uint8Array(e),o=new Uint8Array(t);for(let e=0;e<n.length;++e)if(n[e]!==o[e])return!1;return!0}(n,e,n.byteLength);switch(typeof n){case"function":return n(e,r);case"string":return n===Ir(e,t,n.length);default:return!1}}(e,t,r,n))}function Br(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;return"string"==typeof e?e.slice(0,t):ArrayBuffer.isView(e)?Ir(e.buffer,e.byteOffset,t):e instanceof ArrayBuffer?Ir(e,0,t):""}function Ir(e,t,r){if(e.byteLength<t+r)return"";const n=new DataView(e);let o="";for(let e=0;e<r;e++)o+=String.fromCharCode(n.getUint8(t+e));return o}const jr=262144,Cr=262144,Er=1048576;function Pr(e,t){return k?async function*(e,t){const r=e.getReader();let n;try{for(;;){const e=n||r.read();null!=t&&t._streamReadAhead&&(n=r.read());const{done:o,value:i}=await e;if(o)return;yield se(i)}}catch(e){r.releaseLock()}}(e,t):async function*(e,t){for await(const t of e)yield se(t)}(e)}const Lr="Cannot convert supplied data type";async function Fr(e,t,r,n){_(!n||"object"==typeof n),!t||Array.isArray(t)||yr(t)||(n=void 0,r=t,t=void 0),e=await e,r=r||{};const{url:o}=Ut(e),i=function(e,t){if(!t&&e&&!Array.isArray(e))return e;let r;if(e&&(r=Array.isArray(e)?e:[e]),t&&t.loaders){const e=Array.isArray(t.loaders)?t.loaders:[t.loaders];r=r?[...r,...e]:e}return r&&r.length?r:null}(t,n),s=await async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0;if(!Tr(e))return null;let o=Sr(e,t,{...r,nothrow:!0},n);if(o)return o;if(It(e)&&(o=Sr(e=await e.slice(0,10).arrayBuffer(),t,r,n)),!(o||null!=r&&r.nothrow))throw new Error(Mr(e));return o}(e,i,r);return s?(n=function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(r)return r;const n={fetch:fr(t,e),...e};return Array.isArray(n.loaders)||(n.loaders=null),n}({url:o,parse:Fr,loaders:i},r=function(e,t,r,n){return r=r||[],function(e,t){gr(e,null,lr,ur,t);for(const r of t)gr(e&&e[r.id]||{},r.id,r.options&&r.options[r.id]||{},r.deprecatedOptions&&r.deprecatedOptions[r.id]||{},t)}(e,r=Array.isArray(r)?r:[r]),function(e,t,r){const n={...e.options||{}};return function(e,t){t&&!("baseUri"in e)&&(e.baseUri=t)}(n,r),null===n.log&&(n.log=new cr),mr(n,hr()),mr(n,t),n}(t,e,n)}(r,s,i,o),n),await async function(e,t,r,n){if(_(e,"no worker provided"),Bt(t)){const e=t,{ok:r,redirected:o,status:i,statusText:s,type:a,url:c}=e,l=Object.fromEntries(e.headers.entries());n.response={headers:l,ok:r,redirected:o,status:i,statusText:s,type:a,url:c}}if(t=await async function(e,t,r){const n=e instanceof ArrayBuffer||ArrayBuffer.isView(e);if("string"==typeof e||n)return function(e,t,r){if(t.text&&"string"==typeof e)return e;if(jt(e)&&(e=e.buffer),e instanceof ArrayBuffer){const r=e;return t.text&&!t.binary?new TextDecoder("utf8").decode(r):r}if(ArrayBuffer.isView(e)){if(t.text&&!t.binary)return new TextDecoder("utf8").decode(e);let r=e.buffer;const n=e.byteLength||e.length;return 0===e.byteOffset&&n===r.byteLength||(r=r.slice(e.byteOffset,e.byteOffset+n)),r}throw new Error(Lr)}(e,t);if(It(e)&&(e=await Dt(e)),Bt(e)){const r=e;return await async function(e){if(!e.ok){const t=await async function(e){let t="Failed to fetch resource ".concat(e.url," (").concat(e.status,"): ");try{const r=e.headers.get("Content-Type");let n=e.statusText;r.includes("application/json")&&(n+=" ".concat(await e.text())),t+=n,t=t.length>60?"".concat(t.slice(0,60),"..."):t}catch(e){}return t}(e);throw new Error(t)}}(r),t.binary?await r.arrayBuffer():await r.text()}if(Ct(e)&&(e=function(e,t){if("string"==typeof e)return function*(e,t){const r=(null==t?void 0:t.chunkSize)||jr;let n=0;const o=new TextEncoder;for(;n<e.length;){const t=Math.min(e.length-n,r),i=e.slice(n,n+t);n+=t,yield o.encode(i)}}(e,t);if(e instanceof ArrayBuffer)return function*(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{chunkSize:r=Cr}=t;let n=0;for(;n<e.byteLength;){const t=Math.min(e.byteLength-n,r),o=new ArrayBuffer(t),i=new Uint8Array(e,n,t);new Uint8Array(o).set(i),n+=t,yield o}}(e,t);if(It(e))return async function*(e,t){const r=(null==t?void 0:t.chunkSize)||Er;let n=0;for(;n<e.size;){const t=n+r,o=await e.slice(n,t).arrayBuffer();n=t,yield o}}(e,t);if(Ct(e))return Pr(e,t);if(Bt(e))return Pr(e.body,t);throw new Error("makeIterator")}(e,r)),_t(e)||At(e))return async function(e){const t=[];for await(const r of e)t.push(r);return re(...t)}(e);throw new Error(Lr)}(t,e,r),e.parseTextSync&&"string"==typeof t)return r.dataType="text",e.parseTextSync(t,r,n,e);if(function(e,t){return!!V.isSupported()&&!!(I||null!=t&&t._nodeWorkers)&&e.worker&&(null==t?void 0:t.worker)}(e,r))return await ee(e,t,r,n,Fr);if(e.parseText&&"string"==typeof t)return await e.parseText(t,r,n,e);if(e.parse)return await e.parse(t,r,n,e);throw _(!e.parseSync),new Error("".concat(e.id," loader - no parser found and worker is disabled"))}(s,e,r,n)):null}async function Or(e,t,r,n){Array.isArray(t)||yr(t)||(r=t,t=void 0);const o=fr(r);let i=e;return"string"==typeof e&&(i=await o(e)),It(e)&&(i=await o(e)),await Fr(i,t,r)}async function Ur(e,t,r){if(function(e,t){return!!V.isSupported()&&!!(k||null!=t&&t._nodeWorkers)&&e.worker&&(null==t?void 0:t.worker)}(t,r={...hr(),...r}))return await q(t,e,r);if(t.encode)return await t.encode(e,r);if(t.encodeSync)return t.encodeSync(e,r);if(t.encodeText)return(new TextEncoder).encode(await t.encodeText(e,r));if(t.encodeInBatches){const n=function(e,t,r){if(t.encodeInBatches){const n=function(e){return[{table:e,start:0,end:e.length}]}(e);return t.encodeInBatches(n,r)}throw new Error("Writer could not encode data in batches")}(e,t,r),o=[];for await(const e of n)o.push(e);return re(...o)}if(!k&&t.encodeURLtoURL){const n=Rr("input");await async function(e,t,r){e=ie(e),k||await(void 0)(e,t,{flag:"w"}),M(!1)}(n,e);const o=Rr("output"),i=await async function(e,t,r,n){if(e=ie(e),t=ie(t),k||!r.encodeURLtoURL)throw new Error;return await r.encodeURLtoURL(e,t,n)}(n,o,t,r);return(await Gt(i)).arrayBuffer()}throw new Error("Writer could not encode data")}function Rr(e){return"/tmp/".concat(e)}const Dr={0:{useSRGB:!0,qualityLevel:50,encodeUASTC:!0,mipmaps:!0},3:{useSRGB:!0,encodeUASTC:!0,qualityLevel:10,mipmaps:!1},1:{useSRGB:!1,encodeUASTC:!0,qualityLevel:50,mipmaps:!0},2:{useSRGB:!1,encodeUASTC:!0,qualityLevel:10,mipmaps:!1},4:{useSRGB:!1,encodeUASTC:!0,qualityLevel:10,mipmaps:!1}};var Gr=/*#__PURE__*/S("texturesList"),Wr=/*#__PURE__*/S("numObjects"),Nr=/*#__PURE__*/S("meshUsedByObject"),$r=/*#__PURE__*/S("removeUnusedTextures"),Hr=/*#__PURE__*/S("compressTextures");class Vr extends e{constructor(e,r){super(e,{id:r.id}),Object.defineProperty(this,Hr,{value:Jr}),Object.defineProperty(this,$r,{value:Qr}),this.scene=void 0,this.layerId=void 0,this.built=void 0,this.edgeThreshold=void 0,this.geometries=void 0,this.textures=void 0,this.textureSets=void 0,this.meshes=void 0,this.objects=void 0,this.aabb=void 0,this.onBuilt=void 0,this.rendererModel=void 0,Object.defineProperty(this,Gr,{writable:!0,value:void 0}),Object.defineProperty(this,Wr,{writable:!0,value:void 0}),Object.defineProperty(this,Nr,{writable:!0,value:void 0}),this.scene=e,this.onBuilt=new t(new a),this.onDestroyed=new t(new a),T(this,Wr)[Wr]=0,T(this,Nr)[Nr]={},this.id=r.id||"default",this.layerId=r.layerId,this.edgeThreshold=10,this.geometries={},this.textures={},T(this,Gr)[Gr]=[],this.textureSets={},this.meshes={},this.objects={},this.aabb=Fe(),this.built=!1,this.rendererModel=null,this.fromJSON(r)}fromJSON(e){if(this.destroyed)return new r("Failed to add components to SceneModel - SceneModel already destroyed");if(this.built)return new r("Failed to add components to SceneModel - SceneModel already built");if(e.geometries)for(let t=0,r=e.geometries.length;t<r;t++)this.createGeometry(e.geometries[t]);if(e.textures)for(let t=0,r=e.textures.length;t<r;t++)this.createTexture(e.textures[t]);if(e.textureSets)for(let t=0,r=e.textureSets.length;t<r;t++)this.createTextureSet(e.textureSets[t]);if(e.meshes)for(let t=0,r=e.meshes.length;t<r;t++)this.createMesh(e.meshes[t]);if(e.objects)for(let t=0,r=e.objects.length;t<r;t++)this.createObject(e.objects[t])}createTransform(e){return this.destroyed?new r("Failed to create Transform in SceneModel - SceneModel already destroyed"):this.built?new r("Failed to create Transform in SceneModel - SceneModel already built"):void 0}createTexture(e){if(this.destroyed)return new r("Failed to create Texture in SceneModel - SceneModel already destroyed");if(this.built)return new r("Failed to create Texture in SceneModel - SceneModel already built");if(!e.imageData&&!e.src&&!e.buffers)return new r("Failed to create Texture in SceneModel - Parameter expected: textureParams.imageData, textureParams.src or textureParams.buffers");if(this.textures[e.id])return new r(`Failed to create Texture in SceneModel - Texture already exists with this ID: ${e.id}`);e.src&&e.src.split(".").pop();const t=new ze(e);return this.textures[e.id]=t,T(this,Gr)[Gr].push(t),t}createTextureSet(e){if(this.destroyed)return new r("Failed to create TextureSet in SceneModel - SceneModel already destroyed");if(this.built)return new r("Failed to create TextureSet in SceneModel - SceneModel already built");if(this.textureSets[e.id])return new r(`Failed to create TextureSet in SceneModel - TextureSet already exists with this ID: ${e.id}`);let t,n,o,i,s;if(null!=e.colorTextureId){if(t=this.textures[e.colorTextureId],!t)return new r(`Failed to create TextureSet in SceneModel - Texture not found: ${e.colorTextureId} - ensure that you create it first with createTexture()`);t.channel=0}if(null!=e.metallicRoughnessTextureId){if(n=this.textures[e.metallicRoughnessTextureId],!n)return new r(`Failed to create TextureSet in SceneModel - Texture not found: ${e.metallicRoughnessTextureId} - ensure that you create it first with createTexture()`);n.channel=1}if(null!=e.normalsTextureId){if(o=this.textures[e.normalsTextureId],!o)return new r(`Failed to create TextureSet in SceneModel - Texture not found: ${e.normalsTextureId} - ensure that you create it first with createTexture()`);o.channel=2}if(null!=e.emissiveTextureId){if(i=this.textures[e.emissiveTextureId],!i)return new r(`Failed to create TextureSet in SceneModel - Texture not found: ${e.emissiveTextureId} - ensure that you create it first with createTexture()`);i.channel=3}if(null!=e.occlusionTextureId){if(s=this.textures[e.occlusionTextureId],!s)return new r(`Failed to create TextureSet in SceneModel - Texture not found: ${e.occlusionTextureId} - ensure that you create it first with createTexture()`);s.channel=4}const a=new Je(e,{emissiveTexture:i,occlusionTexture:s,metallicRoughnessTexture:n,colorTexture:t});return this.textureSets[e.id]=a,a}createGeometry(e){if(this.destroyed)return new r("Failed to create Geometry in SceneModel - SceneModel already destroyed");if(this.built)return new r("Failed to create Geometry in SceneModel - SceneModel already built");if(!e)return new r("Failed to create Geometry in SceneModel - Parameters expected: geometryParams");if(null==e.id)return new r("Failed to create Geometry in SceneModel - Parameter expected: geometryParams.id");const t=e.id;if(this.geometries[t])return new r(`Failed to create Geometry in SceneModel - Geometry with this ID already created: ${t}`);const n=e.primitive;if(n!==je&&n!==Ce&&n!==Ee&&n!==Pe&&n!==Le)return new r(`Failed to create Geometry in SceneModel - Unsupported value for geometryParams.primitive: '${n}' - supported values are PointsPrimitive, LinesPrimitive, TrianglesPrimitive, SolidPrimitive and SurfacePrimitive`);if(!e.positions)return new r("Failed to create Geometry in SceneModel - Param expected: geometryParams.positions");if(!e.indices&&n!==je)return new r("Failed to create Geometry in SceneModel - Param expected: geometryParams.indices (required for primitive type)");if(e.uvs&&e.uvs.length/2!=e.positions.length/3)return new r("Failed to create Geometry in SceneModel - mismatch between given quantities of vertex positions and UVs");if(e.indices){const t=e.positions.length/3;for(let n=0,o=e.indices.length;n<o;n++){const o=e.indices[n];if(o<0||o>=t)return new r("Failed to create Geometry in SceneModel - indices out of range of vertex positions");if(e.uvs&&(o<0||o>=e.uvs.length/2))return new r("Failed to create Geometry in SceneModel - indices out of range of vertex UVs")}}const o=new De(St(e));return this.geometries[t]=o,o}createGeometryCompressed(e){if(this.destroyed)return new r("Failed to add compressed Geometry to SceneModel - SceneModel already destroyed");if(this.built)return new r("Failed to add compressed Geometry to SceneModel - SceneModel already built");if(!e)return new r("Failed to add compressed Geometry to SceneModel - Parameters expected: geometryCompressedParams");const t=e.id;if(this.geometries[t])return new r(`Failed to add compressed Geometry to SceneModel - Geometry with this ID already created: ${t}`);const n=e.primitive;if(n!==je&&n!==Ce&&n!==Ee&&n!==Pe&&n!==Le)return new r(`Failed to add compressed Geometry to SceneModel - Unsupported value for geometryCompressedParams.primitive: '${n}' - supported values are PointsPrimitive, LinesPrimitive, TrianglesPrimitive, SolidPrimitive and SurfacePrimitive`);const o=new De(e);return this.geometries[t]=o,o}createMesh(e){if(this.destroyed)return new r("Failed to create Mesh in SceneModel - SceneModel already destroyed");if(this.built)return new r("Failed to create Mesh in SceneModel - SceneModel already built");if(this.meshes[e.id])return new r(`Failed to create Mesh in SceneModel - Mesh already exists with this ID: ${e.id}`);const t=this.geometries[e.geometryId];if(!t)return new r(`Failed to create Mesh in SceneModel - Geometry not found: ${e.geometryId}`);const n=e.textureSetId?this.textureSets[e.textureSetId]:void 0;if(e.textureSetId&&!n)return new r(`Failed to create Mesh in SceneModel - TextureSet not found: ${e.textureSetId}`);const o=new et({id:e.id,geometry:t,textureSet:n,matrix:e.matrix,color:e.color,opacity:e.opacity,roughness:e.roughness,metallic:e.metallic});return this.meshes[e.id]=o,o}createObject(e){if(this.destroyed)return new r("Failed to create SceneObject - SceneModel already destroyed");if(this.built)return new r("Failed to create SceneObject SceneModel already built");if(0===e.meshIds.length)return new r("Failed to create SceneObject - no meshes specified");if(this.scene.objects[e.id])return new r(`Failed to create SceneObject - SceneObject already exists in Scene: ${e.id}`);const t=e.meshIds,n=[];for(let e=0,o=t.length;e<o;e++){const o=t[e],i=this.meshes[o];if(!i)return new r(`Failed to create SceneObject - Mesh not found: ${o}`);if(T(this,Nr)[Nr][o])return new r(`Failed to create SceneObject - Mesh ${o} already belongs to another SceneObject`);n.push(i),T(this,Nr)[Nr][i.id]=!0}const o=new Qe({id:e.id,layerId:e.layerId||this.layerId,model:this,meshes:n});for(let e=0,t=n.length;e<t;e++)n[e].object=o;return T(this,Wr)[Wr]++,this.objects[e.id]=o,o}async build(){return new Promise(e=>{if(this.destroyed)throw new r("Failed to build SceneModel - SceneModel already destroyed");if(this.built)throw new r("Failed to build SceneModel - SceneModel already built");T(this,$r)[$r](),T(this,Hr)[Hr]().then(()=>{this.built=!0,this.onBuilt.dispatch(this,null),e(this)}).catch(e=>{throw e})})}}function Qr(){}function Jr(){let e=T(this,Gr)[Gr].length;return new Promise(t=>{if(0!==e)for(let n=0,o=T(this,Gr)[Gr].length;n<o;n++){const o=T(this,Gr)[Gr][n],i=Dr[o.channel]||{};if(o.src){const n=o.src;switch(n.split(".").pop()){case"jpeg":case"jpg":case"png":Or(n,Be,{image:{type:"data"}}).then(n=>{o.compressed?Ur(n,de,i).then(r=>{const n=new Uint8Array(r);o.imageData=n,--e<=0&&t()}).catch(e=>new r(`Failed to compress texture: ${e}`)):(o.imageData=new Uint8Array(1),--e<=0&&t())}).catch(e=>new r(`Failed to load texture image: ${e}`));break;default:--e<=0&&t()}}o.imageData&&(o.compressed?Ur(o.imageData,de,i).then(r=>{o.imageData=new Uint8Array(r),--e<=0&&t()}).catch(e=>new r(`Failed to compress texture: ${e}`)):(o.imageData=new Uint8Array(1),--e<=0&&t()))}else t()})}var zr=/*#__PURE__*/S("onModelBuilts"),qr=/*#__PURE__*/S("onModelDestroys"),Kr=/*#__PURE__*/S("center"),Yr=/*#__PURE__*/S("aabbDirty"),Xr=/*#__PURE__*/S("aabb"),Zr=/*#__PURE__*/S("registerObjects"),en=/*#__PURE__*/S("deregisterObjects");class tn extends e{constructor(){super(null,{}),Object.defineProperty(this,en,{value:nn}),Object.defineProperty(this,Zr,{value:rn}),this.models=void 0,this.objects=void 0,this.onModelCreated=void 0,this.onModelDestroyed=void 0,Object.defineProperty(this,zr,{writable:!0,value:void 0}),Object.defineProperty(this,qr,{writable:!0,value:void 0}),Object.defineProperty(this,Kr,{writable:!0,value:void 0}),Object.defineProperty(this,Yr,{writable:!0,value:void 0}),Object.defineProperty(this,Xr,{writable:!0,value:void 0}),T(this,Xr)[Xr]=Fe(),T(this,Yr)[Yr]=!0,this.models={},this.objects={},T(this,zr)[zr]={},T(this,qr)[qr]={},this.onModelCreated=new t(new a),this.onModelDestroyed=new t(new a)}get center(){if(T(this,Yr)[Yr]){const e=this.aabb;T(this,Kr)[Kr][0]=(e[0]+e[3])/2,T(this,Kr)[Kr][1]=(e[1]+e[4])/2,T(this,Kr)[Kr][2]=(e[2]+e[5])/2}return T(this,Kr)[Kr]}get aabb(){if(T(this,Yr)[Yr]){let e,t=o,r=o,n=o,s=i,a=i,c=i;const l=this.objects;let u=!1;for(const o in l)l.hasOwnProperty(o)&&(e=l[o].aabb,e[0]<t&&(t=e[0]),e[1]<r&&(r=e[1]),e[2]<n&&(n=e[2]),e[3]>s&&(s=e[3]),e[4]>a&&(a=e[4]),e[5]>c&&(c=e[5]),u=!0);u||(t=-100,r=-100,n=-100,s=100,a=100,c=100),T(this,Xr)[Xr][0]=t,T(this,Xr)[Xr][1]=r,T(this,Xr)[Xr][2]=n,T(this,Xr)[Xr][3]=s,T(this,Xr)[Xr][4]=a,T(this,Xr)[Xr][5]=c,T(this,Yr)[Yr]=!1}return T(this,Xr)[Xr]}createModel(e){if(this.destroyed)return new r("Scene already destroyed");const t=e.id;if(this.models[t])return new r(`SceneModel already created in this Scene: ${t}`);const n=new Vr(this,e);return this.models[t]=n,n.onDestroyed.one(()=>{delete this.models[n.id],T(this,en)[en](n),this.onModelDestroyed.dispatch(this,n)}),n.onBuilt.one(()=>{T(this,Zr)[Zr](n),this.onModelCreated.dispatch(this,n)}),n}setAABBDirty(){T(this,Yr)[Yr]||(T(this,Yr)[Yr]=!0)}clear(){if(this.destroyed)return new r("Scene already destroyed");for(let e in this.models)this.models[e].destroy()}destroy(){this.clear(),this.onModelCreated.clear(),this.onModelDestroyed.clear(),super.destroy()}}function rn(e){const t=e.objects;for(let e in t){const r=t[e];this.objects[r.id]=r}T(this,Yr)[Yr]=!0}function nn(e){const t=e.objects;for(let e in t)delete this.objects[t[e].id];T(this,Yr)[Yr]=!0}export{De as Geometry,Re as GeometryBucket,et as Mesh,tn as Scene,Vr as SceneModel,Qe as SceneObject,ze as Texture,Je as TextureSet,St as compressGeometryParams,$e as getSceneObjectGeometry};
//# sourceMappingURL=index.modern.mjs.map
