!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t||self).ktx2={})}(this,function(t){var e=0;function r(t){return"__private_"+e+++"_"+t}function o(t,e){if(!Object.prototype.hasOwnProperty.call(t,e))throw new TypeError("attempted to use private field on non-instance");return t}function i(t,e){return i=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},i(t,e)}var s=/*#__PURE__*/function(){function t(t,e,r){this.isLoading=void 0,this.itemsLoaded=void 0,this.itemsTotal=void 0,this.urlModifier=void 0,this.handlers=void 0,this.onStart=void 0,this.onLoad=void 0,this.onProgress=void 0,this.onError=void 0,this.isLoading=!1,this.itemsLoaded=0,this.itemsTotal=0,this.urlModifier=void 0,this.handlers=[],this.onStart=void 0,this.onLoad=t,this.onProgress=e,this.onError=r}var e=t.prototype;return e.itemStart=function(t){this.itemsTotal++,this.isLoading||void 0!==this.onStart&&this.onStart(t,this.itemsLoaded,this.itemsTotal),this.isLoading=!0},e.itemEnd=function(t){this.itemsLoaded++,void 0!==this.onProgress&&this.onProgress(t,this.itemsLoaded,this.itemsTotal),this.itemsLoaded===this.itemsTotal&&(this.isLoading=!1,void 0!==this.onLoad&&this.onLoad())},e.itemError=function(t){void 0!==this.onError&&this.onError(t)},e.resolveURL=function(t){return this.urlModifier?this.urlModifier(t):t},e.setURLModifier=function(t){return this.urlModifier=t,this},e.addHandler=function(t,e){return this.handlers.push(t,e),this},e.removeHandler=function(t){var e=this.handlers.indexOf(t);return-1!==e&&this.handlers.splice(e,2),this},e.getHandler=function(t){for(var e=0,r=this.handlers.length;e<r;e+=2){var o=this.handlers[e],i=this.handlers[e+1];if(o.global&&(o.lastIndex=0),o.test(t))return i}return null},t}(),n=new s,a=/*#__PURE__*/function(){function t(t){this.manager=void 0,this.crossOrigin=void 0,this.withCredentials=void 0,this.path=void 0,this.resourcePath=void 0,this.requestHeader=void 0,this.manager=void 0!==t?t:n,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}var e=t.prototype;return e.load=function(t,e,r,o){},e.loadAsync=function(t,e){var r=this;return new Promise(function(o,i){r.load(t,o,e,i)})},e.parse=function(){},e.setCrossOrigin=function(t){return this.crossOrigin=t,this},e.setWithCredentials=function(t){return this.withCredentials=t,this},e.setPath=function(t){return this.path=t,this},e.setResourcePath=function(t){return this.resourcePath=t,this},e.setRequestHeader=function(t){return this.requestHeader=t,this},t}(),d=/*#__PURE__*/function(){function t(t){void 0===t&&(t=4),this.pool=void 0,this.queue=void 0,this.workers=void 0,this.workersResolve=void 0,this.workerStatus=void 0,this.workerCreator=void 0,this.pool=t,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}var e=t.prototype;return e._initWorker=function(t){if(!this.workers[t]){var e=this.workerCreator();e.addEventListener("message",this._onMessage.bind(this,t)),this.workers[t]=e}},e._getIdleWorker=function(){for(var t=0;t<this.pool;t++)if(!(this.workerStatus&1<<t))return t;return-1},e._onMessage=function(t,e){var r=this.workersResolve[t];if(r&&r(e),this.queue.length){var o=this.queue.shift(),i=o.msg,s=o.transfer;this.workersResolve[t]=o.resolve,this.workers[t].postMessage(i,s)}else this.workerStatus^=1<<t},e.setWorkerCreator=function(t){this.workerCreator=t},e.setWorkerLimit=function(t){this.pool=t},e.postMessage=function(t,e){var r=this;return new Promise(function(o){var i=r._getIdleWorker();-1!==i?(r._initWorker(i),r.workerStatus|=1<<i,r.workersResolve[i]=o,r.workers[i].postMessage(t,e)):r.queue.push({resolve:o,msg:t,transfer:e})})},e.destroy=function(){this.workers.forEach(function(t){return t.terminate()}),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0},t}(),h={},u=/*#__PURE__*/function(t){var e,r;function o(e){var r;return(r=t.call(this,e)||this).mimeType=void 0,r.responseType=void 0,r}r=t,(e=o).prototype=Object.create(r.prototype),e.prototype.constructor=e,i(e,r);var s=o.prototype;return s.load=function(t,e,r,o){var i=this;if(void 0===t&&(t=""),void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t),void 0===h[t]){h[t]=[],h[t].push({onLoad:e,onProgress:r,onError:o});var s=new Request(t,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin"}),n=this.mimeType,a=this.responseType;fetch(s).then(function(e){if(200===e.status||0===e.status){if(0===e.status&&console.warn("FileLoader: HTTP Status 0 received."),"undefined"==typeof ReadableStream||void 0===e.body.getReader)return e;var r=h[t],o=e.body.getReader(),i=e.headers.get("Content-Length"),s=i?parseInt(i):0,n=0!==s,a=0,d=new ReadableStream({start:function(t){!function e(){o.read().then(function(o){var i=o.value;if(o.done)t.close();else{for(var d=new ProgressEvent("progress",{lengthComputable:n,loaded:a+=i.byteLength,total:s}),h=0,u=r.length;h<u;h++){var c=r[h];c.onProgress&&c.onProgress(d)}t.enqueue(i),e()}})}()}});return new Response(d)}throw new Error('fetch for "'+e.url+'" responded with '+e.status+": "+e.statusText)}).then(function(t){switch(a){case"arraybuffer":return t.arrayBuffer();case"blob":return t.blob();case"document":return t.text().then(function(t){return(new DOMParser).parseFromString(t,n)});case"json":return t.json();default:if(void 0===n)return t.text();var e=/charset="?([^;"\s]*)"?/i.exec(n),r=e&&e[1]?e[1].toLowerCase():void 0,o=new TextDecoder(r);return t.arrayBuffer().then(function(t){return o.decode(t)})}}).then(function(e){var r=h[t];delete h[t];for(var o=0,i=r.length;o<i;o++){var s=r[o];s.onLoad&&s.onLoad(e)}}).catch(function(e){var r=h[t];if(void 0===r)throw i.manager.itemError(t),e;delete h[t];for(var o=0,s=r.length;o<s;o++){var n=r[o];n.onError&&n.onError(e)}i.manager.itemError(t)}).finally(function(){i.manager.itemEnd(t)}),this.manager.itemStart(t)}else h[t].push({onLoad:e,onProgress:r,onError:o})},s.setResponseType=function(t){return this.responseType=t,this},s.setMimeType=function(t){return this.mimeType=t,this},o}(a);[["0",10],["A",26],["a",26],["_",1],["$",1]].map(function(t){for(var e=[],r=t[0].charCodeAt(0),o=r+t[1],i=r;i<o;++i)e.push(i);return String.fromCharCode.apply(null,e)}).join(""),function(){for(var t=[],e=0;e<256;e++)t[e]=(e<16?"0":"")+e.toString(16)}();var c=0,f={ETC1S:0,UASTC_4x4:1},l={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16},p={RGBAFormat:1023,RGBA_ASTC_4x4_Format:37808,RGBA_BPTC_Format:36492,RGBA_ETC2_EAC_Format:37496,RGBA_PVRTC_4BPPV1_Format:35842,RGBA_S3TC_DXT5_Format:33779,RGB_ETC1_Format:36196,RGB_ETC2_Format:37492,RGB_PVRTC_4BPPV1_Format:35840,RGB_S3TC_DXT1_Format:33776},m=/*#__PURE__*/r("transcoderPath"),T=/*#__PURE__*/r("transcoderBinary"),v=/*#__PURE__*/r("transcoderPending"),g=/*#__PURE__*/r("workerPool"),_=/*#__PURE__*/r("workerSourceURL"),w=/*#__PURE__*/r("workerConfig"),C=/*#__PURE__*/r("supportedFileTypes"),y=/*#__PURE__*/r("withCredentials"),S=/*#__PURE__*/r("initTranscoder");function F(){var t=this;if(!o(this,v)[v]){var e=new u;e.setPath(o(this,m)[m]),e.setWithCredentials(o(this,y)[y]);var r=e.loadAsync("basis_transcoder.js"),i=new u;i.setPath(o(this,m)[m]),i.setResponseType("arraybuffer"),i.setWithCredentials(o(this,y)[y]);var s=i.loadAsync("basis_transcoder.wasm");o(this,v)[v]=Promise.all([r,s]).then(function(e){var r=e[0],i=e[1],s=P.toString(),n=["/* constants */","let _EngineFormat = "+JSON.stringify(p),"let _TranscoderFormat = "+JSON.stringify(l),"let _BasisFormat = "+JSON.stringify(f),"/* basis_transcoder.js */",r,"/* worker */",s.substring(s.indexOf("{")+1,s.lastIndexOf("}"))].join("\n");o(t,_)[_]=URL.createObjectURL(new Blob([n])),o(t,T)[T]=i,o(t,g)[g].setWorkerCreator(function(){var e=new Worker(o(t,_)[_]),r=o(t,T)[T].slice(0);return e.postMessage({type:"init",config:o(t,w)[w],transcoderBinary:r},[r]),e})}),c>0&&console.warn("KTX2TextureTranscoder: Multiple active KTX2TextureTranscoder may cause performance issues. Use a single KTX2TextureTranscoder instance, or call .dispose() on old instances."),c++}return o(this,v)[v]}var P=function(){var t,e,r,o=_EngineFormat,i=_TranscoderFormat,s=_BasisFormat;self.addEventListener("message",function(n){var u,c=n.data;switch(c.type){case"init":t=c.config,u=c.transcoderBinary,e=new Promise(function(t){r={wasmBinary:u,onRuntimeInitialized:t},BASIS(r)}).then(function(){r.initializeBasis(),void 0===r.KTX2File&&console.warn("KTX2TextureTranscoder: Please update Basis Universal transcoder.")});break;case"transcode":e.then(function(){try{for(var e=function(e){var n=new r.KTX2File(new Uint8Array(e));function u(){n.close(),n.delete()}if(!n.isValid())throw u(),new Error("KTX2TextureTranscoder: Invalid or unsupported .ktx2 file");var c=n.isUASTC()?s.UASTC_4x4:s.ETC1S,f=n.getWidth(),l=n.getHeight(),p=n.getLevels(),m=n.getHasAlpha(),T=n.getDFDTransferFunc(),v=n.getDFDFlags(),g=function(e,r,n,u){for(var c=e===s.ETC1S?a:d,f=0;f<c.length;f++){var l=c[f];if(t[l.if]&&l.basisFormat.includes(e)&&!(u&&l.transcoderFormat.length<2)&&(!l.needsPowerOfTwo||h(r)&&h(n)))return{transcoderFormat:l.transcoderFormat[u?1:0],engineFormat:l.engineFormat[u?1:0]}}return console.warn("KTX2TextureTranscoder: No suitable compressed texture format found. Decoding to RGBA32."),{transcoderFormat:i.RGBA32,engineFormat:o.RGBAFormat}}(c,f,l,m),_=g.transcoderFormat,w=g.engineFormat;if(!f||!l||!p)throw u(),new Error("KTX2TextureTranscoder: Invalid texture");if(!n.startTranscoding())throw u(),new Error("KTX2TextureTranscoder: .startTranscoding failed");for(var C=[],y=0;y<p;y++){var S=n.getImageLevelInfo(y,0,0),F=S.origWidth,P=S.origHeight,R=new Uint8Array(n.getImageTranscodedSizeInBytes(y,0,0,_));if(!n.transcodeImage(R,y,0,0,_,0,-1,-1))throw u(),new Error("KTX2TextureTranscoder: .transcodeImage failed.");C.push({data:R,width:F,height:P})}return u(),{width:f,height:l,hasAlpha:m,mipmaps:C,format:w,dfdTransferFn:T,dfdFlags:v}}(c.buffers[0]),n=e.width,u=e.height,f=e.hasAlpha,l=e.mipmaps,p=e.format,m=e.dfdTransferFn,T=e.dfdFlags,v=[],g=0;g<l.length;++g)v.push(l[g].data.buffer);self.postMessage({type:"transcode",id:c.id,width:n,height:u,hasAlpha:f,mipmaps:l,format:p,dfdTransferFn:m,dfdFlags:T},v)}catch(t){console.error("[BasisWorker]: "+t),self.postMessage({type:"error",id:c.id,error:t.message})}})}});var n=[{if:"astcSupported",basisFormat:[s.UASTC_4x4],transcoderFormat:[i.ASTC_4x4,i.ASTC_4x4],engineFormat:[o.RGBA_ASTC_4x4_Format,o.RGBA_ASTC_4x4_Format],priorityETC1S:Infinity,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[s.ETC1S,s.UASTC_4x4],transcoderFormat:[i.BC7_M5,i.BC7_M5],engineFormat:[o.RGBA_BPTC_Format,o.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[s.ETC1S,s.UASTC_4x4],transcoderFormat:[i.BC1,i.BC3],engineFormat:[o.RGB_S3TC_DXT1_Format,o.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[s.ETC1S,s.UASTC_4x4],transcoderFormat:[i.ETC1,i.ETC2],engineFormat:[o.RGB_ETC2_Format,o.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[s.ETC1S,s.UASTC_4x4],transcoderFormat:[i.ETC1],engineFormat:[o.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[s.ETC1S,s.UASTC_4x4],transcoderFormat:[i.PVRTC1_4_RGB,i.PVRTC1_4_RGBA],engineFormat:[o.RGB_PVRTC_4BPPV1_Format,o.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],a=n.sort(function(t,e){return t.priorityETC1S-e.priorityETC1S}),d=n.sort(function(t,e){return t.priorityUASTC-e.priorityUASTC});function h(t){return t<=2||0==(t&t-1)&&0!==t}};t.KTX2TextureTranscoder=/*#__PURE__*/function(){function t(t){Object.defineProperty(this,S,{value:F}),Object.defineProperty(this,m,{writable:!0,value:void 0}),Object.defineProperty(this,T,{writable:!0,value:void 0}),Object.defineProperty(this,v,{writable:!0,value:void 0}),Object.defineProperty(this,g,{writable:!0,value:void 0}),Object.defineProperty(this,_,{writable:!0,value:void 0}),Object.defineProperty(this,w,{writable:!0,value:void 0}),Object.defineProperty(this,C,{writable:!0,value:void 0}),Object.defineProperty(this,y,{writable:!0,value:void 0}),o(this,m)[m]=t.transcoderPath||"https://cdn.jsdelivr.net/npm/@xeokit/sdk/dist/basis/",o(this,T)[T]=null,o(this,v)[v]=null,o(this,g)[g]=new d,o(this,_)[_]="",t.workerLimit&&o(this,g)[g].setWorkerLimit(t.workerLimit),o(this,w)[w]=null,o(this,y)[y]=!1,o(this,C)[C]=["xkt2"]}var e=t.prototype;return e.init=function(t){o(this,w)[w]={astcSupported:t.astcSupported,etc1Supported:t.etc1Supported,etc2Supported:t.etc2Supported,dxtSupported:t.dxtSupported,bptcSupported:t.bptcSupported,pvrtcSupported:t.pvrtcSupported}},e.transcode=function(t,e){var r=this;return void 0===e&&(e={}),new Promise(function(i,s){var n=e;o(r,S)[S]().then(function(){return o(r,g)[g].postMessage({type:"transcode",buffers:t,taskConfig:n},t)}).then(function(t){var e=t.data,r=e.mipmaps,o=e.format,n=e.dfdTransferFn,a=e.dfdFlags;if("error"===e.type)return s(e.error);i({mipmaps:r,props:{format:o,minFilter:1===r.length?1006:1008,magFilter:1===r.length?1006:1008,encoding:2===n?3001:3e3,premultiplyAlpha:!!(1&a)}})})})},e.destroy=function(){URL.revokeObjectURL(o(this,_)[_]),o(this,g)[g].destroy(),c--},t}()});
//# sourceMappingURL=index.umd.js.map
