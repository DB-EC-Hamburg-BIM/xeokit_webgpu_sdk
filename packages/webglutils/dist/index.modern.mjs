import{Map as t,isArray as e}from"@xeokit/utils";import{UnsignedByteType as i,UnsignedShort4444Type as r,UnsignedShort5551Type as s,ByteType as a,ShortType as h,UnsignedShortType as n,IntType as E,UnsignedIntType as o,FloatType as _,HalfFloatType as l,AlphaFormat as T,RGBAFormat as d,LuminanceFormat as u,LuminanceAlphaFormat as R,DepthFormat as c,DepthStencilFormat as A,RedFormat as f,RGBFormat as S,RedIntegerFormat as m,RGFormat as g,RGIntegerFormat as p,RGBAIntegerFormat as P,RGB_S3TC_DXT1_Format as x,RGBA_S3TC_DXT1_Format as M,RGBA_S3TC_DXT3_Format as U,RGBA_S3TC_DXT5_Format as B,sRGBEncoding as I,RGB_PVRTC_4BPPV1_Format as F,RGB_PVRTC_2BPPV1_Format as C,RGBA_PVRTC_4BPPV1_Format as D,RGBA_PVRTC_2BPPV1_Format as v,RGB_ETC1_Format as N,RGB_ETC2_Format as G,RGBA_ETC2_EAC_Format as b,RGBA_ASTC_4x4_Format as O,RGBA_ASTC_5x4_Format as X,RGBA_ASTC_5x5_Format as L,RGBA_ASTC_6x5_Format as w,RGBA_ASTC_6x6_Format as y,RGBA_ASTC_8x5_Format as H,RGBA_ASTC_8x6_Format as W,RGBA_ASTC_8x8_Format as K,RGBA_ASTC_10x5_Format as V,RGBA_ASTC_10x6_Format as Y,RGBA_ASTC_10x8_Format as k,RGBA_ASTC_10x10_Format as j,RGBA_ASTC_12x10_Format as z,RGBA_ASTC_12x12_Format as Z,RGBA_BPTC_Format as J,UnsignedInt248Type as $,RepeatWrapping as q,ClampToEdgeWrapping as Q,NearestMipMapNearestFilter as tt,NearestMipMapLinearFilter as et,LinearMipMapNearestFilter as it,LinearMipMapLinearFilter as rt,NearestFilter as st,LinearFilter as at,NearestMipmapNearestFilter as ht,NearestMipmapLinearFilter as nt}from"@xeokit/constants";class Et{constructor(t,e,i,r,s,a,h,n,E){switch(this.gl=void 0,this.itemType=void 0,this.itemByteSize=void 0,this.type=void 0,this.allocated=void 0,this.usage=void 0,this.length=void 0,this.dataLength=void 0,this.numItems=void 0,this.itemSize=void 0,this.normalized=void 0,this.stride=void 0,this.offset=void 0,this.handle=void 0,this.gl=t,this.type=e,this.allocated=!1,i.constructor){case Uint8Array:this.itemType=t.UNSIGNED_BYTE,this.itemByteSize=1;break;case Int8Array:this.itemType=t.BYTE,this.itemByteSize=1;break;case Uint16Array:this.itemType=t.UNSIGNED_SHORT,this.itemByteSize=2;break;case Int16Array:this.itemType=t.SHORT,this.itemByteSize=2;break;case Uint32Array:this.itemType=t.UNSIGNED_INT,this.itemByteSize=4;break;case Int32Array:this.itemType=t.INT,this.itemByteSize=4;break;default:this.itemType=t.FLOAT,this.itemByteSize=4}this.usage=a,this.length=0,this.dataLength=r,this.numItems=0,this.itemSize=s,this.normalized=!!h,this.stride=n||0,this.offset=E||0,this._allocate(i)}_allocate(t){if(this.allocated=!1,this.handle=this.gl.createBuffer(),!this.handle)throw new Error("Failed to allocate WebGL ArrayBuffer");this.handle&&(this.gl.bindBuffer(this.type,this.handle),this.gl.bufferData(this.type,t.length>this.dataLength?t.slice(0,this.dataLength):t,this.usage),this.gl.bindBuffer(this.type,null),this.length=t.length,this.numItems=this.length/this.itemSize,this.allocated=!0)}setData(t,e){this.allocated&&(t.length+(e||0)>this.length?(this.destroy(),this._allocate(t)):(this.gl.bindBuffer(this.type,this.handle),e||0===e?this.gl.bufferSubData(this.type,e*this.itemByteSize,t):this.gl.bufferData(this.type,t,this.usage),this.gl.bindBuffer(this.type,null)))}bind(){this.allocated&&this.gl.bindBuffer(this.type,this.handle)}unbind(){this.allocated&&this.gl.bindBuffer(this.type,null)}destroy(){this.allocated&&(this.gl.deleteBuffer(this.handle),this.allocated=!1)}}class ot{constructor(t,e){this.gl=void 0,this.location=void 0,this.gl=t,this.location=e}bindArrayBuffer(t){t&&(t.bind(),this.gl.enableVertexAttribArray(this.location),this.gl.vertexAttribPointer(this.location,t.itemSize,t.itemType,t.normalized,t.stride,t.offset))}}var _t=0;function lt(t){return"__private_"+_t+++"_"+t}function Tt(t,e){if(!Object.prototype.hasOwnProperty.call(t,e))throw new TypeError("attempted to use private field on non-instance");return t}var dt=/*#__PURE__*/lt("onDestroyed");class ut{constructor(t={}){this.gl=void 0,this.texture=void 0,this.textureWidth=void 0,this.textureHeight=void 0,this.textureData=void 0,Object.defineProperty(this,dt,{writable:!0,value:void 0}),this.gl=t.gl,this.texture=t.texture,this.textureWidth=t.textureWidth,this.textureHeight=t.textureHeight,this.textureData=t.textureData,Tt(this,dt)[dt]=t.onDestroyed}bindTexture(t,e,i){this.gl&&e.bindTexture(this,i)}bind(t){return!(!this.gl||!this.texture||(this.gl.activeTexture(this.gl["TEXTURE"+t]),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),0))}disableFiltering(){this.gl&&(this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE))}unbind(t){}destroy(){this.gl&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null,Tt(this,dt)[dt]&&Tt(this,dt)[dt]())}}class Rt{constructor(t,e,i){if(this.errors=void 0,this.allocated=void 0,this.compiled=void 0,this.handle=void 0,this.allocated=!1,this.compiled=!1,this.handle=t.createShader(e),this.handle){if(this.allocated=!0,t.shaderSource(this.handle,i),t.compileShader(this.handle),this.compiled=t.getShaderParameter(this.handle,t.COMPILE_STATUS),!this.compiled&&!t.isContextLost()){const e=i.split("\n"),r=[];for(let t=0;t<e.length;t++)r.push(t+1+": "+e[t]+"\n");this.errors=[],this.errors.push(""),this.errors.push(t.getShaderInfoLog(this.handle)||""),this.errors=this.errors.concat(r.join(""))}}else this.errors=["Failed to allocate"]}destroy(){}}class ct{constructor(t,e){this.location=void 0,this.gl=void 0,this.gl=t,this.location=e}bindTexture(t,e){return!!t.bind(e)&&(this.gl.uniform1i(this.location,e),!0)}}const At=new t({},"");class ft{constructor(t,e){if(this.id=void 0,this.vertexShader=void 0,this.fragmentShader=void 0,this.attributes=void 0,this.samplers=void 0,this.uniforms=void 0,this.errors=void 0,this.validated=void 0,this.linked=void 0,this.compiled=void 0,this.allocated=void 0,this.gl=void 0,this.source=void 0,this.handle=void 0,this.id=At.addItem({}),this.source=e,this.gl=t,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errors=[],this.uniforms={},this.samplers={},this.attributes={},this.vertexShader=new Rt(t,t.VERTEX_SHADER,this.source.vertex),this.fragmentShader=new Rt(t,t.FRAGMENT_SHADER,this.source.fragment),!this.vertexShader.allocated)return this.errors=["Vertex shader failed to allocate"].concat(this.vertexShader.errors),void St(this.errors);if(!this.fragmentShader.allocated)return this.errors=["Fragment shader failed to allocate"].concat(this.fragmentShader.errors),void St(this.errors);if(this.allocated=!0,!this.vertexShader.compiled)return this.errors=["Vertex shader failed to compile"].concat(this.vertexShader.errors),void St(this.errors);if(!this.fragmentShader.compiled)return this.errors=["Fragment shader failed to compile"].concat(this.fragmentShader.errors),void St(this.errors);if(this.compiled=!0,this.handle=t.createProgram(),!this.handle)return void(this.errors=["Failed to allocate program"]);if(t.attachShader(this.handle,this.vertexShader.handle),t.attachShader(this.handle,this.fragmentShader.handle),t.linkProgram(this.handle),this.linked=t.getProgramParameter(this.handle,t.LINK_STATUS),this.validated=!0,!this.linked||!this.validated)return this.errors=[],this.errors.push(""),this.errors.push(t.getProgramInfoLog(this.handle)),this.errors.push("\nVertex shader:\n"),this.errors=this.errors.concat(this.source.vertex),this.errors.push("\nFragment shader:\n"),this.errors=this.errors.concat(this.source.fragment),void St(this.errors);const i=t.getProgramParameter(this.handle,t.ACTIVE_UNIFORMS);for(let e=0;e<i;++e){const i=t.getActiveUniform(this.handle,e);if(i){let e=i.name;"\0"===e[e.length-1]&&(e=e.substr(0,e.length-1));const r=t.getUniformLocation(this.handle,e);i.type===t.SAMPLER_2D||i.type===t.SAMPLER_CUBE||35682===i.type?this.samplers[e]=new ct(t,r):this.uniforms[e]=r}}const r=t.getProgramParameter(this.handle,t.ACTIVE_ATTRIBUTES);for(let e=0;e<r;e++){const i=t.getActiveAttrib(this.handle,e);if(i){const e=t.getAttribLocation(this.handle,i.name);this.attributes[i.name]=new ot(t,e)}}this.allocated=!0}bind(){this.allocated&&this.gl.useProgram(this.handle)}getLocation(t){return this.uniforms[t]}getAttribute(t){return this.attributes[t]}getSampler(t){return this.samplers[t]}bindTexture(t,e,i){if(!this.allocated)return!1;const r=this.samplers[t];return!!r&&r.bindTexture(e,i)}destroy(){this.allocated&&(At.removeItem(this.id),this.gl.deleteProgram(this.handle),this.gl.deleteShader(this.vertexShader.handle),this.gl.deleteShader(this.fragmentShader.handle),this.attributes={},this.uniforms={},this.samplers={},this.allocated=!1)}}function St(t){console.error(t.join("\n"))}const mt=function(){const t=document.createElement("canvas"),e=String.fromCharCode;if(!t.getContext)return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};const i=!!t.getContext("2d").getImageData,r=!!t.toDataURL,s=!!window.btoa,a=function(t){window.open(t)||(document.location.href=t)},h=function(t,e){return"data:"+e+";base64,"+t},n=function(t){const e=document.createElement("img");return e.src=t,e},E=function(t,e,i,r){if(e&&i){const s=document.createElement("canvas");s.width=e,s.height=i,s.style.width=e+"px",s.style.height=i+"px";const a=s.getContext("2d");return r?(a.save(),a.scale(1,-1),a.imageSmoothingEnabled=!0,a.drawImage(t,0,0,t.width,t.height,0,0,e,-i),a.restore()):(a.imageSmoothingEnabled=!0,a.drawImage(t,0,0,t.width,t.height,0,0,e,i)),s}return t};return{saveAsPNG:function(t,e,i,s,h){if(!r)return!1;const o=E(t,i,s,h).toDataURL("image/png");return e?n(o):(a(o),!0)},saveAsJPEG:function(t,e,i,s,h){if(!r)return!1;const o="image/jpeg",_=E(t,i,s,h).toDataURL(o);return 5==_.indexOf(o)&&(e?n(_):(a(_),!0))},saveAsBMP:function(t,o,_,l,T){if(!(r&&i&&s))return!1;const d="image/bmp",u=function(t){const e=parseInt(t.width),i=parseInt(t.height);return t.getContext("2d").getImageData(0,0,e,i)}(E(t,_,l,T)),R=function(t){let i="";const r=t.width,s=t.height;i+="BM";let a=r*s*4+54;i+=e(a%256),a=Math.floor(a/256),i+=e(a%256),a=Math.floor(a/256),i+=e(a%256),a=Math.floor(a/256),i+=e(a%256),i+=e(0,0,0,0,54,0,0,0),i+=e(40,0,0,0);let h=r;i+=e(h%256),h=Math.floor(h/256),i+=e(h%256),h=Math.floor(h/256),i+=e(h%256),h=Math.floor(h/256),i+=e(h%256);let n=s;i+=e(n%256),n=Math.floor(n/256),i+=e(n%256),n=Math.floor(n/256),i+=e(n%256),n=Math.floor(n/256),i+=e(n%256),i+=e(1,0,32,0),i+=e(0,0,0,0);let E=r*s*4;i+=e(E%256),E=Math.floor(E/256),i+=e(E%256),E=Math.floor(E/256),i+=e(E%256),E=Math.floor(E/256),i+=e(E%256),i+=e(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const o=t.data;let _,l,T,d,u="",R=s;do{for(T=r*(R-1)*4,d="",_=0;_<r;_++)l=4*_,d+=e(o[T+l+2],o[T+l+1],o[T+l],o[T+l+3]);u+=d}while(--R);return function(t){let i,r,s="";if("string"==typeof t)s=t;else for(r=t,i=0;i<r.length;i++)s+=e(r[i]);return btoa(s)}(i+u)}(u);return o?n(h(R,d)):(a(h(R,d)),!0)}}}();var gt=/*#__PURE__*/lt("canvas"),pt=/*#__PURE__*/lt("gl"),Pt=/*#__PURE__*/lt("allocated"),xt=/*#__PURE__*/lt("buffer"),Mt=/*#__PURE__*/lt("bound"),Ut=/*#__PURE__*/lt("size"),Bt=/*#__PURE__*/lt("hasDepthTexture"),It=/*#__PURE__*/lt("imageDataCache"),Ft=/*#__PURE__*/lt("texture"),Ct=/*#__PURE__*/lt("depthTexture"),Dt=/*#__PURE__*/lt("touch"),vt=/*#__PURE__*/lt("getImageDataCache");class Nt{constructor(t,e,i){Object.defineProperty(this,vt,{value:bt}),Object.defineProperty(this,Dt,{value:Gt}),Object.defineProperty(this,gt,{writable:!0,value:void 0}),Object.defineProperty(this,pt,{writable:!0,value:void 0}),Object.defineProperty(this,Pt,{writable:!0,value:void 0}),Object.defineProperty(this,xt,{writable:!0,value:void 0}),Object.defineProperty(this,Mt,{writable:!0,value:void 0}),Object.defineProperty(this,Ut,{writable:!0,value:void 0}),Object.defineProperty(this,Bt,{writable:!0,value:void 0}),Object.defineProperty(this,It,{writable:!0,value:void 0}),Object.defineProperty(this,Ft,{writable:!0,value:void 0}),Object.defineProperty(this,Ct,{writable:!0,value:void 0}),Tt(this,gt)[gt]=t,Tt(this,pt)[pt]=e,Tt(this,Pt)[Pt]=!1,Tt(this,xt)[xt]=null,Tt(this,Mt)[Mt]=!1,Tt(this,Ut)[Ut]=i.size,Tt(this,Bt)[Bt]=!!i.depthTexture}setSize(t){Tt(this,Ut)[Ut]=t}bind(){if(Tt(this,Dt)[Dt](),Tt(this,Mt)[Mt])return;const t=Tt(this,pt)[pt];t.bindFramebuffer(t.FRAMEBUFFER,Tt(this,xt)[xt].framebuf),Tt(this,Mt)[Mt]=!0}clear(){if(!Tt(this,Mt)[Mt])throw"Render buffer not bound";const t=Tt(this,pt)[pt];t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}read(t,e){const i=t,r=Tt(this,pt)[pt].drawingBufferHeight-e,s=new Uint8Array(4),a=Tt(this,pt)[pt];return a.readPixels(i,r,1,1,a.RGBA,a.UNSIGNED_BYTE,s),s}readImage(t){const e=Tt(this,pt)[pt],i=Tt(this,vt)[vt](),r=i.pixelData,s=i.canvas,a=i.imageData,h=i.context;e.readPixels(0,0,Tt(this,xt)[xt].width,Tt(this,xt)[xt].height,e.RGBA,e.UNSIGNED_BYTE,r),a.data.set(r),h.putImageData(a,0,0);const n=t.width||s.width,E=t.height||s.height,o=t.format||"jpeg",_=!0;let l;switch(o){case"jpeg":l=mt.saveAsJPEG(s,!0,n,E,_);break;case"png":l=mt.saveAsPNG(s,!0,n,E,_);break;case"bmp":l=mt.saveAsBMP(s,!0,n,E,_);break;default:console.error("Unsupported image format: '"+o+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'jpeg'"),l=mt.saveAsJPEG(s,!0,n,E,_)}return l.src}unbind(){const t=Tt(this,pt)[pt];t.bindFramebuffer(t.FRAMEBUFFER,null),Tt(this,Mt)[Mt]=!1}getTexture(){return Tt(this,Ft)[Ft]||(Tt(this,Ft)[Ft]={bind:t=>!(!Tt(this,xt)[xt]||!Tt(this,xt)[xt].texture||(Tt(this,pt)[pt].activeTexture(Tt(this,pt)[pt]["TEXTURE"+t]),Tt(this,pt)[pt].bindTexture(Tt(this,pt)[pt].TEXTURE_2D,Tt(this,xt)[xt].texture),0)),unbind:t=>{Tt(this,xt)[xt]&&Tt(this,xt)[xt].texture&&(Tt(this,pt)[pt].activeTexture(Tt(this,pt)[pt]["TEXTURE"+t]),Tt(this,pt)[pt].bindTexture(Tt(this,pt)[pt].TEXTURE_2D,null))}})}hasDepthTexture(){return Tt(this,Bt)[Bt]}getDepthTexture(){return Tt(this,Bt)[Bt]?Tt(this,Ct)[Ct]||(Tt(this,Ct)[Ct]={bind:t=>!(!Tt(this,xt)[xt]||!Tt(this,xt)[xt].depthTexture||(Tt(this,pt)[pt].activeTexture(Tt(this,pt)[pt]["TEXTURE"+t]),Tt(this,pt)[pt].bindTexture(Tt(this,pt)[pt].TEXTURE_2D,Tt(this,xt)[xt].depthTexture),0)),unbind:t=>{Tt(this,xt)[xt]&&Tt(this,xt)[xt].depthTexture&&(Tt(this,pt)[pt].activeTexture(Tt(this,pt)[pt]["TEXTURE"+t]),Tt(this,pt)[pt].bindTexture(Tt(this,pt)[pt].TEXTURE_2D,null))}}):null}destroy(){if(Tt(this,Pt)[Pt]){const t=Tt(this,pt)[pt];t.deleteTexture(Tt(this,xt)[xt].texture),t.deleteTexture(Tt(this,xt)[xt].depthTexture),t.deleteFramebuffer(Tt(this,xt)[xt].framebuf),t.deleteRenderbuffer(Tt(this,xt)[xt].renderbuf),Tt(this,Pt)[Pt]=!1,Tt(this,xt)[xt]=null,Tt(this,Mt)[Mt]=!1}Tt(this,It)[It]=null}}function Gt(){let t,e;const i=Tt(this,pt)[pt];if(Tt(this,Ut)[Ut]?(t=Tt(this,Ut)[Ut][0],e=Tt(this,Ut)[Ut][1]):(t=i.drawingBufferWidth,e=i.drawingBufferHeight),Tt(this,xt)[xt]){if(Tt(this,xt)[xt].width===t&&Tt(this,xt)[xt].height===e)return;i.deleteTexture(Tt(this,xt)[xt].texture),i.deleteFramebuffer(Tt(this,xt)[xt].framebuf),i.deleteRenderbuffer(Tt(this,xt)[xt].renderbuf)}const r=i.createTexture();let s;i.bindTexture(i.TEXTURE_2D,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,e,0,i.RGBA,i.UNSIGNED_BYTE,null),Tt(this,Bt)[Bt]&&(s=i.createTexture(),i.bindTexture(i.TEXTURE_2D,s),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.DEPTH_COMPONENT,t,e,0,i.DEPTH_COMPONENT,i.UNSIGNED_INT,null));const a=i.createRenderbuffer();i.bindRenderbuffer(i.RENDERBUFFER,a),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,t,e);const h=i.createFramebuffer();if(i.bindFramebuffer(i.FRAMEBUFFER,h),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,r,0),Tt(this,Bt)[Bt]?i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.TEXTURE_2D,s,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,a),i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,h),!i.isFramebuffer(h))throw"Invalid framebuffer";i.bindFramebuffer(i.FRAMEBUFFER,null);const n=i.checkFramebufferStatus(i.FRAMEBUFFER);switch(n){case i.FRAMEBUFFER_COMPLETE:break;case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case i.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+n}Tt(this,xt)[xt]={framebuf:h,renderbuf:a,texture:r,depthTexture:s,width:t,height:e},Tt(this,Mt)[Mt]=!1}function bt(){const t=Tt(this,xt)[xt].width,e=Tt(this,xt)[xt].height;let i=Tt(this,It)[It];if(i&&(i.width===t&&i.height===e||(Tt(this,It)[It]=null,i=null)),!i){const r=document.createElement("canvas");r.width=t,r.height=e;const s=r.getContext("2d"),a=s.createImageData(t,e);i={pixelData:new Uint8Array(t*e*4),canvas:r,context:s,imageData:a,width:t,height:e},Tt(this,It)[It]=i}return i}function Ot(t,e){if(void 0===t._cachedExtensions&&(t._cachedExtensions={}),void 0!==t._cachedExtensions[e])return t._cachedExtensions[e];let i;switch(e){case"WEBGL_depth_texture":i=t.getExtension("WEBGL_depth_texture")||t.getExtension("MOZ_WEBGL_depth_texture")||t.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":i=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":i=t.getExtension("WEBGL_compressed_texture_s3tc")||t.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":i=t.getExtension("WEBGL_compressed_texture_pvrtc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:i=t.getExtension(e)}return t._cachedExtensions[e]=i,i}function Xt(t,e,ht){let nt;const Et=e;if(Et===i)return t.UNSIGNED_BYTE;if(Et===r)return t.UNSIGNED_SHORT_4_4_4_4;if(Et===s)return t.UNSIGNED_SHORT_5_5_5_1;if(Et===a)return t.BYTE;if(Et===h)return t.SHORT;if(Et===n)return t.UNSIGNED_SHORT;if(Et===E)return t.INT;if(Et===o)return t.UNSIGNED_INT;if(Et===_)return t.FLOAT;if(Et===l)return t.HALF_FLOAT;if(Et===T)return t.ALPHA;if(Et===d)return t.RGBA;if(Et===u)return t.LUMINANCE;if(Et===R)return t.LUMINANCE_ALPHA;if(Et===c)return t.DEPTH_COMPONENT;if(Et===A)return t.DEPTH_STENCIL;if(Et===f)return t.RED;if(Et===S)return t.RGBA;if(Et===m)return t.RED_INTEGER;if(Et===g)return t.RG;if(Et===p)return t.RG_INTEGER;if(Et===P)return t.RGBA_INTEGER;if(Et===x||Et===M||Et===U||Et===B)if(ht===I){const e=Ot(t,"WEBGL_compressed_texture_s3tc_srgb");if(null===e)return null;if(Et===x)return e.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(Et===M)return e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(Et===U)return e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(Et===B)return e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(nt=Ot(t,"WEBGL_compressed_texture_s3tc"),null===nt)return null;if(Et===x)return nt.COMPRESSED_RGB_S3TC_DXT1_EXT;if(Et===M)return nt.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(Et===U)return nt.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(Et===B)return nt.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(Et===F||Et===C||Et===D||Et===v){const e=Ot(t,"WEBGL_compressed_texture_pvrtc");if(null===e)return null;if(Et===F)return e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(Et===C)return e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(Et===D)return e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(Et===v)return e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(Et===N){const e=Ot(t,"WEBGL_compressed_texture_etc1");return null!==e?e.COMPRESSED_RGB_ETC1_WEBGL:null}if(Et===G||Et===b){const e=Ot(t,"WEBGL_compressed_texture_etc");if(null===e)return null;if(Et===G)return ht===I?e.COMPRESSED_SRGB8_ETC2:e.COMPRESSED_RGB8_ETC2;if(Et===b)return ht===I?e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e.COMPRESSED_RGBA8_ETC2_EAC}if(Et===O||Et===X||Et===L||Et===w||Et===y||Et===H||Et===W||Et===K||Et===V||Et===Y||Et===k||Et===j||Et===z||Et===Z){const e=Ot(t,"WEBGL_compressed_texture_astc");if(null===e)return null;if(Et===O)return ht===I?e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:e.COMPRESSED_RGBA_ASTC_4x4_KHR;if(Et===X)return ht===I?e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:e.COMPRESSED_RGBA_ASTC_5x4_KHR;if(Et===L)return ht===I?e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:e.COMPRESSED_RGBA_ASTC_5x5_KHR;if(Et===w)return ht===I?e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:e.COMPRESSED_RGBA_ASTC_6x5_KHR;if(Et===y)return ht===I?e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:e.COMPRESSED_RGBA_ASTC_6x6_KHR;if(Et===H)return ht===I?e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:e.COMPRESSED_RGBA_ASTC_8x5_KHR;if(Et===W)return ht===I?e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:e.COMPRESSED_RGBA_ASTC_8x6_KHR;if(Et===K)return ht===I?e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:e.COMPRESSED_RGBA_ASTC_8x8_KHR;if(Et===V)return ht===I?e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:e.COMPRESSED_RGBA_ASTC_10x5_KHR;if(Et===Y)return ht===I?e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:e.COMPRESSED_RGBA_ASTC_10x6_KHR;if(Et===k)return ht===I?e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:e.COMPRESSED_RGBA_ASTC_10x8_KHR;if(Et===j)return ht===I?e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:e.COMPRESSED_RGBA_ASTC_10x10_KHR;if(Et===z)return ht===I?e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:e.COMPRESSED_RGBA_ASTC_12x10_KHR;if(Et===Z)return ht===I?e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:e.COMPRESSED_RGBA_ASTC_12x12_KHR}if(Et===J){const e=Ot(t,"EXT_texture_compression_bptc");if(null===e)return null;if(Et===J)return ht===I?e.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:e.COMPRESSED_RGBA_BPTC_UNORM_EXT}return Et===$?t.UNSIGNED_INT_24_8:Et===q?t.REPEAT:Et===Q?t.CLAMP_TO_EDGE:Et===tt||Et===et?t.NEAREST_MIPMAP_LINEAR:Et===it?t.LINEAR_MIPMAP_NEAREST:Et===rt?t.LINEAR_MIPMAP_LINEAR:Et===st?t.NEAREST:Et===at?t.LINEAR:null}const Lt=new Uint8Array([0,0,0,1]);class wt{constructor(t){this.gl=void 0,this.target=void 0,this.format=void 0,this.type=void 0,this.internalFormat=void 0,this.premultiplyAlpha=void 0,this.flipY=void 0,this.unpackAlignment=void 0,this.wrapS=void 0,this.wrapT=void 0,this.wrapR=void 0,this.texture=void 0,this.allocated=void 0,this.minFilter=void 0,this.magFilter=void 0,this.encoding=void 0,this.gl=t.gl,this.target=t.target||t.gl.TEXTURE_2D,this.format=t.format||d,this.type=t.type||i,this.internalFormat=-1,this.premultiplyAlpha=!!t.premultiplyAlpha,this.flipY=!!t.flipY,this.unpackAlignment=4,this.wrapS=t.wrapS||q,this.wrapT=t.wrapT||q,this.wrapR=t.wrapR||q,this.texture=t.gl.createTexture(),t.preloadColor&&this.setPreloadColor(t.preloadColor),this.allocated=!0}setPreloadColor(t){t?(Lt[0]=Math.floor(255*t[0]),Lt[1]=Math.floor(255*t[1]),Lt[2]=Math.floor(255*t[2]),Lt[3]=Math.floor(255*(void 0!==t[3]?t[3]:1))):(Lt[0]=0,Lt[1]=0,Lt[2]=0,Lt[3]=255);const e=this.gl;if(e.bindTexture(this.target,this.texture),this.target===e.TEXTURE_CUBE_MAP){const t=[e.TEXTURE_CUBE_MAP_POSITIVE_X,e.TEXTURE_CUBE_MAP_NEGATIVE_X,e.TEXTURE_CUBE_MAP_POSITIVE_Y,e.TEXTURE_CUBE_MAP_NEGATIVE_Y,e.TEXTURE_CUBE_MAP_POSITIVE_Z,e.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let i=0,r=t.length;i<r;i++)e.texImage2D(t[i],0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,Lt)}else e.texImage2D(this.target,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,Lt);e.bindTexture(this.target,null)}setTarget(t){this.target=t||this.gl.TEXTURE_2D}setImage(t,i={}){const r=this.gl;void 0!==i.format&&(this.format=i.format),void 0!==i.internalFormat&&(this.internalFormat=i.internalFormat),void 0!==i.encoding&&(this.encoding=i.encoding),void 0!==i.type&&(this.type=i.type),void 0!==i.flipY&&(this.flipY=i.flipY),void 0!==i.premultiplyAlpha&&(this.premultiplyAlpha=i.premultiplyAlpha),void 0!==i.unpackAlignment&&(this.unpackAlignment=i.unpackAlignment),void 0!==i.minFilter&&(this.minFilter=i.minFilter),void 0!==i.magFilter&&(this.magFilter=i.magFilter),void 0!==i.wrapS&&(this.wrapS=i.wrapS),void 0!==i.wrapT&&(this.wrapT=i.wrapT),void 0!==i.wrapR&&(this.wrapR=i.wrapR),r.bindTexture(this.target,this.texture),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,this.flipY),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),r.pixelStorei(r.UNPACK_ALIGNMENT,this.unpackAlignment),r.pixelStorei(r.UNPACK_COLORSPACE_CONVERSION_WEBGL,r.NONE);const s=Xt(r,this.minFilter);r.texParameteri(this.target,r.TEXTURE_MIN_FILTER,s);const a=Xt(r,this.magFilter);a&&r.texParameteri(this.target,r.TEXTURE_MAG_FILTER,a);const h=Xt(r,this.wrapS);h&&r.texParameteri(this.target,r.TEXTURE_WRAP_S,h);const n=Xt(r,this.wrapT);n&&r.texParameteri(this.target,r.TEXTURE_WRAP_T,n);const E=Xt(r,this.format,this.encoding),o=Xt(r,this.type),_=yt(r,this.internalFormat,E,o,this.encoding,!1);if(this.target===r.TEXTURE_CUBE_MAP){if(e(t)){const e=t,i=[r.TEXTURE_CUBE_MAP_POSITIVE_X,r.TEXTURE_CUBE_MAP_NEGATIVE_X,r.TEXTURE_CUBE_MAP_POSITIVE_Y,r.TEXTURE_CUBE_MAP_NEGATIVE_Y,r.TEXTURE_CUBE_MAP_POSITIVE_Z,r.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let t=0,s=i.length;t<s;t++)r.texImage2D(i[t],0,_,E,o,e[t])}}else r.texImage2D(r.TEXTURE_2D,0,_,E,o,t);r.bindTexture(this.target,null)}setCompressedData(t){const e=this.gl,i=t.mipmaps||[],r=i.length,s=t.props;void 0!==s.format&&(this.format=s.format),void 0!==s.internalFormat&&(this.internalFormat=s.internalFormat),void 0!==s.encoding&&(this.encoding=s.encoding),void 0!==s.type&&(this.type=s.type),void 0!==s.flipY&&(this.flipY=s.flipY),void 0!==s.premultiplyAlpha&&(this.premultiplyAlpha=s.premultiplyAlpha),void 0!==s.unpackAlignment&&(this.unpackAlignment=s.unpackAlignment),void 0!==s.minFilter&&(this.minFilter=s.minFilter),void 0!==s.magFilter&&(this.magFilter=s.magFilter),void 0!==s.wrapS&&(this.wrapS=s.wrapS),void 0!==s.wrapT&&(this.wrapT=s.wrapT),void 0!==s.wrapR&&(this.wrapR=s.wrapR),e.activeTexture(e.TEXTURE0+0),e.bindTexture(this.target,this.texture);let a=i.length>1;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,this.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,this.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE);const h=Xt(e,this.wrapS);h&&e.texParameteri(this.target,e.TEXTURE_WRAP_S,h);const n=Xt(e,this.wrapT);if(n&&e.texParameteri(this.target,e.TEXTURE_WRAP_T,n),this.type===e.TEXTURE_3D||this.type===e.TEXTURE_2D_ARRAY){const t=Xt(e,this.wrapR);t&&e.texParameteri(this.target,e.TEXTURE_WRAP_R,t),e.texParameteri(this.type,e.TEXTURE_WRAP_R,t)}a?(e.texParameteri(this.target,e.TEXTURE_MIN_FILTER,Ht(e,this.minFilter)),e.texParameteri(this.target,e.TEXTURE_MAG_FILTER,Ht(e,this.magFilter))):(e.texParameteri(this.target,e.TEXTURE_MIN_FILTER,Xt(e,this.minFilter)),e.texParameteri(this.target,e.TEXTURE_MAG_FILTER,Xt(e,this.magFilter)));const E=Xt(e,this.format,this.encoding),o=Xt(e,this.type),_=yt(e,this.internalFormat,E,o,this.encoding,!1);e.texStorage2D(e.TEXTURE_2D,r,_,i[0].width,i[0].height);for(let t=0,r=i.length;t<r;t++){const r=i[t];this.format!==d?null!==E?e.compressedTexSubImage2D(e.TEXTURE_2D,t,0,0,r.width,r.height,E,r.data):console.warn("Attempt to load unsupported compressed texture format in .setCompressedData()"):e.texSubImage2D(e.TEXTURE_2D,t,0,0,r.width,r.height,E,o,r.data)}e.bindTexture(this.target,null)}setProps(t){const e=this.gl;e.bindTexture(this.target,this.texture),this._uploadProps(t),e.bindTexture(this.target,null)}_uploadProps(t){const e=this.gl;if(void 0!==t.format&&(this.format=t.format),void 0!==t.internalFormat&&(this.internalFormat=t.internalFormat),void 0!==t.encoding&&(this.encoding=t.encoding),void 0!==t.type&&(this.type=t.type),void 0!==t.minFilter){const i=Xt(e,t.minFilter);i&&(this.minFilter=t.minFilter,e.texParameteri(this.target,e.TEXTURE_MIN_FILTER,i),i!==e.NEAREST_MIPMAP_NEAREST&&i!==e.LINEAR_MIPMAP_NEAREST&&i!==e.NEAREST_MIPMAP_LINEAR&&i!==e.LINEAR_MIPMAP_LINEAR||e.generateMipmap(this.target))}if(void 0!==t.magFilter){const i=Xt(e,t.magFilter);i&&(this.magFilter=t.magFilter,e.texParameteri(this.target,e.TEXTURE_MAG_FILTER,i))}if(void 0!==t.wrapS){const i=Xt(e,t.wrapS);i&&(this.wrapS=t.wrapS,e.texParameteri(this.target,e.TEXTURE_WRAP_S,i))}if(void 0!==t.wrapT){const i=Xt(e,t.wrapT);i&&(this.wrapT=t.wrapT,e.texParameteri(this.target,e.TEXTURE_WRAP_T,i))}}bind(t){if(!this.allocated)return!1;if(this.texture){const e=this.gl;return e.activeTexture(e[`TEXTURE${t}`]),e.bindTexture(this.target,this.texture),!0}return!1}unbind(t){if(this.allocated&&this.texture){const e=this.gl;e.activeTexture(e[`TEXTURE${t}`]),e.bindTexture(this.target,null)}}destroy(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)}}function yt(t,e,i,r,s,a=!1){if(null!==e){if(void 0!==t[e])return t[e];console.warn("Attempt to use non-existing WebGL internal format '"+e+"'")}let h=i;return i===t.RED&&(r===t.FLOAT&&(h=t.R32F),r===t.HALF_FLOAT&&(h=t.R16F),r===t.UNSIGNED_BYTE&&(h=t.R8)),i===t.RG&&(r===t.FLOAT&&(h=t.RG32F),r===t.HALF_FLOAT&&(h=t.RG16F),r===t.UNSIGNED_BYTE&&(h=t.RG8)),i===t.RGBA&&(r===t.FLOAT&&(h=t.RGBA32F),r===t.HALF_FLOAT&&(h=t.RGBA16F),r===t.UNSIGNED_BYTE&&(h=s===I&&!1===a?t.SRGB8_ALPHA8:t.RGBA8),r===t.UNSIGNED_SHORT_4_4_4_4&&(h=t.RGBA4),r===t.UNSIGNED_SHORT_5_5_5_1&&(h=t.RGB5_A1)),h!==t.R16F&&h!==t.R32F&&h!==t.RG16F&&h!==t.RG32F&&h!==t.RGBA16F&&h!==t.RGBA32F||Ot(t,"EXT_color_buffer_float"),h}function Ht(t,e){return e===st||e===ht||e===nt?t.NEAREST:t.LINEAR}const Wt={WEBGL:!1,SUPPORTED_EXTENSIONS:{}},Kt=document.createElement("canvas");if(Kt){const t=Kt.getContext("webgl2",{antialias:!0});Wt.WEBGL=!!t,Wt.WEBGL&&(Wt.ANTIALIAS=t.getContextAttributes().antialias,Wt.FS_MAX_FLOAT_PRECISION=t.getShaderPrecisionFormat?t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT).precision>0?"highp":t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT).precision>0?"mediump":"lowp":"mediump",Wt.DEPTH_BUFFER_BITS=t.getParameter(t.DEPTH_BITS),Wt.MAX_TEXTURE_SIZE=t.getParameter(t.MAX_TEXTURE_SIZE),Wt.MAX_CUBE_MAP_SIZE=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),Wt.MAX_RENDERBUFFER_SIZE=t.getParameter(t.MAX_RENDERBUFFER_SIZE),Wt.MAX_TEXTURE_UNITS=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),Wt.MAX_TEXTURE_IMAGE_UNITS=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),Wt.MAX_VERTEX_ATTRIBS=t.getParameter(t.MAX_VERTEX_ATTRIBS),Wt.MAX_VERTEX_UNIFORM_VECTORS=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),Wt.MAX_FRAGMENT_UNIFORM_VECTORS=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),Wt.MAX_VARYING_VECTORS=t.getParameter(t.MAX_VARYING_VECTORS),t.getSupportedExtensions().forEach(function(t){Wt.SUPPORTED_EXTENSIONS[t]=!0}),Wt.depthTexturesSupported=Wt.SUPPORTED_EXTENSIONS.WEBGL_depth_texture)}export{mt as Canvas2Image,Et as GLArrayBuf,ot as GLAttribute,ut as GLDataTexture,ft as GLProgram,Nt as GLRenderBuffer,ct as GLSampler,Rt as GLShader,wt as GLTexture,Wt as WEBGL_INFO,Xt as convertConstant,Ot as getExtension};
//# sourceMappingURL=index.modern.mjs.map
