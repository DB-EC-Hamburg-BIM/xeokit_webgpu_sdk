import{createVec4 as e,createMat4 as t,createMat3 as i,identityMat3 as r,translationMat3v as s,scalingMat3v as n,mulMat3 as o,createVec3 as h,subVec3 as a,lenVec3 as l,identityMat4 as c,transformPoint4 as d,transformPoint3 as u,mulMat4 as f,translationMat4c as p,identityQuat as g,eulerToQuat as v,composeMat4 as m,transformVec4 as E,setMat4Translation as T}from"@xeokit/matrix";import{WEBGL_INFO as b,GLProgram as x,GLDataTexture as w,GLTexture as _,getExtension as y}from"@xeokit/webglutils";import{Component as M,EventEmitter as P}from"@xeokit/core";import{EventDispatcher as C}from"strongly-typed-events";import"@xeokit/scene";import{newFloatArray as I,MAX_DOUBLE as R,MIN_DOUBLE as S}from"@xeokit/math";import"@xeokit/compression";import"@xeokit/boundaries";var O=0;function D(e){return"__private_"+O+++"_"+e}function A(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}var B=0;function L(e){return"__private_"+B+++"_"+e}function U(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}var F=/*#__PURE__*/L("items"),j=/*#__PURE__*/L("lastUniqueId"),G=/*#__PURE__*/function(){function e(e,t){Object.defineProperty(this,F,{writable:!0,value:void 0}),Object.defineProperty(this,j,{writable:!0,value:void 0}),U(this,F)[F]=e||[],U(this,j)[j]=(t||0)+1}var t=e.prototype;return t.addItem=function(){var e;if(2===arguments.length){var t=arguments[0];if(e=arguments[1],U(this,F)[F][t])throw"ID clash: '"+t+"'";return U(this,F)[F][t]=e,t}for(e=arguments[0]||{};;){var i=U(this,j)[j]++;if(!U(this,F)[F][i])return U(this,F)[F][i]=e,i}},t.removeItem=function(e){var t=U(this,F)[F][e];return delete U(this,F)[F][e],t},e}();[["0",10],["A",26],["a",26],["_",1],["$",1]].map(function(e){for(var t=[],i=e[0].charCodeAt(0),r=i+e[1],s=i;s<r;++s)t.push(s);return String.fromCharCode.apply(null,t)}).join("");var N=function(){for(var e=[],t=0;t<256;t++)e[t]=(t<16?"0":"")+t.toString(16);return function(){var t=4294967295*Math.random()|0,i=4294967295*Math.random()|0,r=4294967295*Math.random()|0,s=4294967295*Math.random()|0;return e[255&t]+e[t>>8&255]+e[t>>16&255]+e[t>>24&255]+"-"+e[255&i]+e[i>>8&255]+"-"+e[i>>16&15|64]+e[i>>24&255]+"-"+e[63&r|128]+e[r>>8&255]+"-"+e[r>>16&255]+e[r>>24&255]+e[255&s]+e[s>>8&255]+e[s>>16&255]+e[s>>24&255]}}(),k=2e4,H=20001,X=0;function V(e){return"__private_"+X+++"_"+e}function W(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}function z(e,t){return z=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},z(e,t)}var $=/*#__PURE__*/function(){function e(e,t,i){this.isLoading=void 0,this.itemsLoaded=void 0,this.itemsTotal=void 0,this.urlModifier=void 0,this.handlers=void 0,this.onStart=void 0,this.onLoad=void 0,this.onProgress=void 0,this.onError=void 0,this.isLoading=!1,this.itemsLoaded=0,this.itemsTotal=0,this.urlModifier=void 0,this.handlers=[],this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=i}var t=e.prototype;return t.itemStart=function(e){this.itemsTotal++,this.isLoading||void 0!==this.onStart&&this.onStart(e,this.itemsLoaded,this.itemsTotal),this.isLoading=!0},t.itemEnd=function(e){this.itemsLoaded++,void 0!==this.onProgress&&this.onProgress(e,this.itemsLoaded,this.itemsTotal),this.itemsLoaded===this.itemsTotal&&(this.isLoading=!1,void 0!==this.onLoad&&this.onLoad())},t.itemError=function(e){void 0!==this.onError&&this.onError(e)},t.resolveURL=function(e){return this.urlModifier?this.urlModifier(e):e},t.setURLModifier=function(e){return this.urlModifier=e,this},t.addHandler=function(e,t){return this.handlers.push(e,t),this},t.removeHandler=function(e){var t=this.handlers.indexOf(e);return-1!==t&&this.handlers.splice(t,2),this},t.getHandler=function(e){for(var t=0,i=this.handlers.length;t<i;t+=2){var r=this.handlers[t],s=this.handlers[t+1];if(r.global&&(r.lastIndex=0),r.test(e))return s}return null},e}(),q=new $,Y=/*#__PURE__*/function(){function e(e){this.manager=void 0,this.crossOrigin=void 0,this.withCredentials=void 0,this.path=void 0,this.resourcePath=void 0,this.requestHeader=void 0,this.manager=void 0!==e?e:q,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}var t=e.prototype;return t.load=function(e,t,i,r){},t.loadAsync=function(e,t){var i=this;return new Promise(function(r,s){i.load(e,r,t,s)})},t.parse=function(){},t.setCrossOrigin=function(e){return this.crossOrigin=e,this},t.setWithCredentials=function(e){return this.withCredentials=e,this},t.setPath=function(e){return this.path=e,this},t.setResourcePath=function(e){return this.resourcePath=e,this},t.setRequestHeader=function(e){return this.requestHeader=e,this},e}(),K=/*#__PURE__*/function(){function e(e){void 0===e&&(e=4),this.pool=void 0,this.queue=void 0,this.workers=void 0,this.workersResolve=void 0,this.workerStatus=void 0,this.workerCreator=void 0,this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}var t=e.prototype;return t._initWorker=function(e){if(!this.workers[e]){var t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}},t._getIdleWorker=function(){for(var e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1},t._onMessage=function(e,t){var i=this.workersResolve[e];if(i&&i(t),this.queue.length){var r=this.queue.shift(),s=r.msg,n=r.transfer;this.workersResolve[e]=r.resolve,this.workers[e].postMessage(s,n)}else this.workerStatus^=1<<e},t.setWorkerCreator=function(e){this.workerCreator=e},t.setWorkerLimit=function(e){this.pool=e},t.postMessage=function(e,t){var i=this;return new Promise(function(r){var s=i._getIdleWorker();-1!==s?(i._initWorker(s),i.workerStatus|=1<<s,i.workersResolve[s]=r,i.workers[s].postMessage(e,t)):i.queue.push({resolve:r,msg:e,transfer:t})})},t.destroy=function(){this.workers.forEach(function(e){return e.terminate()}),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0},e}(),Z={},Q=/*#__PURE__*/function(e){var t,i;function r(t){var i;return(i=e.call(this,t)||this).mimeType=void 0,i.responseType=void 0,i}i=e,(t=r).prototype=Object.create(i.prototype),t.prototype.constructor=t,z(t,i);var s=r.prototype;return s.load=function(e,t,i,r){var s=this;if(void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e),void 0===Z[e]){Z[e]=[],Z[e].push({onLoad:t,onProgress:i,onError:r});var n=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin"}),o=this.mimeType,h=this.responseType;fetch(n).then(function(t){if(200===t.status||0===t.status){if(0===t.status&&console.warn("FileLoader: HTTP Status 0 received."),"undefined"==typeof ReadableStream||void 0===t.body.getReader)return t;var i=Z[e],r=t.body.getReader(),s=t.headers.get("Content-Length"),n=s?parseInt(s):0,o=0!==n,h=0,a=new ReadableStream({start:function(e){!function t(){r.read().then(function(r){var s=r.value;if(r.done)e.close();else{for(var a=new ProgressEvent("progress",{lengthComputable:o,loaded:h+=s.byteLength,total:n}),l=0,c=i.length;l<c;l++){var d=i[l];d.onProgress&&d.onProgress(a)}e.enqueue(s),t()}})}()}});return new Response(a)}throw new Error('fetch for "'+t.url+'" responded with '+t.status+": "+t.statusText)}).then(function(e){switch(h){case"arraybuffer":return e.arrayBuffer();case"blob":return e.blob();case"document":return e.text().then(function(e){return(new DOMParser).parseFromString(e,o)});case"json":return e.json();default:if(void 0===o)return e.text();var t=/charset="?([^;"\s]*)"?/i.exec(o),i=t&&t[1]?t[1].toLowerCase():void 0,r=new TextDecoder(i);return e.arrayBuffer().then(function(e){return r.decode(e)})}}).then(function(t){var i=Z[e];delete Z[e];for(var r=0,s=i.length;r<s;r++){var n=i[r];n.onLoad&&n.onLoad(t)}}).catch(function(t){var i=Z[e];if(void 0===i)throw s.manager.itemError(e),t;delete Z[e];for(var r=0,n=i.length;r<n;r++){var o=i[r];o.onError&&o.onError(t)}s.manager.itemError(e)}).finally(function(){s.manager.itemEnd(e)}),this.manager.itemStart(e)}else Z[e].push({onLoad:t,onProgress:i,onError:r})},s.setResponseType=function(e){return this.responseType=e,this},s.setMimeType=function(e){return this.mimeType=e,this},r}(Y);[["0",10],["A",26],["a",26],["_",1],["$",1]].map(function(e){for(var t=[],i=e[0].charCodeAt(0),r=i+e[1],s=i;s<r;++s)t.push(s);return String.fromCharCode.apply(null,t)}).join(""),function(){for(var e=[],t=0;t<256;t++)e[t]=(t<16?"0":"")+t.toString(16)}();var J=0,ee={ETC1S:0,UASTC_4x4:1},te={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16},ie={RGBAFormat:1023,RGBA_ASTC_4x4_Format:37808,RGBA_BPTC_Format:36492,RGBA_ETC2_EAC_Format:37496,RGBA_PVRTC_4BPPV1_Format:35842,RGBA_S3TC_DXT5_Format:33779,RGB_ETC1_Format:36196,RGB_ETC2_Format:37492,RGB_PVRTC_4BPPV1_Format:35840,RGB_S3TC_DXT1_Format:33776},re=/*#__PURE__*/V("transcoderPath"),se=/*#__PURE__*/V("transcoderBinary"),ne=/*#__PURE__*/V("transcoderPending"),oe=/*#__PURE__*/V("workerPool"),he=/*#__PURE__*/V("workerSourceURL"),ae=/*#__PURE__*/V("workerConfig"),le=/*#__PURE__*/V("supportedFileTypes"),ce=/*#__PURE__*/V("withCredentials"),de=/*#__PURE__*/V("initTranscoder"),ue=/*#__PURE__*/function(){function e(e){Object.defineProperty(this,de,{value:fe}),Object.defineProperty(this,re,{writable:!0,value:void 0}),Object.defineProperty(this,se,{writable:!0,value:void 0}),Object.defineProperty(this,ne,{writable:!0,value:void 0}),Object.defineProperty(this,oe,{writable:!0,value:void 0}),Object.defineProperty(this,he,{writable:!0,value:void 0}),Object.defineProperty(this,ae,{writable:!0,value:void 0}),Object.defineProperty(this,le,{writable:!0,value:void 0}),Object.defineProperty(this,ce,{writable:!0,value:void 0}),W(this,re)[re]=e.transcoderPath||"https://cdn.jsdelivr.net/npm/@xeokit/sdk/dist/basis/",W(this,se)[se]=null,W(this,ne)[ne]=null,W(this,oe)[oe]=new K,W(this,he)[he]="",e.workerLimit&&W(this,oe)[oe].setWorkerLimit(e.workerLimit),W(this,ae)[ae]=null,W(this,ce)[ce]=!1,W(this,le)[le]=["xkt2"]}var t=e.prototype;return t.init=function(e){W(this,ae)[ae]={astcSupported:e.astcSupported,etc1Supported:e.etc1Supported,etc2Supported:e.etc2Supported,dxtSupported:e.dxtSupported,bptcSupported:e.bptcSupported,pvrtcSupported:e.pvrtcSupported}},t.transcode=function(e,t){var i=this;return void 0===t&&(t={}),new Promise(function(r,s){var n=t;W(i,de)[de]().then(function(){return W(i,oe)[oe].postMessage({type:"transcode",buffers:e,taskConfig:n},e)}).then(function(e){var t=e.data,i=t.mipmaps,n=t.format,o=t.dfdTransferFn,h=t.dfdFlags;if("error"===t.type)return s(t.error);r({mipmaps:i,props:{format:n,minFilter:1===i.length?1006:1008,magFilter:1===i.length?1006:1008,encoding:2===o?3001:3e3,premultiplyAlpha:!!(1&h)}})})})},t.destroy=function(){URL.revokeObjectURL(W(this,he)[he]),W(this,oe)[oe].destroy(),J--},e}();function fe(){var e=this;if(!W(this,ne)[ne]){var t=new Q;t.setPath(W(this,re)[re]),t.setWithCredentials(W(this,ce)[ce]);var i=t.loadAsync("basis_transcoder.js"),r=new Q;r.setPath(W(this,re)[re]),r.setResponseType("arraybuffer"),r.setWithCredentials(W(this,ce)[ce]);var s=r.loadAsync("basis_transcoder.wasm");W(this,ne)[ne]=Promise.all([i,s]).then(function(t){var i=t[0],r=t[1],s=pe.toString(),n=["/* constants */","let _EngineFormat = "+JSON.stringify(ie),"let _TranscoderFormat = "+JSON.stringify(te),"let _BasisFormat = "+JSON.stringify(ee),"/* basis_transcoder.js */",i,"/* worker */",s.substring(s.indexOf("{")+1,s.lastIndexOf("}"))].join("\n");W(e,he)[he]=URL.createObjectURL(new Blob([n])),W(e,se)[se]=r,W(e,oe)[oe].setWorkerCreator(function(){var t=new Worker(W(e,he)[he]),i=W(e,se)[se].slice(0);return t.postMessage({type:"init",config:W(e,ae)[ae],transcoderBinary:i},[i]),t})}),J>0&&console.warn("KTX2TextureTranscoder: Multiple active KTX2TextureTranscoder may cause performance issues. Use a single KTX2TextureTranscoder instance, or call .dispose() on old instances."),J++}return W(this,ne)[ne]}var pe=function(){var e,t,i,r=_EngineFormat,s=_TranscoderFormat,n=_BasisFormat;self.addEventListener("message",function(o){var c,d=o.data;switch(d.type){case"init":e=d.config,c=d.transcoderBinary,t=new Promise(function(e){i={wasmBinary:c,onRuntimeInitialized:e},BASIS(i)}).then(function(){i.initializeBasis(),void 0===i.KTX2File&&console.warn("KTX2TextureTranscoder: Please update Basis Universal transcoder.")});break;case"transcode":t.then(function(){try{for(var t=function(t){var o=new i.KTX2File(new Uint8Array(t));function c(){o.close(),o.delete()}if(!o.isValid())throw c(),new Error("KTX2TextureTranscoder: Invalid or unsupported .ktx2 file");var d=o.isUASTC()?n.UASTC_4x4:n.ETC1S,u=o.getWidth(),f=o.getHeight(),p=o.getLevels(),g=o.getHasAlpha(),v=o.getDFDTransferFunc(),m=o.getDFDFlags(),E=function(t,i,o,c){for(var d=t===n.ETC1S?h:a,u=0;u<d.length;u++){var f=d[u];if(e[f.if]&&f.basisFormat.includes(t)&&!(c&&f.transcoderFormat.length<2)&&(!f.needsPowerOfTwo||l(i)&&l(o)))return{transcoderFormat:f.transcoderFormat[c?1:0],engineFormat:f.engineFormat[c?1:0]}}return console.warn("KTX2TextureTranscoder: No suitable compressed texture format found. Decoding to RGBA32."),{transcoderFormat:s.RGBA32,engineFormat:r.RGBAFormat}}(d,u,f,g),T=E.transcoderFormat,b=E.engineFormat;if(!u||!f||!p)throw c(),new Error("KTX2TextureTranscoder: Invalid texture");if(!o.startTranscoding())throw c(),new Error("KTX2TextureTranscoder: .startTranscoding failed");for(var x=[],w=0;w<p;w++){var _=o.getImageLevelInfo(w,0,0),y=_.origWidth,M=_.origHeight,P=new Uint8Array(o.getImageTranscodedSizeInBytes(w,0,0,T));if(!o.transcodeImage(P,w,0,0,T,0,-1,-1))throw c(),new Error("KTX2TextureTranscoder: .transcodeImage failed.");x.push({data:P,width:y,height:M})}return c(),{width:u,height:f,hasAlpha:g,mipmaps:x,format:b,dfdTransferFn:v,dfdFlags:m}}(d.buffers[0]),o=t.width,c=t.height,u=t.hasAlpha,f=t.mipmaps,p=t.format,g=t.dfdTransferFn,v=t.dfdFlags,m=[],E=0;E<f.length;++E)m.push(f[E].data.buffer);self.postMessage({type:"transcode",id:d.id,width:o,height:c,hasAlpha:u,mipmaps:f,format:p,dfdTransferFn:g,dfdFlags:v},m)}catch(e){console.error("[BasisWorker]: "+e),self.postMessage({type:"error",id:d.id,error:e.message})}})}});var o=[{if:"astcSupported",basisFormat:[n.UASTC_4x4],transcoderFormat:[s.ASTC_4x4,s.ASTC_4x4],engineFormat:[r.RGBA_ASTC_4x4_Format,r.RGBA_ASTC_4x4_Format],priorityETC1S:Infinity,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[s.BC7_M5,s.BC7_M5],engineFormat:[r.RGBA_BPTC_Format,r.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[s.BC1,s.BC3],engineFormat:[r.RGB_S3TC_DXT1_Format,r.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[s.ETC1,s.ETC2],engineFormat:[r.RGB_ETC2_Format,r.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[s.ETC1],engineFormat:[r.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[s.PVRTC1_4_RGB,s.PVRTC1_4_RGBA],engineFormat:[r.RGB_PVRTC_4BPPV1_Format,r.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],h=o.sort(function(e,t){return e.priorityETC1S-t.priorityETC1S}),a=o.sort(function(e,t){return e.priorityUASTC-t.priorityUASTC});function l(e){return e<=2||0==(e&e-1)&&0!==e}};class ge{constructor(e,t,i){this.viewer=void 0,this.view=void 0,this.gl=void 0,this.viewMatrixDataTexture=void 0,this.pbrEnabled=void 0,this.withSAO=void 0,this.backfaces=void 0,this.frontface=void 0,this.textureUnit=void 0,this.bindTexture=void 0,this.renderPass=void 0,this.shadowViewMatrix=void 0,this.shadowProjMatrix=void 0,this.pickViewMatrix=void 0,this.pickProjMatrix=void 0,this.pickZNear=void 0,this.pickZFar=void 0,this.pickInvisible=void 0,this.lineWidth=void 0,this.lastProgramId=void 0,this.occlusionTexture=void 0,this.viewer=e,this.view=t,this.gl=i,this.reset()}reset(){this.lastProgramId=-1,this.pbrEnabled=!1,this.withSAO=!1,this.backfaces=!1,this.frontface=!0,this.textureUnit=0,this.shadowViewMatrix=null,this.shadowProjMatrix=null,this.pickViewMatrix=null,this.pickProjMatrix=null,this.pickZNear=.01,this.pickZFar=5e3,this.pickInvisible=!1,this.lineWidth=1,this.occlusionTexture=null}get nextTextureUnit(){const e=this.textureUnit;return this.textureUnit=(this.textureUnit+1)%b.MAX_TEXTURE_UNITS,e}}function ve(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,"symbol"==typeof(s=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(r.key))?s:String(s),r)}var s}function me(e,t,i){return t&&ve(e.prototype,t),i&&ve(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function Ee(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,Te(e,t)}function Te(e,t){return Te=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},Te(e,t)}function be(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var xe=0;function we(e){return"__private_"+xe+++"_"+e}function _e(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}var ye=0;function Me(e){return"__private_"+ye+++"_"+e}function Pe(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}var Ce,Ie=/*#__PURE__*/Me("items"),Re=/*#__PURE__*/Me("lastUniqueId"),Se=/*#__PURE__*/function(){function e(e,t){Object.defineProperty(this,Ie,{writable:!0,value:void 0}),Object.defineProperty(this,Re,{writable:!0,value:void 0}),Pe(this,Ie)[Ie]=e||[],Pe(this,Re)[Re]=(t||0)+1}var t=e.prototype;return t.addItem=function(){var e;if(2===arguments.length){var t=arguments[0];if(e=arguments[1],Pe(this,Ie)[Ie][t])throw"ID clash: '"+t+"'";return Pe(this,Ie)[Ie][t]=e,t}for(e=arguments[0]||{};;){var i=Pe(this,Re)[Re]++;if(!Pe(this,Ie)[Ie][i])return Pe(this,Ie)[Ie][i]=e,i}},t.removeItem=function(e){var t=Pe(this,Ie)[Ie][e];return delete Pe(this,Ie)[Ie][e],t},e}(),Oe=/*#__PURE__*/function(){function e(){this._head=void 0,this._headLength=void 0,this._tail=void 0,this._index=void 0,this._length=void 0,this._head=[],this._headLength=0,this._tail=[],this._index=0,this._length=0}var t,i,r=e.prototype;return r.shift=function(){if(this._index>=this._headLength){var e=this._head;if(e.length=0,this._head=this._tail,this._tail=e,this._index=0,this._headLength=this._head.length,!this._headLength)return}var t=this._head[this._index];return this._index<0?delete this._head[this._index++]:this._head[this._index++]=void 0,this._length--,t},r.push=function(e){return this._length++,this._tail.push(e),this},r.unshift=function(e){return this._head[--this._index]=e,this._length++,this},r.clear=function(){this._head=[],this._headLength=0,this._tail=[],this._index=0,this._length=0},t=e,(i=[{key:"length",get:function(){return this._length}}])&&function(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,"symbol"==typeof(s=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(r.key))?s:String(s),r)}var s}(t.prototype,i),Object.defineProperty(t,"prototype",{writable:!1}),e}();function De(e){return new FloatArrayClass(e||4)}function Ae(e){return I(e||16)}[["0",10],["A",26],["a",26],["_",1],["$",1]].map(function(e){for(var t=[],i=e[0].charCodeAt(0),r=i+e[1],s=i;s<r;++s)t.push(s);return String.fromCharCode.apply(null,t)}).join(""),function(){for(var e=[],t=0;t<256;t++)e[t]=(t<16?"0":"")+t.toString(16)}(),De(),De(),new FloatArrayClass(2),Ae(),Ae(),I(3),Ae(),I(3),(Ce={})[4e5]={abbrev:"m"},Ce[400001]={abbrev:"cm"},Ce[400002]={abbrev:"mm"},Ce[400003]={abbrev:"yd"},Ce[400004]={abbrev:"ft"},Ce[400005]={abbrev:"in"},Ae(),I(3),I(3),I(3),I(3),I(3),I(3),I(3),Ae(),Ae();var Be={viewerId:"",time:0,startTime:0,prevTime:0,deltaTime:0},Le=/*#__PURE__*/we("viewersRenderInfo"),Ue=/*#__PURE__*/we("viewerIDMap"),Fe=/*#__PURE__*/we("taskQueue"),je=/*#__PURE__*/we("taskBudget"),Ge=/*#__PURE__*/we("lastTime"),Ne=/*#__PURE__*/we("elapsedTime"),ke=/*#__PURE__*/we("runTasks"),He=/*#__PURE__*/we("runTasksUntil"),Xe=/*#__PURE__*/we("fireTickEvents"),Ve=/*#__PURE__*/we("renderViewers");function We(e){_e(this,He)[He](e+_e(this,je)[je]),this.getNumTasks(),_e(this,je)}function ze(e){void 0===e&&(e=-1);for(var t=(new Date).getTime(),i=0;_e(this,Fe)[Fe].length>0&&(e<0||t<e);){var r=_e(this,Fe)[Fe].shift(),s=_e(this,Fe)[Fe].shift();s?r.call(s):r(),t=(new Date).getTime(),i++}return i}function $e(e){for(var t in Be.time=e,Ye.viewers)if(this.viewers.hasOwnProperty(t)){var i=this.viewers[t];Be.viewerId=t,Be.startTime=i.startTime,Be.deltaTime=null!=Be.prevTime?Be.time-Be.prevTime:0,i.onTick.dispatch(i,Be)}Be.prevTime=e}function qe(){for(var e in this.viewers)if(this.viewers.hasOwnProperty(e)){var t=this.viewers[e],i=_e(this,Le)[Le][e];i||(i=_e(this,Le)[Le][e]={}),t.render({})}}var Ye=new(/*#__PURE__*/function(){function e(){var e=this;Object.defineProperty(this,Ve,{value:qe}),Object.defineProperty(this,Xe,{value:$e}),Object.defineProperty(this,He,{value:ze}),Object.defineProperty(this,ke,{value:We}),this.viewers=void 0,Object.defineProperty(this,Le,{writable:!0,value:{}}),Object.defineProperty(this,Ue,{writable:!0,value:new Se}),Object.defineProperty(this,Fe,{writable:!0,value:new Oe}),Object.defineProperty(this,je,{writable:!0,value:10}),Object.defineProperty(this,Ge,{writable:!0,value:0}),Object.defineProperty(this,Ne,{writable:!0,value:0}),this.viewers={},requestAnimationFrame(function t(){var i=Date.now();_e(e,Ge)[Ge]>0&&(_e(e,Ne)[Ne]=i-_e(e,Ge)[Ge]),_e(e,ke)[ke](i),_e(e,Xe)[Xe](i),_e(e,Ve)[Ve](),_e(e,Ge)[Ge]=i,requestAnimationFrame(t)})}var t=e.prototype;return t.registerViewer=function(e){if(e.id){if(this.viewers[e.id])return void console.error("[ERROR] Viewer "+function(e){return function(e){return!isNaN(parseFloat(e))&&isFinite(e)}(e)?""+e:"'"+e+"'"}(e.id)+" already exists")}else e.id=_e(this,Ue)[Ue].addItem({});this.viewers[e.id]=e,_e(this,Le)[Le][e.id]={}},t.deregisterViewer=function(e){this.viewers[e.id]&&(_e(this,Ue)[Ue].removeItem(e.id),delete this.viewers[e.id],delete _e(this,Le)[Le][e.id])},t.scheduleTask=function(e,t){_e(this,Fe)[Fe].push(e),_e(this,Fe)[Fe].push(t)},t.getNumTasks=function(){return _e(this,Fe)[Fe].length},e}()),Ke=/*#__PURE__*/we("state"),Ze=/*#__PURE__*/function(e){function t(t,i){var r;return void 0===i&&(i={}),(r=e.call(this,t,i)||this).view=void 0,Object.defineProperty(be(r),Ke,{writable:!0,value:void 0}),r.view=t,_e(be(r),Ke)[Ke]={type:"ambient",color:new Float32Array(i.color||[.7,.7,.7]),intensity:null!=i.intensity?i.intensity:1},r.view.registerLight(be(r)),r}return Ee(t,e),t.prototype.destroy=function(){e.prototype.destroy.call(this),this.view.deregisterLight(this)},me(t,[{key:"color",get:function(){return _e(this,Ke)[Ke].color},set:function(e){_e(this,Ke)[Ke].color.set(e),this.view.redraw()}},{key:"intensity",get:function(){return _e(this,Ke)[Ke].intensity},set:function(e){_e(this,Ke)[Ke].intensity=void 0!==e?e:1,this.view.redraw()}}]),t}(M),Qe=/*#__PURE__*/we("state"),Je=/*#__PURE__*/function(e){function t(t,i){var r;return void 0===i&&(i={}),(r=e.call(this,t,i)||this).view=void 0,Object.defineProperty(be(r),Qe,{writable:!0,value:void 0}),r.view=t,_e(be(r),Qe)[Qe]={type:"dir",dir:new Float32Array(i.dir||[1,1,1]),color:new Float32Array(i.color||[.7,.7,.8]),intensity:null!=i.intensity?i.intensity:1,space:i.space||"view"},r.view.registerLight(be(r)),r}return Ee(t,e),t.prototype.destroy=function(){e.prototype.destroy.call(this),this.view.deregisterLight(this),this.view.redraw()},me(t,[{key:"dir",get:function(){return _e(this,Qe)[Qe].dir},set:function(e){_e(this,Qe)[Qe].dir.set(e),this.view.redraw()}},{key:"color",get:function(){return _e(this,Qe)[Qe].color},set:function(e){_e(this,Qe)[Qe].color.set(e),this.view.redraw()}},{key:"intensity",get:function(){return _e(this,Qe)[Qe].intensity},set:function(e){_e(this,Qe)[Qe].intensity=e,this.view.redraw()}}]),t}(M),et=/*#__PURE__*/we("state"),tt=/*#__PURE__*/function(e){function t(t,i){var r;return void 0===i&&(i={}),(r=e.call(this,t,i)||this).view=void 0,Object.defineProperty(be(r),et,{writable:!0,value:void 0}),r.view=t,_e(be(r),et)[et]={type:"point",pos:new Float64Array(i.pos||[1,1,1]),color:new Float32Array(i.color||[.7,.7,.8]),intensity:1,attenuation:new Float32Array([i.constantAttenuation,i.linearAttenuation,i.quadraticAttenuation]),space:i.space||"view"},r.view.registerLight(be(r)),r}return Ee(t,e),t.prototype.destroy=function(){e.prototype.destroy.call(this),this.view.deregisterLight(this),this.view.redraw()},me(t,[{key:"pos",get:function(){return _e(this,et)[et].pos},set:function(e){_e(this,et)[et].pos.set(e||[1,1,1]),this.view.redraw()}},{key:"color",get:function(){return _e(this,et)[et].color},set:function(e){_e(this,et)[et].color.set(e||[.7,.7,.8]),this.view.redraw()}},{key:"intensity",get:function(){return _e(this,et)[et].intensity},set:function(e){e!==_e(this,et)[et].intensity&&(_e(this,et)[et].intensity=e,this.view.redraw())}},{key:"constantAttenuation",get:function(){return _e(this,et)[et].attenuation[0]},set:function(e){_e(this,et)[et].attenuation[0]=e,this.view.redraw()}},{key:"linearAttenuation",get:function(){return _e(this,et)[et].attenuation[1]},set:function(e){_e(this,et)[et].attenuation[1]=e,this.view.redraw()}},{key:"quadraticAttenuation",get:function(){return _e(this,et)[et].attenuation[2]},set:function(e){_e(this,et)[et].attenuation[2]=e,this.view.redraw()}}]),t}(M);const it={NOT_RENDERED:0,COLOR_OPAQUE:1,COLOR_TRANSPARENT:2,SILHOUETTE_HIGHLIGHTED:3,SILHOUETTE_SELECTED:4,SILHOUETTE_XRAYED:5,EDGES_COLOR_OPAQUE:6,EDGES_COLOR_TRANSPARENT:7,EDGES_HIGHLIGHTED:8,EDGES_SELECTED:9,EDGES_XRAYED:10,PICK:11},rt=e();var st=/*#__PURE__*/D("hash"),nt=/*#__PURE__*/D("program"),ot=/*#__PURE__*/D("needRebuild"),ht=/*#__PURE__*/D("uniforms"),at=/*#__PURE__*/D("samplers"),lt=/*#__PURE__*/D("build"),ct=/*#__PURE__*/D("buildShader"),dt=/*#__PURE__*/D("getValid"),ut=/*#__PURE__*/D("bind");class ft{constructor(e){Object.defineProperty(this,ut,{value:mt}),Object.defineProperty(this,dt,{value:vt}),Object.defineProperty(this,ct,{value:gt}),Object.defineProperty(this,lt,{value:pt}),this.errors=void 0,this.renderContext=void 0,Object.defineProperty(this,st,{writable:!0,value:void 0}),Object.defineProperty(this,nt,{writable:!0,value:void 0}),Object.defineProperty(this,ot,{writable:!0,value:void 0}),Object.defineProperty(this,ht,{writable:!0,value:void 0}),Object.defineProperty(this,at,{writable:!0,value:void 0}),this.renderContext=e,A(this,ot)[ot]=!0,A(this,lt)[lt]()}needRebuild(){A(this,ot)[ot]=!0}draw(e){if(A(this,nt)[nt]&&!A(this,dt)[dt]()&&(A(this,nt)[nt].destroy(),A(this,nt)[nt]=null),!A(this,nt)[nt]){if(A(this,lt)[lt](),this.errors)return;this.renderContext.lastProgramId=-1}const t=e.renderState,i=A(this,nt)[nt],r=this.renderContext,s=r.renderPass,n=this.renderContext.gl,o=this.renderContext.view,h=A(this,ht)[ht],a=A(this,at)[at];if(r.lastProgramId!==i.id&&(r.lastProgramId=i.id,A(this,ut)[ut]()),h.renderPass&&n.uniform1i(h.renderPass,s),h.projMatrix&&n.uniformMatrix4fv(h.projMatrix,!1,o.camera.projMatrix),h.worldMatrix&&n.uniformMatrix4fv(h.worldMatrix,!1,e.rendererModel.worldMatrix),h.color)if(s===it.SILHOUETTE_XRAYED){const e=o.xrayMaterial,t=e.fillColor;n.uniform4f(h.color,t[0],t[1],t[2],e.fillAlpha)}else if(s===it.SILHOUETTE_HIGHLIGHTED){const e=o.highlightMaterial,t=e.fillColor;n.uniform4f(h.color,t[0],t[1],t[2],e.fillAlpha)}else if(s===it.SILHOUETTE_SELECTED){const e=o.selectedMaterial,t=e.fillColor;n.uniform4f(h.color,t[0],t[1],t[2],e.fillAlpha)}else n.uniform4fv(h.color,new Float32Array([1,1,1]));a.viewMatrices&&t.dataTextureSet.viewMatrices.bindTexture(i,a.viewMatrices,r.nextTextureUnit),a.positions&&t.dataTextureSet.positions.bindTexture(i,a.positions,r.nextTextureUnit),a.eachMeshMatrices&&t.dataTextureSet.eachMeshMatrices.bindTexture(i,a.eachMeshMatrices,r.nextTextureUnit),a.eachMeshAttributes&&t.dataTextureSet.eachMeshAttributes.bindTexture(i,a.eachMeshAttributes,r.nextTextureUnit),a.eachPrimitiveMesh&&(t.numIndices8Bits>0&&(t.dataTextureSet.eachPrimitiveMesh_8Bits.bindTexture(i,a.eachPrimitiveMesh,r.nextTextureUnit),t.dataTextureSet.indices_8Bits.bindTexture(i,a.indices,r.nextTextureUnit),n.drawArrays(n.TRIANGLES,0,t.numIndices8Bits)),t.numIndices16Bits>0&&(t.dataTextureSet.eachPrimitiveMesh_16Bits.bindTexture(i,a.eachPrimitiveMesh,r.nextTextureUnit),t.dataTextureSet.indices_16Bits.bindTexture(i,a.indices,r.nextTextureUnit),n.drawArrays(n.TRIANGLES,0,t.numIndices16Bits)),t.numIndices32Bits>0&&(t.dataTextureSet.eachPrimitiveMesh_32Bits.bindTexture(i,a.eachPrimitiveMesh,r.nextTextureUnit),t.dataTextureSet.indices_32Bits.bindTexture(i,a.indices,r.nextTextureUnit),n.drawArrays(n.TRIANGLES,0,t.numIndices32Bits))),a.baseColorMap&&a.baseColorMap.bindTexture(t.materialTextureSet.colorTexture.texture2D,r.nextTextureUnit),a.metallicRoughMap&&a.metallicRoughMap.bindTexture(t.materialTextureSet.metallicRoughnessTexture.texture2D,r.nextTextureUnit),a.emissiveMap&&a.emissiveMap.bindTexture(t.materialTextureSet.emissiveTexture.texture2D,r.nextTextureUnit),a.occlusionMap&&a.occlusionMap.bindTexture(t.materialTextureSet.occlusionTexture.texture2D,r.nextTextureUnit)}get vertHeader(){return"#version 300 es\n                #ifdef GL_FRAGMENT_PRECISION_HIGH\n                precision highp float;\n                precision highp int;\n                precision highp usampler2D;\n                precision highp isampler2D;\n                precision highp sampler2D;\n                #else\n                precision mediump float;\n                precision mediump int;\n                precision mediump usampler2D;\n                precision mediump isampler2D;\n                precision mediump sampler2D;\n                uniform int renderPass;\n                #endif"}get vertDataTextureDefs(){return"uniform mediump sampler2D eachMeshMatrices;\n                uniform lowp usampler2D eachMeshAttributes;\n                uniform highp sampler2D eachMeshOffset;\n                uniform mediump usampler2D positions;\n                uniform highp usampler2D indices;\n                uniform mediump usampler2D eachPrimitiveMesh;\n                uniform highp sampler2D cameraMatrices;\n                uniform highp sampler2D sceneModelRendererMatrices;"}get vertLogDepthBufDefs(){return this.renderContext.view.logarithmicDepthBufferEnabled?"uniform float logDepthBufFC;\n                    out float fragDepth;\n                    bool isPerspectiveMatrix(mat4 m) {\n                        return (m[2][3] == - 1.0);\n                    }\n                    out float isPerspective;":""}get vertDataTextureSamples(){return""}get vertLogDepthBufOutputs(){return this.renderContext.view.logarithmicDepthBufferEnabled?"fragDepth = 1.0 + clipPos.w;\n                    isPerspective = float (isPerspectiveMatrix(projMatrix));":""}get fragmentShader(){return`${this.fragHeader}\n        ${this.fragGammaDefs}\n        ${this.fragSectionPlaneDefs}\n        ${this.fragLightDefs}\n        ${this.fragLogDepthBufDefs}\n        void main(void) {\n            ${this.fragSectionPlanesSlice}\n            ${this.fragLighting}\n            ${this.fragLogDepthBufOutput}\n        }`}get fragHeader(){return"#version 300 es\n        #ifdef GL_FRAGMENT_PRECISION_HIGH\n       precision highp float;\n        precision highp int;\n        #else\n        precision mediump float;\n        precision mediump int;\n        #endif"}get fragGammaDefs(){return'uniform float gammaFactor;\n        vec4 linearToLinear( in vec4 value ) {\n            return value;\n        }\n        vec4 sRGBToLinear( in vec4 value ) {\n            return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );\n        }\n        vec4 gammaToLinear( in vec4 value) {\n            return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );\n        }\n        vec4 linearToGamma( in vec4 value, in float gammaFactor ) {\n              return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );");\n        }'}get fragLightDefs(){const e=this.renderContext.view,t=[];t.push("uniform vec4 lightAmbient;");for(let i=0,r=e.lightsList.length;i<r;i++){const r=e.lightsList[i];"ambient"!==r.type&&(t.push("uniform vec4 lightColor"+i+";"),"dir"===r.type&&t.push("uniform vec3 lightDir"+i+";"),"point"===r.type&&t.push("uniform vec3 lightPos"+i+";"),"spot"===r.type&&(t.push("uniform vec3 lightPos"+i+";"),t.push("uniform vec3 lightDir"+i+";")))}return t.join("\n")}get fragLogDepthBufDefs(){return this.renderContext.view.logarithmicDepthBufferEnabled?"in float isPerspective;\n                    uniform float logDepthBufFC;\n                    in float fragDepth;":""}get fragLogDepthBufOutput(){return this.renderContext.view.logarithmicDepthBufferEnabled?"gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( fragDepth ) * logDepthBufFC * 0.5;":""}get fragLighting(){const e=[];e.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),e.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 0.0);"),e.push("vec3 viewNormal = normalize(vec4(viewNormalMatrix * worldNormal).xyz);"),e.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),e.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),e.push("float lambertian = 1.0;");for(let t=0,i=this.renderContext.view.lightsList.length;t<i;t++){const i=this.renderContext.view.lightsList[t];if("ambient"!==i.type){if("dir"===i.type)e.push("view"===i.space?"viewLightDir = normalize(lightDir"+t+");":"viewLightDir = normalize((viewMatrix * vec4(lightDir"+t+", 0.0)).xyz);");else if("point"===i.type)e.push("view"===i.space?"viewLightDir = -normalize(lightPos"+t+" - viewPosition.xyz);":"viewLightDir = -normalize((viewMatrix * vec4(lightPos"+t+", 0.0)).xyz);");else{if("spot"!==i.type)continue;e.push("view"===i.space?"viewLightDir = normalize(lightDir"+t+");":"viewLightDir = normalize((viewMatrix * vec4(lightDir"+t+", 0.0)).xyz);")}e.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),e.push("reflectedColor += lambertian * (lightColor"+t+".rgb * lightColor"+t+".a);")}}return e.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),e.push("meshColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),e.join("\n")}get fragSAOOutput(){return this.renderContext.view.sao.enabled?"float viewportWidth     = uSAOParams[0];\n                    float viewportHeight    = uSAOParams[1];\n                    float blendCutoff       = uSAOParams[2];\n                    float blendFactor       = uSAOParams[3];\n                    vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);\n                    float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;\n                    outColor                = vec4(fragColor.rgb * ambient, 1.0);":"outColor            = fragColor;"}get fragOutput(){return"outColor            = fragColor;"}get fragSectionPlaneDefs(){const e=[];e.push("in vec4 worldPosition;\n                  in vec4 meshFlags2;");for(let t=0,i=this.renderContext.view.sectionPlanesList.length;t<i;t++)e.push(`uniform bool sectionPlaneActive${t};\n                      uniform vec3 sectionPlanePos${t};\n                      uniform vec3 sectionPlaneDir${t};`);return e.join("\n")}get fragLightSourceUniforms(){const e=[];e.push("uniform vec4 lightAmbient;");for(let t=0,i=this.renderContext.view.lightsList.length;t<i;t++){const i=this.renderContext.view.lightsList[t];i instanceof Ze||(e.push(`uniform vec4 lightColor${t};`),i instanceof Je&&e.push(`uniform vec3 lightDir${t};`),i instanceof tt&&e.push(`uniform vec3 lightPos${t};`))}return e.join("\n")}get fragSectionPlanesSlice(){const e=[];if(this.renderContext.view.sectionPlanesList.length>0){e.push("bool clippable = (float(meshFlags2.x) > 0.0);\n                      if (clippable) {\n                          float dist = 0.0;");for(let t=0,i=this.renderContext.view.sectionPlanesList.length;t<i;t++)e.push(`if (sectionPlaneActive${t}) {\n                              dist += clamp(dot(-sectionPlaneDir${t}.xyz, worldPosition.xyz - sectionPlanePos${t}.xyz), 0.0, 1000.0);\n                          }`);e.push("if (dist > 0.0) { \n                          discard;\n                      }\n                  }")}return e.join("\n")}get fragFlatShading(){const e=[];return e.push(""),e.join("\n")}destroy(){A(this,nt)[nt]&&A(this,nt)[nt].destroy(),A(this,nt)[nt]=null}}function pt(){const e=this.renderContext.view,t=this.renderContext.gl;if(A(this,nt)[nt]=new x(t,A(this,ct)[ct]()),A(this,nt)[nt].errors)return void(this.errors=A(this,nt)[nt].errors);const i=A(this,nt)[nt];A(this,ht)[ht]={renderPass:i.getLocation("renderPass"),viewMatrix:i.getLocation("viewMatrix"),projMatrix:i.getLocation("projMatrix"),worldMatrix:i.getLocation("worldMatrix"),sao:i.getLocation("sao"),logDepthBufFC:i.getLocation("logDepthBufFC"),gammaFactor:i.getLocation("gammaFactor"),pointSize:i.getLocation("pointSize"),nearPlaneHeight:i.getLocation("nearPlaneHeight"),pointCloudIntensityRange:i.getLocation("pointCloudIntensityRange"),pickZNear:i.getLocation("pickZNear"),pickZFar:i.getLocation("pickZFar"),pickInvisible:i.getLocation("pickInvisible"),color:i.getLocation("color"),lightAmbient:i.getLocation("lightAmbient"),lights:[],sectionPlanes:[]};const r=A(this,ht)[ht],s=e.lightsList;for(let e=0,t=s.length;e<t;e++)switch(s[e].type){case"dir":r.lights.push({color:i.getLocation("lightColor"+e),dir:i.getLocation("lightDir"+e)});break;case"point":r.lights.push({color:i.getLocation("lightColor"+e),pos:i.getLocation("lightPos"+e),attenuation:i.getLocation("lightAttenuation"+e)});break;case"spot":r.lights.push({color:i.getLocation("lightColor"+e),pos:i.getLocation("lightPos"+e),dir:i.getLocation("lightDir"+e),attenuation:i.getLocation("lightAttenuation"+e)})}for(let t=0,s=e.sectionPlanesList.length;t<s;t++)r.sectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});A(this,at)[at]={viewMatrices:i.getSampler("viewMatrices"),positions:i.getSampler("positions"),indices:i.getSampler("indices"),edgeIndices:i.getSampler("edgeIndices"),eachMeshAttributes:i.getSampler("eachMeshAttributes"),eachMeshMatrices:i.getSampler("eachMeshMatrices"),eachEdgeOffset:i.getSampler("eachMeshOffset"),eachPrimitiveMesh:i.getSampler("eachMeshTriangleMesh"),eachEdgeMesh:i.getSampler("eachEdgeMesh"),baseColorMap:i.getSampler("baseColorMap"),metallicRoughMap:i.getSampler("metallicRoughMap"),emissiveMap:i.getSampler("emissiveMap"),normalMap:i.getSampler("normalMap"),occlusionMap:i.getSampler("occlusionMap")},A(this,st)[st]=this.getHash()}function gt(){return{vertex:this.buildVertexShader(),fragment:this.buildFragmentShader()}}function vt(){return!A(this,ot)[ot]||(A(this,ot)[ot]=!1,A(this,st)[st]===this.getHash())}function mt(){const e=this.renderContext.view,t=this.renderContext.gl,i=A(this,ht)[ht],r=e.camera.project;A(this,nt)[nt].bind(),i.lightAmbient&&t.uniform4fv(i.lightAmbient,e.getAmbientColorAndIntensity());for(let r=0,s=i.lights.length;r<s;r++){const s=i.lights[r],n=e.lightsList[r];s.color&&t.uniform4f(s.color,n.color[0],n.color[1],n.color[2],n.intensity),s.dir&&t.uniform3f(s.dir,n.dir[0],n.dir[1],n.dir[2]),s.pos&&t.uniform3f(s.pos,n.pos[0],n.pos[1],n.pos[2]),s.attenuation&&t.uniform1f(s.attenuation,n.attenuation)}if(i.sao){const r=e.sao;if(r.possible){const e=t.drawingBufferHeight;rt[0]=t.drawingBufferWidth,rt[1]=e,rt[2]=r.blendCutoff,rt[3]=r.blendFactor,t.uniform4fv(i.sao,rt)}}if(i.gammaFactor&&t.uniform1f(i.gammaFactor,e.gammaFactor),i.pointSize&&t.uniform1f(i.pointSize,e.pointsMaterial.pointSize),i.nearPlaneHeight&&t.uniform1f(i.nearPlaneHeight,500001===e.camera.projectionType?1:t.drawingBufferHeight/(2*Math.tan(.5*e.camera.perspectiveProjection.fov*Math.PI/180))),i.pickZNear&&(t.uniform1f(i.pickZNear,this.renderContext.pickZNear),t.uniform1f(i.pickZFar,this.renderContext.pickZFar)),i.pickInvisible&&t.uniform1i(i.pickInvisible,this.renderContext.pickInvisible?1:0),i.logDepthBufFC){const e=2/(Math.log(r.far+1)/Math.LN2);t.uniform1f(i.logDepthBufFC,e)}}class Et extends ft{constructor(e){super(e)}getHash(){return`${this.renderContext.view.getSectionPlanesHash()}-${this.renderContext.view.getLightsHash()}`}buildVertexShader(){return`${this.vertHeader}   \n        \n                uniform int                 renderPass;   \n            \n                uniform highp   mat4        projMatrix;\n                uniform highp   mat4        worldMatrix;\n                      \n                uniform mediump sampler2D   viewMatrices;\n                           \n                uniform mediump usampler2D  eachPrimitiveMesh;\n                uniform lowp    usampler2D  eachMeshAttributes;\n                \n                uniform mediump sampler2D   eachMeshMatrices;\n                uniform mediump usampler2D  positions;\n                uniform highp   usampler2D  indices;\n                \n                uniform  float  logDepthBufFC;\n                 \n                out vec4        worldPosition;\n                flat out uint   meshFlags2r;                       \n                flat out uvec4  meshColor;\n                out float       fragDepth;\n                \n                bool isPerspectiveMatrix(mat4 m) {\n                    return (m[2][3] == - 1.0);\n                }\n                \n                out float isPerspective;\n                    \n                void main(void) {\n                                   \n                    int triangleIndex      = gl_VertexID / 3;\n                    \n                    int hPackedMeshIdIndex = (triangleIndex >> 3) & 1023;\n                    int vPackedMeshIdIndex = (triangleIndex >> 3) >> 10;\n                    \n                    int meshIndex          = int(texelFetch(eachPrimitiveMesh, ivec2(hPackedMeshIdIndex, vPackedMeshIdIndex), 0).r);                   \n                    uvec4 meshFlags        = texelFetch (eachMeshAttributes, ivec2(2, meshIndex), 0);\n\n                    if (int(meshFlags.x) != renderPass) {\n                        gl_Position = vec4(3.0, 3.0, 3.0, 1.0);\n                        return;\n                    } \n                 \n                    uvec4 meshFlags2 = texelFetch (eachMeshAttributes, ivec2(3, meshIndex), 0);\n\n                    ivec4 packedVertexBase = ivec4(texelFetch (eachMeshAttributes, ivec2(4, meshIndex), 0));\n                    ivec4 packedIndexBaseOffset = ivec4(texelFetch (eachMeshAttributes, ivec2(5, meshIndex), 0));\n                    int indexBaseOffset =   (packedIndexBaseOffset.r << 24) + \n                                            (packedIndexBaseOffset.g << 16) + \n                                            (packedIndexBaseOffset.b << 8) + \n                                            (packedIndexBaseOffset.a);\n\n                    int hIndex = (triangleIndex - indexBaseOffset) & 1023;\n                    int vIndex = (triangleIndex - indexBaseOffset) >> 10;\n\n                    ivec3 vertexIndices = ivec3(texelFetch(indices, ivec2(hIndex, vIndex), 0));\n                    ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;\n\n                    ivec3 indexPositionH = uniqueVertexIndexes & 1023;\n                    ivec3 indexPositionV = uniqueVertexIndexes >> 10;\n\n                    mat4 positionsDecompressMatrix = mat4 (\n                        texelFetch (eachMeshMatrices, ivec2(0, meshIndex), 0), \n                        texelFetch (eachMeshMatrices, ivec2(1, meshIndex), 0), \n                        texelFetch (eachMeshMatrices, ivec2(2, meshIndex), 0), \n                        texelFetch (eachMeshMatrices, ivec2(3, meshIndex), 0));\n                        \n                    mat4 meshMatrix = mat4 (\n                        texelFetch (eachMeshMatrices, ivec2(4, meshIndex), 0), \n                        texelFetch (eachMeshMatrices, ivec2(5, meshIndex), 0), \n                        texelFetch (eachMeshMatrices, ivec2(6, meshIndex), 0), \n                        texelFetch (eachMeshMatrices, ivec2(7, meshIndex), 0));\n\n                    ivec4 packedViewMatrixIndex = ivec4(texelFetch (eachMeshAttributes, ivec2(7, meshIndex), 0));\n                    int viewMatrixIndex = \n                            (packedViewMatrixIndex.r << 24) + \n                            (packedViewMatrixIndex.g << 16) + \n                            (packedViewMatrixIndex.b << 8) + \n                            (packedViewMatrixIndex.a);\n                   \n                    mat4 viewMatrix = mat4 (\n                        texelFetch (viewMatrices, ivec2(4, viewMatrixIndex), 0), \n                        texelFetch (viewMatrices, ivec2(5, viewMatrixIndex), 0), \n                        texelFetch (viewMatrices, ivec2(6, viewMatrixIndex), 0), \n                        texelFetch (viewMatrices, ivec2(7, viewMatrixIndex), 0));\n\n                    vec3 _positions[3];\n                   \n                    _positions[0] = vec3(texelFetch(positions, ivec2(indexPositionH.r, indexPositionV.r), 0));\n                    _positions[1] = vec3(texelFetch(positions, ivec2(indexPositionH.g, indexPositionV.g), 0));\n                    _positions[2] = vec3(texelFetch(positions, ivec2(indexPositionH.b, indexPositionV.b), 0));\n  \n                    vec3  position       = _positions[gl_VertexID % 3];\n                   \n                    vec4  _worldPosition = worldMatrix * ((meshMatrix * positionsDecompressMatrix) * vec4(position, 1.0)); \n                    vec4  viewPosition   = viewMatrix * _worldPosition;                   \n                    vec4  clipPosition   = projMatrix * viewPosition;\n\n                    meshFlags2r     = meshFlags2.r;                     \n                    meshColor       = texelFetch (eachMeshAttributes, ivec2(0, meshIndex), 0);                          \n                    fragDepth       = 1.0 + clipPosition.w;\n                    isPerspective   = float (isPerspectiveMatrix(projMatrix));\n                    worldPosition   = _worldPosition;                                               \n                    \n                    gl_Position     = clipPosition;\n                }`}buildFragmentShader(){return`${this.fragHeader}                        \n    \n             flat   in uvec4    meshColor;\n                in float        fragDepth;\n                in float        isPerspective;    \n                flat in uint    meshFlags2r;        \n                uniform float   logDepthBufFC;                        \n    \n                ${this.fragSectionPlaneDefs}                  \n                ${this.fragLightSourceUniforms}                                                             \n    \n                out vec4 outColor;        \n    \n                void main(void) {         \n                \n                // src.push("float lambertian = 1.0;");\n                // \n                //  vec3 xTangent = dFdx( vViewPosition.xyz );\n                //  vec3 yTangent = dFdy( vViewPosition.xyz );\n                // \n                //  vec3 viewNormal = normalize( cross( xTangent, yTangent ) );        \n    \n                    ${this.fragSectionPlanesSlice}                                    \n                    ${this.fragFlatShading}     \n          \n                    outColor = vec4(meshColor);                   \n                    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( fragDepth ) * logDepthBufFC * 0.5;                        \n                }`}}function Tt(e){return new Float64Array(e||6)}function bt(e=Tt()){return e[0]=R,e[1]=R,e[2]=R,e[3]=S,e[4]=S,e[5]=S,e}function xt(e,t){return e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]>t[2]&&(e[2]=t[2]),e[3]<t[3]&&(e[3]=t[3]),e[4]<t[4]&&(e[4]=t[4]),e[5]<t[5]&&(e[5]=t[5]),e}function wt(e,t){return e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]>t[2]&&(e[2]=t[2]),e[3]<t[0]&&(e[3]=t[0]),e[4]<t[1]&&(e[4]=t[1]),e[5]<t[2]&&(e[5]=t[2]),e}t(),t(),i(),i(),h(),h(),t(),I(3),I(3),I(3),I(3),I(3),I(3),I(3);var _t=/*#__PURE__*/D("built");class yt{constructor(){this.positions=void 0,this.indices_8Bits=void 0,this.indices_16Bits=void 0,this.indices_32Bits=void 0,this.edgeIndices_8Bits=void 0,this.edgeIndices_16Bits=void 0,this.edgeIndices_32Bits=void 0,this.indices=void 0,this.edgeIndices=void 0,this.eachMeshAttributes=void 0,this.eachMeshMatrices=void 0,this.eachEdgeOffset=void 0,this.eachPrimitiveMesh_8Bits=void 0,this.eachPrimitiveMesh_16Bits=void 0,this.eachPrimitiveMesh_32Bits=void 0,this.eachPrimitiveMesh=void 0,this.eachEdgeMesh_8Bits=void 0,this.eachEdgeMesh_16Bits=void 0,this.eachEdgeMesh_32Bits=void 0,this.eachEdgeMesh=void 0,Object.defineProperty(this,_t,{writable:!0,value:void 0}),this.positions=null,this.indices_8Bits=null,this.indices_16Bits=null,this.indices_32Bits=null,this.edgeIndices_8Bits=null,this.edgeIndices_16Bits=null,this.edgeIndices_32Bits=null,this.eachMeshAttributes=null,this.eachMeshMatrices=null,this.eachPrimitiveMesh_8Bits=null,this.eachPrimitiveMesh_16Bits=null,this.eachPrimitiveMesh_32Bits=null,this.eachEdgeMesh_8Bits=null,this.eachEdgeMesh_16Bits=null,this.eachEdgeMesh_32Bits=null,this.eachEdgeOffset=null,A(this,_t)[_t]=!1}build(){this.indices={8:this.indices_8Bits,16:this.indices_16Bits,32:this.indices_32Bits},this.eachPrimitiveMesh={8:this.eachPrimitiveMesh_8Bits,16:this.eachPrimitiveMesh_16Bits,32:this.eachPrimitiveMesh_32Bits},this.edgeIndices={8:this.edgeIndices_8Bits,16:this.edgeIndices_16Bits,32:this.edgeIndices_32Bits},this.eachEdgeMesh={8:this.eachEdgeMesh_8Bits,16:this.eachEdgeMesh_16Bits,32:this.eachEdgeMesh_32Bits},A(this,_t)[_t]=!0}destroy(){this.positions&&this.positions.destroy(),this.indices_8Bits&&this.indices_8Bits.destroy(),this.indices_16Bits&&this.indices_16Bits.destroy(),this.indices_32Bits&&this.indices_32Bits.destroy(),this.edgeIndices_8Bits&&this.edgeIndices_8Bits.destroy(),this.edgeIndices_16Bits&&this.edgeIndices_16Bits.destroy(),this.edgeIndices_32Bits&&this.edgeIndices_32Bits.destroy(),this.eachMeshMatrices&&this.eachMeshMatrices.destroy(),this.eachMeshAttributes&&this.eachMeshAttributes.destroy(),this.eachEdgeOffset&&this.eachEdgeOffset.destroy(),this.eachPrimitiveMesh_8Bits&&this.eachPrimitiveMesh_8Bits.destroy(),this.eachPrimitiveMesh_16Bits&&this.eachPrimitiveMesh_16Bits.destroy(),this.eachPrimitiveMesh_32Bits&&this.eachPrimitiveMesh_32Bits.destroy(),this.eachEdgeMesh_8Bits&&this.eachEdgeMesh_8Bits.destroy(),this.eachEdgeMesh_16Bits&&this.eachEdgeMesh_16Bits.destroy(),this.eachEdgeMesh_32Bits&&this.eachEdgeMesh_32Bits.destroy()}}class Mt{constructor(){this.numMeshes=void 0,this.numVisible=void 0,this.numTransparent=void 0,this.numEdges=void 0,this.numXRayed=void 0,this.numSelected=void 0,this.numHighlighted=void 0,this.numClippable=void 0,this.numPickable=void 0,this.numCulled=void 0,this.reset()}reset(){this.numMeshes=0,this.numVisible=0,this.numTransparent=0,this.numEdges=0,this.numXRayed=0,this.numSelected=0,this.numHighlighted=0,this.numClippable=0,this.numPickable=0,this.numCulled=0}}const Pt={VISIBLE:1,CULLED:4,PICKABLE:8,CLIPPABLE:16,COLLIDABLE:32,CAST_SHADOW:64,RECEIVE_SHADOW:128,XRAYED:256,HIGHLIGHTED:512,SELECTED:1024,EDGES:2048,BACKFACES:4096,TRANSPARENT:8192};function Ct(e){return(t,...i)=>Rt(e,t,i)}function It(e,t){return Ct(At(e,t).get)}const{apply:Rt,construct:St,defineProperty:Ot,get:Dt,getOwnPropertyDescriptor:At,getPrototypeOf:Bt,has:Lt,ownKeys:Ut,set:Ft,setPrototypeOf:jt}=Reflect,Gt=Proxy,Nt=Number,{isFinite:kt,isNaN:Ht}=Nt,{iterator:Xt,species:Vt,toStringTag:Wt,for:zt}=Symbol,$t=Object,{create:qt,defineProperty:Yt,freeze:Kt,is:Zt}=$t,Qt=$t.prototype,Jt=Ct(Qt.isPrototypeOf),ei=$t.hasOwn||Ct(Qt.hasOwnProperty),ti=Array,ii=ti.isArray,ri=ti.prototype,si=Ct(ri.join),ni=Ct(ri.push),oi=Ct(ri.toLocaleString),hi=ri[Xt],ai=Ct(hi),li=Math.trunc,ci=ArrayBuffer,di=ci.isView,ui=Ct(ci.prototype.slice),fi=It(ci.prototype,"byteLength"),pi="undefined"!=typeof SharedArrayBuffer?SharedArrayBuffer:null,gi=pi&&It(pi.prototype,"byteLength"),vi=Bt(Uint8Array),mi=vi.from,Ei=vi.prototype,Ti=Ei[Xt],bi=Ct(Ei.keys),xi=Ct(Ei.values),wi=Ct(Ei.entries),_i=Ct(Ei.set),yi=Ct(Ei.reverse),Mi=Ct(Ei.fill),Pi=Ct(Ei.copyWithin),Ci=Ct(Ei.sort),Ii=Ct(Ei.slice),Ri=Ct(Ei.subarray),Si=It(Ei,"buffer"),Oi=It(Ei,"byteOffset"),Di=It(Ei,"length"),Ai=It(Ei,Wt),Bi=Uint16Array,Li=(...e)=>Rt(mi,Bi,e),Ui=Uint32Array,Fi=Float32Array,ji=Bt([][Xt]()),Gi=Ct(ji.next),Ni=Ct(function*(){}().next),ki=Bt(ji),Hi=TypeError,Xi=RangeError,Vi=Set,Wi=Vi.prototype,zi=Ct(Wi.add),$i=Ct(Wi.has),qi=WeakMap,Yi=qi.prototype,Ki=Ct(Yi.get),Zi=Ct(Yi.has),Qi=Ct(Yi.set),Ji=new ci(4),er=new Fi(Ji),tr=new Ui(Ji),ir=new Ui(512),rr=new Ui(512);for(let e=0;e<256;++e){const t=e-127;t<-27?(ir[e]=0,ir[256|e]=32768,rr[e]=24,rr[256|e]=24):t<-14?(ir[e]=1024>>-t-14,ir[256|e]=1024>>-t-14|32768,rr[e]=-t-1,rr[256|e]=-t-1):t<=15?(ir[e]=t+15<<10,ir[256|e]=t+15<<10|32768,rr[e]=13,rr[256|e]=13):t<128?(ir[e]=31744,ir[256|e]=64512,rr[e]=24,rr[256|e]=24):(ir[e]=31744,ir[256|e]=64512,rr[e]=13,rr[256|e]=13)}function sr(e){er[0]=e;const t=tr[0],i=t>>23&511;return ir[i]+((8388607&t)>>rr[i])}const nr=new Ui(2048),or=new Ui(64),hr=new Ui(64);nr[0]=0;for(let e=1;e<1024;++e){let t=e<<13,i=0;for(;0==(8388608&t);)i-=8388608,t<<=1;t&=-8388609,i+=947912704,nr[e]=t|i}for(let e=1024;e<2048;++e)nr[e]=939524096+(e-1024<<13);or[0]=0;for(let e=1;e<31;++e)or[e]=e<<23;or[31]=1199570944,or[32]=2147483648;for(let e=33;e<63;++e)or[e]=2147483648+(e-32<<23);or[63]=3347054592,hr[0]=0;for(let e=1;e<64;++e)hr[e]=32===e?0:1024;function ar(e){const t=e>>10;return tr[0]=nr[hr[t]+(1023&e)]+or[t],er[0]}function lr(e){if(e[Xt]===hi)return e;const t=ai(e);return qt(null,{next:{value:function(){return Gi(t)}},[Xt]:{value:function(){return this}}})}const cr=new qi,dr=qt(ki,{next:{value:function(){const e=Ki(cr,this);return Ni(e)},writable:!0,configurable:!0},[Wt]:{value:"Array Iterator",configurable:!0}});function ur(e){const t=qt(dr);return Qi(cr,t,e),t}function fr(e){return null!==e&&"object"==typeof e||"function"==typeof e}function pr(e){return null!==e&&"object"==typeof e}function gr(e){return void 0!==Ai(e)}function vr(e){const t=Ai(e);return"BigInt64Array"===t||"BigUint64Array"===t}function mr(e){if(null===pi)return!1;try{return gi(e),!0}catch(e){return!1}}function Er(e){return!!ii(e)&&(e[Xt]===hi||"Array Iterator"===e[Xt]()[Wt])}function Tr(e){if("string"!=typeof e)return!1;const t=Nt(e);return e===t+""&&!!kt(t)&&t===li(t)}const br=Nt.MAX_SAFE_INTEGER;function xr(e){if("bigint"==typeof e)throw Hi("Cannot convert a BigInt value to a number");const t=Nt(e);return Ht(t)||0===t?0:li(t)}function wr(e){const t=xr(e);return t<0?0:t<br?t:br}function _r(e,t){if(!fr(e))throw Hi("This is not an object");const i=e.constructor;if(void 0===i)return t;if(!fr(i))throw Hi("The constructor property value is not an object");const r=i[Vt];return null==r?t:r}function yr(e){if(mr(e))return!1;try{return ui(e,0,0),!1}catch(e){}return!0}function Mr(e,t){const i=Ht(e),r=Ht(t);if(i&&r)return 0;if(i)return 1;if(r)return-1;if(e<t)return-1;if(e>t)return 1;if(0===e&&0===t){const i=Zt(e,0),r=Zt(t,0);if(!i&&r)return-1;if(i&&!r)return 1}return 0}const Pr=zt("__Float16Array__"),Cr=new qi;function Ir(e){return Zi(Cr,e)||!di(e)&&function(e){if(!pr(e))return!1;const t=Bt(e);if(!pr(t))return!1;const i=t.constructor;if(void 0===i)return!1;if(!fr(i))throw Hi("The constructor property value is not an object");return Lt(i,Pr)}(e)}function Rr(e){if(!Ir(e))throw Hi("This is not a Float16Array object")}function Sr(e,t){const i=Ir(e),r=gr(e);if(!i&&!r)throw Hi("Species constructor didn't return TypedArray object");if("number"==typeof t){let r;if(i){const t=Or(e);r=Di(t)}else r=Di(e);if(r<t)throw Hi("Derived constructor created TypedArray object which was too small length")}if(vr(e))throw Hi("Cannot mix BigInt and other types, use explicit conversions")}function Or(e){const t=Ki(Cr,e);if(void 0!==t){if(yr(Si(t)))throw Hi("Attempting to access detached ArrayBuffer");return t}const i=e.buffer;if(yr(i))throw Hi("Attempting to access detached ArrayBuffer");const r=St(Lr,[i,e.byteOffset,e.length],e.constructor);return Ki(Cr,r)}function Dr(e){const t=Di(e),i=[];for(let r=0;r<t;++r)i[r]=ar(e[r]);return i}const Ar=new Vi;for(const e of Ut(Ei)){if(e===Wt)continue;const t=At(Ei,e);ei(t,"get")&&zi(Ar,e)}const Br=Kt({get:(e,t,i)=>Tr(t)&&ei(e,t)?ar(Dt(e,t)):$i(Ar,t)&&Jt(Ei,e)?Dt(e,t):Dt(e,t,i),set:(e,t,i,r)=>Tr(t)&&ei(e,t)?Ft(e,t,sr(i)):Ft(e,t,i,r),getOwnPropertyDescriptor(e,t){if(Tr(t)&&ei(e,t)){const i=At(e,t);return i.value=ar(i.value),i}return At(e,t)},defineProperty:(e,t,i)=>Tr(t)&&ei(e,t)&&ei(i,"value")?(i.value=sr(i.value),Ot(e,t,i)):Ot(e,t,i)});class Lr{constructor(e,t,i){let r;if(Ir(e))r=St(Bi,[Or(e)],new.target);else if(fr(e)&&!function(e){try{return fi(e),!0}catch(e){return!1}}(e)){let t,i;if(gr(e)){t=e,i=Di(e);const s=Si(e),n=mr(s)?ci:_r(s,ci);if(yr(s))throw Hi("Attempting to access detached ArrayBuffer");if(vr(e))throw Hi("Cannot mix BigInt and other types, use explicit conversions");const o=new n(2*i);r=St(Bi,[o],new.target)}else{const s=e[Xt];if(null!=s&&"function"!=typeof s)throw Hi("@@iterator property is not callable");null!=s?Er(e)?(t=e,i=e.length):(t=[...e],i=t.length):(t=e,i=wr(t.length)),r=St(Bi,[i],new.target)}for(let e=0;e<i;++e)r[e]=sr(t[e])}else r=St(Bi,arguments,new.target);const s=new Gt(r,Br);return Qi(Cr,s,r),s}static from(e,...t){const i=this;if(!Lt(i,Pr))throw Hi("This constructor is not a subclass of Float16Array");if(i===Lr){if(Ir(e)&&0===t.length){const t=Or(e),i=new Bi(Si(t),Oi(t),Di(t));return new Lr(Si(Ii(i)))}if(0===t.length)return new Lr(Si(Li(e,sr)));const i=t[0];return new Lr(Si(Li(e,(e,...t)=>sr(Rt(i,this,[e,...lr(t)])),t[1])))}let r,s;const n=e[Xt];if(null!=n&&"function"!=typeof n)throw Hi("@@iterator property is not callable");if(null!=n)Er(e)?(r=e,s=e.length):!gr(o=e)||o[Xt]!==Ti&&"Array Iterator"!==o[Xt]()[Wt]?(r=[...e],s=r.length):(r=e,s=Di(e));else{if(null==e)throw Hi("Cannot convert undefined or null to object");r=$t(e),s=wr(r.length)}var o;const h=new i(s);if(0===t.length)for(let e=0;e<s;++e)h[e]=r[e];else{const e=t[0],i=t[1];for(let t=0;t<s;++t)h[t]=Rt(e,i,[r[t],t])}return h}static of(...e){const t=this;if(!Lt(t,Pr))throw Hi("This constructor is not a subclass of Float16Array");const i=e.length;if(t===Lr){const t=new Lr(i),r=Or(t);for(let t=0;t<i;++t)r[t]=sr(e[t]);return t}const r=new t(i);for(let t=0;t<i;++t)r[t]=e[t];return r}keys(){Rr(this);const e=Or(this);return bi(e)}values(){Rr(this);const e=Or(this);return ur(function*(){for(const t of xi(e))yield ar(t)}())}entries(){Rr(this);const e=Or(this);return ur(function*(){for(const[t,i]of wi(e))yield[t,ar(i)]}())}at(e){Rr(this);const t=Or(this),i=Di(t),r=xr(e),s=r>=0?r:i+r;if(!(s<0||s>=i))return ar(t[s])}map(e,...t){Rr(this);const i=Or(this),r=Di(i),s=t[0],n=_r(i,Lr);if(n===Lr){const t=new Lr(r),n=Or(t);for(let t=0;t<r;++t){const r=ar(i[t]);n[t]=sr(Rt(e,s,[r,t,this]))}return t}const o=new n(r);Sr(o,r);for(let t=0;t<r;++t){const r=ar(i[t]);o[t]=Rt(e,s,[r,t,this])}return o}filter(e,...t){Rr(this);const i=Or(this),r=Di(i),s=t[0],n=[];for(let t=0;t<r;++t){const r=ar(i[t]);Rt(e,s,[r,t,this])&&ni(n,r)}const o=new(_r(i,Lr))(n);return Sr(o),o}reduce(e,...t){Rr(this);const i=Or(this),r=Di(i);if(0===r&&0===t.length)throw Hi("Reduce of empty array with no initial value");let s,n;0===t.length?(s=ar(i[0]),n=1):(s=t[0],n=0);for(let t=n;t<r;++t)s=e(s,ar(i[t]),t,this);return s}reduceRight(e,...t){Rr(this);const i=Or(this),r=Di(i);if(0===r&&0===t.length)throw Hi("Reduce of empty array with no initial value");let s,n;0===t.length?(s=ar(i[r-1]),n=r-2):(s=t[0],n=r-1);for(let t=n;t>=0;--t)s=e(s,ar(i[t]),t,this);return s}forEach(e,...t){Rr(this);const i=Or(this),r=Di(i),s=t[0];for(let t=0;t<r;++t)Rt(e,s,[ar(i[t]),t,this])}find(e,...t){Rr(this);const i=Or(this),r=Di(i),s=t[0];for(let t=0;t<r;++t){const r=ar(i[t]);if(Rt(e,s,[r,t,this]))return r}}findIndex(e,...t){Rr(this);const i=Or(this),r=Di(i),s=t[0];for(let t=0;t<r;++t){const r=ar(i[t]);if(Rt(e,s,[r,t,this]))return t}return-1}findLast(e,...t){Rr(this);const i=Or(this),r=Di(i),s=t[0];for(let t=r-1;t>=0;--t){const r=ar(i[t]);if(Rt(e,s,[r,t,this]))return r}}findLastIndex(e,...t){Rr(this);const i=Or(this),r=Di(i),s=t[0];for(let t=r-1;t>=0;--t){const r=ar(i[t]);if(Rt(e,s,[r,t,this]))return t}return-1}every(e,...t){Rr(this);const i=Or(this),r=Di(i),s=t[0];for(let t=0;t<r;++t)if(!Rt(e,s,[ar(i[t]),t,this]))return!1;return!0}some(e,...t){Rr(this);const i=Or(this),r=Di(i),s=t[0];for(let t=0;t<r;++t)if(Rt(e,s,[ar(i[t]),t,this]))return!0;return!1}set(e,...t){Rr(this);const i=Or(this),r=xr(t[0]);if(r<0)throw Xi("Offset is out of bounds");if(null==e)throw Hi("Cannot convert undefined or null to object");if(vr(e))throw Hi("Cannot mix BigInt and other types, use explicit conversions");if(Ir(e))return _i(Or(this),Or(e),r);if(gr(e)&&yr(Si(e)))throw Hi("Attempting to access detached ArrayBuffer");const s=Di(i),n=$t(e),o=wr(n.length);if(r===1/0||o+r>s)throw Xi("Offset is out of bounds");for(let e=0;e<o;++e)i[e+r]=sr(n[e])}reverse(){Rr(this);const e=Or(this);return yi(e),this}fill(e,...t){Rr(this);const i=Or(this);return Mi(i,sr(e),...lr(t)),this}copyWithin(e,t,...i){Rr(this);const r=Or(this);return Pi(r,e,t,...lr(i)),this}sort(...e){Rr(this);const t=Or(this),i=void 0!==e[0]?e[0]:Mr;return Ci(t,(e,t)=>i(ar(e),ar(t))),this}slice(...e){Rr(this);const t=Or(this),i=_r(t,Lr);if(i===Lr){const i=new Bi(Si(t),Oi(t),Di(t));return new Lr(Si(Ii(i,...lr(e))))}const r=Di(t),s=xr(e[0]),n=void 0===e[1]?r:xr(e[1]);let o,h;o=s===-1/0?0:s<0?r+s>0?r+s:0:r<s?r:s,h=n===-1/0?0:n<0?r+n>0?r+n:0:r<n?r:n;const a=h-o>0?h-o:0,l=new i(a);if(Sr(l,a),0===a)return l;if(yr(Si(t)))throw Hi("Attempting to access detached ArrayBuffer");let c=0;for(;o<h;)l[c]=ar(t[o]),++o,++c;return l}subarray(...e){Rr(this);const t=Or(this),i=_r(t,Lr),r=new Bi(Si(t),Oi(t),Di(t)),s=Ri(r,...lr(e)),n=new i(Si(s),Oi(s),Di(s));return Sr(n),n}indexOf(e,...t){Rr(this);const i=Or(this),r=Di(i);let s=xr(t[0]);if(s===1/0)return-1;s<0&&(s+=r,s<0&&(s=0));for(let t=s;t<r;++t)if(ei(i,t)&&ar(i[t])===e)return t;return-1}lastIndexOf(e,...t){Rr(this);const i=Or(this),r=Di(i);let s=t.length>=1?xr(t[0]):r-1;if(s===-1/0)return-1;s>=0?s=s<r-1?s:r-1:s+=r;for(let t=s;t>=0;--t)if(ei(i,t)&&ar(i[t])===e)return t;return-1}includes(e,...t){Rr(this);const i=Or(this),r=Di(i);let s=xr(t[0]);if(s===1/0)return!1;s<0&&(s+=r,s<0&&(s=0));const n=Ht(e);for(let t=s;t<r;++t){const r=ar(i[t]);if(n&&Ht(r))return!0;if(r===e)return!0}return!1}join(...e){Rr(this);const t=Dr(Or(this));return si(t,...lr(e))}toLocaleString(...e){Rr(this);const t=Dr(Or(this));return oi(t,...lr(e))}get[Wt](){if(Ir(this))return"Float16Array"}}Yt(Lr,"BYTES_PER_ELEMENT",{value:2}),Yt(Lr,Pr,{}),jt(Lr,vi);const Ur=Lr.prototype;Yt(Ur,"BYTES_PER_ELEMENT",{value:2}),Yt(Ur,Xt,{value:Ur.values,writable:!0,configurable:!0}),jt(Ur,Ei);const Fr=new w({textureWidth:0,textureHeight:0});function jr(e){e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)}class Gr{constructor(){this.positionsDecompressMatrices=void 0,this.positionsCompressed=void 0,this.indices_8Bits=void 0,this.indices_16Bits=void 0,this.indices_32Bits=void 0,this.edgeIndices_8Bits=void 0,this.edgeIndices_16Bits=void 0,this.edgeIndices_32Bits=void 0,this.eachPrimitiveMesh_8Bits=void 0,this.eachPrimitiveMesh_16Bits=void 0,this.eachPrimitiveMesh_32Bits=void 0,this.eachEdgeMesh_8Bits=void 0,this.eachEdgeMesh_16Bits=void 0,this.eachEdgeMesh_32Bits=void 0,this.eachMeshVertexPortionBase=void 0,this.eachMeshVertexPortionOffset=void 0,this.eachMeshEdgeIndicesOffset=void 0,this.eachMeshColor=void 0,this.eachMeshPickColor=void 0,this.eachMeshMatrices=void 0,this.eachMeshNormalMatrix=void 0,this.eachMeshPositionsDecompressMatrix=void 0,this.eachMeshFlags1=void 0,this.eachMeshFlags2=void 0,this.eachEdgeOffset=void 0,this.eachMeshParts=void 0,this.positionsDecompressMatrices=[],this.positionsCompressed=[],this.indices_8Bits=[],this.indices_16Bits=[],this.indices_32Bits=[],this.edgeIndices_8Bits=[],this.edgeIndices_16Bits=[],this.edgeIndices_32Bits=[],this.eachMeshVertexPortionBase=[],this.eachMeshVertexPortionOffset=[],this.eachMeshEdgeIndicesOffset=[],this.eachMeshColor=[],this.eachMeshPickColor=[],this.eachMeshMatrices=[],this.eachMeshNormalMatrix=[],this.eachMeshPositionsDecompressMatrix=[],this.eachMeshFlags1=[],this.eachMeshFlags2=[],this.eachPrimitiveMesh_32Bits=[],this.eachPrimitiveMesh_16Bits=[],this.eachPrimitiveMesh_8Bits=[],this.eachEdgeMesh_32Bits=[],this.eachEdgeMesh_16Bits=[],this.eachEdgeMesh_8Bits=[],this.eachEdgeOffset=[],this.eachMeshParts=[]}}const Nr=8,kr=c(),Hr=e([0,0,0,1]),Xr=e([0,0,0,1]);e([0,0,0,1]);const Vr=new Uint8Array(4),Wr=new Float32Array(3);var zr=/*#__PURE__*/D("gl"),$r=/*#__PURE__*/D("view"),qr=/*#__PURE__*/D("dataTextureBuffer"),Yr=/*#__PURE__*/D("geometryHandles"),Kr=/*#__PURE__*/D("meshPartHandles"),Zr=/*#__PURE__*/D("numMeshParts"),Qr=/*#__PURE__*/D("deferredSetFlagsActive"),Jr=/*#__PURE__*/D("deferredSetFlagsDirty"),es=/*#__PURE__*/D("built"),ts=/*#__PURE__*/D("createGeometryBucket"),is=/*#__PURE__*/D("createMeshPart"),rs=/*#__PURE__*/D("setMeshFlags"),ss=/*#__PURE__*/D("setMeshFlags2");class ns{constructor(e,t){Object.defineProperty(this,ss,{value:ls}),Object.defineProperty(this,rs,{value:as}),Object.defineProperty(this,is,{value:hs}),Object.defineProperty(this,ts,{value:os}),this.rendererModel=void 0,this.layerIndex=void 0,this.meshCounts=void 0,this.renderState=void 0,Object.defineProperty(this,zr,{writable:!0,value:void 0}),Object.defineProperty(this,$r,{writable:!0,value:void 0}),Object.defineProperty(this,qr,{writable:!0,value:void 0}),Object.defineProperty(this,Yr,{writable:!0,value:void 0}),Object.defineProperty(this,Kr,{writable:!0,value:void 0}),Object.defineProperty(this,Zr,{writable:!0,value:void 0}),Object.defineProperty(this,Qr,{writable:!0,value:void 0}),Object.defineProperty(this,Jr,{writable:!0,value:void 0}),Object.defineProperty(this,es,{writable:!0,value:void 0}),this.meshCounts=new Mt,this.layerIndex=e.layerIndex,this.rendererModel=e.rendererModel,this.renderState={primitive:e.primitive,dataTextureSet:new yt,numIndices8Bits:0,numIndices16Bits:0,numIndices32Bits:0,numEdgeIndices8Bits:0,numEdgeIndices16Bits:0,numEdgeIndices32Bits:0,numVertices:0},A(this,zr)[zr]=e.gl,A(this,$r)[$r]=e.view,A(this,qr)[qr]=new Gr,A(this,Zr)[Zr]=0,A(this,Yr)[Yr]={},A(this,Kr)[Kr]=[],A(this,es)[es]=!1,this.beginDeferredFlags()}get hash(){return`layer-${this.renderState.primitive}`}canCreateMesh(e){if(A(this,es)[es])throw"Already built";const t=this.renderState,i=e.geometryBuckets.length;if(A(this,Zr)[Zr]+i>4096)return!1;let r=0,s=0;for(let t=0;t<i;t++){const i=e.geometryBuckets[t];r+=i.positionsCompressed.length,i.indices&&(s+=i.indices.length)}return t.numVertices+r/(e.primitive===k?1:e.primitive==H?2:3)<=2097152&&s/3+s<=2097152}hasGeometry(e){return A(this,Yr)[Yr][e]}createGeometryCompressed(e){if(A(this,es)[es])throw"Already built";const t=[];for(let i=0,r=e.geometryBuckets.length;i<r;i++)t.push(A(this,ts)[ts](e.geometryBuckets[i]));A(this,Yr)[Yr][e.id]={id:e.id,aabb:e.aabb,positionsDecompressMatrix:e.positionsDecompressMatrix,geometryBucketHandles:t}}createMesh(e){if(A(this,es)[es])throw new Error("Already built");const t=this.meshCounts.numMeshes;if(!e.geometryId)throw new Error("geometryId expected");const i=A(this,Yr)[Yr][e.geometryId];if(!i)throw new Error("Geometry not found");i.geometryBucketHandles.forEach(t=>{A(this,is)[is](e,i,t)});const r=bt(),s=function(e=Tt(),t=function(e){return I(32)}()){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=1,t[4]=e[3],t[5]=e[1],t[6]=e[2],t[7]=1,t[8]=e[3],t[9]=e[4],t[10]=e[2],t[11]=1,t[12]=e[0],t[13]=e[4],t[14]=e[2],t[15]=1,t[16]=e[0],t[17]=e[1],t[18]=e[5],t[19]=1,t[20]=e[3],t[21]=e[1],t[22]=e[5],t[23]=1,t[24]=e[3],t[25]=e[4],t[26]=e[5],t[27]=1,t[28]=e[0],t[29]=e[4],t[30]=e[5],t[31]=1,t}(i.aabb);for(let t=0,i=s.length;t<i;t+=4)Hr[0]=s[t+0],Hr[1]=s[t+1],Hr[2]=s[t+2],e.matrix?(d(e.matrix,Hr,Xr),wt(r,Xr)):wt(r,Xr);return this.meshCounts.numMeshes++,t}build(){if(A(this,es)[es])throw new Error("Already built");const e=A(this,zr)[zr],t=A(this,qr)[qr],i=this.renderState.dataTextureSet;i.positions=function(e,t){const i=1024,r=Math.ceil(t.length/3/i);if(0==r)throw"texture height == 0";const s=new Uint16Array(i*r*3);s.fill(0),s.set(t,0);const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,i,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,i,r,e.RGB_INTEGER,e.UNSIGNED_SHORT,s,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new w({gl:e,texture:n,textureWidth:i,textureHeight:r})}(e,t.positionsCompressed),i.indices_8Bits=function(e,t){if(0==t.length)return Fr;const i=1024,r=Math.ceil(t.length/3/i);if(0==r)throw"texture height == 0";const s=new Uint8Array(i*r*3);s.fill(0),s.set(t,0);const n=e.createTexture();return n?(e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGB8UI,i,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,i,r,e.RGB_INTEGER,e.UNSIGNED_BYTE,s,0),jr(e),e.bindTexture(e.TEXTURE_2D,null),new w({gl:e,texture:n,textureWidth:i,textureHeight:r})):Fr}(e,t.indices_8Bits),i.indices_16Bits=function(e,t){if(0==t.length)return Fr;const i=1024,r=Math.ceil(t.length/3/i);if(0==r)throw"texture height == 0";const s=new Uint16Array(i*r*3);s.fill(0),s.set(t,0);const n=e.createTexture();return n?(e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,i,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,i,r,e.RGB_INTEGER,e.UNSIGNED_SHORT,s,0),jr(e),e.bindTexture(e.TEXTURE_2D,null),new w({gl:e,texture:n,textureWidth:i,textureHeight:r})):Fr}(e,t.indices_16Bits),i.indices_32Bits=function(e,t){if(0==t.length)return Fr;const i=1024,r=Math.ceil(t.length/3/i);if(0==r)throw"texture height == 0";const s=new Uint32Array(i*r*3);s.fill(0),s.set(t,0);const n=e.createTexture();return n?(e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32UI,i,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,i,r,e.RGB_INTEGER,e.UNSIGNED_INT,s,0),jr(e),e.bindTexture(e.TEXTURE_2D,null),new w({gl:e,texture:n,textureWidth:i,textureHeight:r})):Fr}(e,t.indices_32Bits),i.edgeIndices_8Bits=function(e,t){if(0==t.length)return Fr;const i=1024,r=Math.ceil(t.length/2/i);if(0==r)throw"texture height == 0";const s=new Uint8Array(i*r*2);s.fill(0),s.set(t,0);const n=e.createTexture();return n?(e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RG8UI,i,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,i,r,e.RG_INTEGER,e.UNSIGNED_BYTE,s,0),jr(e),e.bindTexture(e.TEXTURE_2D,null),new w({gl:e,texture:n,textureWidth:i,textureHeight:r})):Fr}(e,t.edgeIndices_8Bits),i.edgeIndices_16Bits=function(e,t){if(0==t.length)return Fr;const i=1024,r=Math.ceil(t.length/2/i);if(0==r)throw"texture height == 0";const s=new Uint16Array(i*r*2);s.fill(0),s.set(t,0);const n=e.createTexture();return n?(e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RG16UI,i,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,i,r,e.RG_INTEGER,e.UNSIGNED_SHORT,s,0),jr(e),e.bindTexture(e.TEXTURE_2D,null),new w({gl:e,texture:n,textureWidth:i,textureHeight:r})):Fr}(e,t.edgeIndices_16Bits),i.edgeIndices_32Bits=function(e,t){if(0==t.length)return Fr;const i=1024,r=Math.ceil(t.length/2/i);if(0==r)throw"texture height == 0";const s=new Uint32Array(i*r*2);s.fill(0),s.set(t,0);const n=e.createTexture();return n?(e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RG32UI,i,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,i,r,e.RG_INTEGER,e.UNSIGNED_INT,s,0),jr(e),e.bindTexture(e.TEXTURE_2D,null),new w({gl:e,texture:n,textureWidth:i,textureHeight:r})):Fr}(e,t.edgeIndices_32Bits),i.eachMeshAttributes=function(e,t,i,r,s,n){const o=t.length;if(0==o)throw"texture height == 0";const h=new Uint8Array(32*o);for(let e=0;e<o;e++)h.set(t[e],28*e+0),h.set(i[e],28*e+4),h.set([0,0,0,0],28*e+8),h.set([0,0,0,0],28*e+12),h.set([r[e]>>24&255,r[e]>>16&255,r[e]>>8&255,255&r[e]],28*e+16),h.set([s[e]>>24&255,s[e]>>16&255,s[e]>>8&255,255&s[e]],28*e+20),h.set([n[e]>>24&255,n[e]>>16&255,n[e]>>8&255,255&n[e]],28*e+24);const a=e.createTexture();return a?(e.bindTexture(e.TEXTURE_2D,a),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA8UI,8,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,8,o,e.RGBA_INTEGER,e.UNSIGNED_BYTE,h,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new w({gl:e,texture:a,textureWidth:8,textureHeight:o,textureData:h})):Fr}(e,t.eachMeshColor,t.eachMeshPickColor,t.eachMeshVertexPortionBase,t.eachMeshVertexPortionOffset,t.eachMeshEdgeIndicesOffset),i.eachMeshMatrices=function(e,t,i){const r=t.length;if(0==r)throw"texture height == 0";const s=new Lr(48*r);for(let e=0;e<t.length;e++)s.set(t[e],48*e),s.set(i[e],48*e+16);const n=e.createTexture();return n?(e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA16F,12,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,12,r,e.RGBA,e.HALF_FLOAT,new Uint16Array(s.buffer),0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new w({gl:e,texture:n,textureWidth:12,textureHeight:r})):Fr}(e,t.eachMeshPositionsDecompressMatrix,t.eachMeshMatrices),i.eachEdgeOffset=function(e,t){const i=t.length;if(0==i)throw"texture height == 0";const r=new Float32Array(3*i);for(let e=0;e<t.length;e++)r.set(t[e],3*e);const s=e.createTexture();return s?(e.bindTexture(e.TEXTURE_2D,s),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32F,1,i),e.texSubImage2D(e.TEXTURE_2D,0,0,0,1,i,e.RGB,e.FLOAT,r,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new w({gl:e,texture:s,textureWidth:1,textureHeight:i,textureData:r})):Fr}(e,t.eachEdgeOffset),i.build(),A(this,qr)[qr]=null,A(this,Yr)[Yr]={},A(this,Kr)[Kr]=[],A(this,es)[es]=!0}isEmpty(){return 0==this.meshCounts.numMeshes}initFlags(e,t,i){t&Pt.VISIBLE&&this.meshCounts.numVisible++,t&Pt.HIGHLIGHTED&&this.meshCounts.numHighlighted++,t&Pt.XRAYED&&this.meshCounts.numXRayed++,t&Pt.SELECTED&&this.meshCounts.numSelected++,t&Pt.CLIPPABLE&&this.meshCounts.numClippable++,t&Pt.EDGES&&this.meshCounts.numEdges++,t&Pt.PICKABLE&&this.meshCounts.numPickable++,t&Pt.CULLED&&this.meshCounts.numCulled++,i&&this.meshCounts.numTransparent++,A(this,rs)[rs](e,t,i),A(this,ss)[ss](e,t)}beginDeferredFlags(){A(this,Qr)[Qr]=!0}commitDeferredFlags(){if(A(this,Qr)[Qr]=!1,!A(this,Jr)[Jr])return;A(this,Jr)[Jr]=!1;const e=A(this,zr)[zr],t=this.renderState.dataTextureSet;e.bindTexture(e.TEXTURE_2D,t.eachMeshAttributes.texture),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t.eachMeshAttributes.textureWidth,t.eachMeshAttributes.textureHeight,e.RGBA_INTEGER,e.UNSIGNED_BYTE,t.eachMeshAttributes.textureData),e.bindTexture(e.TEXTURE_2D,t.eachEdgeOffset.texture),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t.eachEdgeOffset.textureWidth,t.eachEdgeOffset.textureHeight,e.RGB,e.FLOAT,t.eachEdgeOffset.textureData)}flushInitFlags(){this.commitDeferredFlags()}setMeshVisible(e,t,i){if(!A(this,es)[es])throw"Not built";t&Pt.VISIBLE?this.meshCounts.numVisible++:this.meshCounts.numVisible--,A(this,rs)[rs](e,t,i)}setMeshHighlighted(e,t,i){if(!A(this,es)[es])throw"Not built";t&Pt.HIGHLIGHTED?this.meshCounts.numHighlighted++:this.meshCounts.numHighlighted--,A(this,rs)[rs](e,t,i)}setMeshXRayed(e,t,i){if(!A(this,es)[es])throw"Not built";t&Pt.XRAYED?this.meshCounts.numXRayed++:this.meshCounts.numXRayed--,A(this,rs)[rs](e,t,i)}setMeshSelected(e,t,i){if(!A(this,es)[es])throw"Not built";t&Pt.SELECTED?this.meshCounts.numSelected++:this.meshCounts.numSelected--,A(this,rs)[rs](e,t,i)}setMeshEdges(e,t,i){if(!A(this,es)[es])throw"Not built";t&Pt.EDGES?this.meshCounts.numEdges++:this.meshCounts.numEdges--,A(this,rs)[rs](e,t,i)}setMeshClippable(e,t){if(!A(this,es)[es])throw"Not built";t&Pt.CLIPPABLE?this.meshCounts.numClippable++:this.meshCounts.numClippable--,A(this,ss)[ss](e,t)}setMeshCulled(e,t,i){if(!A(this,es)[es])throw"Not built";t&Pt.CULLED?this.meshCounts.numCulled++:this.meshCounts.numCulled--,A(this,rs)[rs](e,t,i)}setMeshCollidable(e,t){if(!A(this,es)[es])throw"Not built"}setMeshPickable(e,t,i){if(!A(this,es)[es])throw"Not built";t&Pt.PICKABLE?this.meshCounts.numPickable++:this.meshCounts.numPickable--,A(this,rs)[rs](e,t,i)}setMeshColor(e,t,i){if(!A(this,es)[es])throw"Not built";const r=this.renderState.dataTextureSet,s=A(this,zr)[zr];Vr[0]=t[0],Vr[1]=t[1],Vr[2]=t[2],Vr[3]=t[3],r.eachMeshAttributes.textureData.set(Vr,28*e),A(this,Qr)[Qr]?A(this,Jr)[Jr]=!0:(s.bindTexture(s.TEXTURE_2D,r.eachMeshAttributes.texture),s.texSubImage2D(s.TEXTURE_2D,0,0,e,1,1,s.RGBA_INTEGER,s.UNSIGNED_BYTE,Vr))}setMeshTransparent(e,t,i){if(!A(this,es)[es])throw"Not built";i?(this.meshCounts.numTransparent++,this.meshCounts.numTransparent++):(this.meshCounts.numTransparent--,this.meshCounts.numTransparent--),A(this,rs)[rs](e,t,i)}setMeshOffset(e,t){if(!A(this,es)[es])throw"Not built";const i=A(this,zr)[zr];Wr[0]=t[0],Wr[1]=t[1],Wr[2]=t[2],A(this,Qr)[Qr]?A(this,Jr)[Jr]=!0:i.texSubImage2D(i.TEXTURE_2D,0,0,e,1,1,i.RGB,i.FLOAT,Wr)}setMeshMatrix(e,t){if(!A(this,es)[es])throw"Not built";A(this,zr),A(this,Qr)[Qr]&&(A(this,Jr)[Jr]=!0)}setMeshViewMatrixIndex(e,t){if(!A(this,es)[es])throw"Not built";A(this,zr),A(this,Qr)[Qr]&&(A(this,Jr)[Jr]=!0)}destroy(){this.renderState.dataTextureSet.destroy()}}function os(e){const t=this.renderState;if(e.indices){const t=this.renderState.primitive===k?1:this.renderState.primitive===H?2:3,i=Math.ceil(e.indices.length/t/Nr)*Nr*t,r=new Uint32Array(i);r.fill(0),r.set(e.indices),e.indices=r}if(e.edgeIndices){const t=Math.ceil(e.edgeIndices.length/2/Nr)*Nr*2,i=new Uint32Array(t);i.fill(0),i.set(e.edgeIndices),e.edgeIndices=i}const i=A(this,qr)[qr],r=e.positionsCompressed,s=e.indices,n=e.edgeIndices,o=i.positionsCompressed.length/3,h=r.length/3;for(let e=0,t=r.length;e<t;e++)i.positionsCompressed.push(r[e]);let a,l,c=0;if(s){let e;c=s.length/3,e=h<=256?i.indices_8Bits:h<=65536?i.indices_16Bits:i.indices_32Bits,a=e.length/3;for(let t=0,i=s.length;t<i;t++)e.push(s[t])}let d=0;if(n){let e;d=n.length/2,e=h<=256?i.edgeIndices_8Bits:h<=65536?i.edgeIndices_16Bits:i.edgeIndices_32Bits,l=e.length/2;for(let t=0,i=n.length;t<i;t++)e.push(n[t])}return t.numVertices+=h,{vertexBase:o,numVertices:h,numTriangles:c,numEdges:d,indicesBase:a,edgeIndicesBase:l}}function hs(e,t,i){const r=A(this,qr)[qr],s=this.renderState,n=e.matrix||kr,o=e.color||[255,255,255],h=r.positionsCompressed.length/3;let a,l;r.eachMeshPositionsDecompressMatrix.push(t.positionsDecompressMatrix),r.eachMeshMatrices.push(n),r.eachMeshColor.push([o[0],o[1],o[2],255]),r.eachMeshPickColor.push(e.pickColor),a=i.numVertices<=256?s.numIndices8Bits:i.numVertices<=65536?s.numIndices16Bits:s.numIndices32Bits,r.eachMeshVertexPortionBase.push(i.vertexBase),r.eachMeshVertexPortionOffset.push(a/3-i.indicesBase),l=i.numVertices<=256?s.numEdgeIndices8Bits:i.numVertices<=65536?s.numEdgeIndices16Bits:s.numEdgeIndices32Bits,r.eachMeshEdgeIndicesOffset.push(l/2-i.edgeIndicesBase);const c=A(this,Kr)[Kr].length;if(i.numTriangles>0){const e=3*i.numTriangles;let t;i.numVertices<=256?(t=r.eachPrimitiveMesh_8Bits,s.numIndices8Bits+=e):i.numVertices<=65536?(t=r.eachPrimitiveMesh_16Bits,s.numIndices16Bits+=e):(t=r.eachPrimitiveMesh_32Bits,s.numIndices32Bits+=e);for(let e=0;e<i.numTriangles;e+=Nr)t.push(c)}if(i.numEdges>0){let e,t=2*i.numEdges;i.numVertices<=256?(e=r.eachEdgeMesh_8Bits,s.numEdgeIndices8Bits+=t):i.numVertices<=65536?(e=r.eachEdgeMesh_16Bits,s.numEdgeIndices16Bits+=t):(e=r.eachEdgeMesh_32Bits,s.numEdgeIndices32Bits+=t);for(let t=0;t<i.numEdges;t+=Nr)e.push(c)}return r.eachEdgeOffset.push([0,0,0]),A(this,Kr)[Kr].push({vertsBase:h,numVerts:i.numTriangles}),A(this,Zr)[Zr]++,c}function as(e,t,i){if(!A(this,es)[es])throw"Not built";const r=!!(t&Pt.VISIBLE),s=!!(t&Pt.XRAYED),n=!!(t&Pt.HIGHLIGHTED),o=!!(t&Pt.SELECTED),h=!!(t&Pt.CULLED);let a,l;a=!r||h||s?it.NOT_RENDERED:i?it.COLOR_TRANSPARENT:it.COLOR_OPAQUE,l=!r||h?it.NOT_RENDERED:o?it.SILHOUETTE_SELECTED:n?it.SILHOUETTE_HIGHLIGHTED:s?it.SILHOUETTE_XRAYED:it.NOT_RENDERED;let c=0;c=!r||h?it.NOT_RENDERED:o?it.EDGES_SELECTED:n?it.EDGES_HIGHLIGHTED:s?it.EDGES_XRAYED:t&Pt.EDGES?i?it.EDGES_COLOR_TRANSPARENT:it.EDGES_COLOR_OPAQUE:it.NOT_RENDERED;let d=r&&!h&&t&Pt.PICKABLE?it.PICK:it.NOT_RENDERED;const u=this.renderState.dataTextureSet,f=A(this,zr)[zr];if(Vr[0]=a,Vr[1]=l,Vr[2]=c,Vr[3]=d,A(this,Qr)[Qr])return u.eachMeshAttributes.textureData.set(Vr,28*e+8),void(A(this,Jr)[Jr]=!0);f.bindTexture(f.TEXTURE_2D,u.eachMeshAttributes.texture),f.texSubImage2D(f.TEXTURE_2D,0,2,e,1,1,f.RGBA_INTEGER,f.UNSIGNED_BYTE,Vr)}function ls(e,t){if(!A(this,es)[es])throw"Not built";const i=t&Pt.CLIPPABLE?255:0,r=this.renderState.dataTextureSet,s=A(this,zr)[zr];if(Vr[0]=i,Vr[1]=0,Vr[2]=1,Vr[3]=2,A(this,Qr)[Qr])return r.eachMeshAttributes.textureData.set(Vr,28*e+12),void(A(this,Jr)[Jr]=!0);s.bindTexture(s.TEXTURE_2D,r.eachMeshAttributes.texture),s.texSubImage2D(s.TEXTURE_2D,0,3,e,1,1,s.RGBA_INTEGER,s.UNSIGNED_BYTE,Vr)}class cs{constructor(){}}class ds{constructor(e,t){this.texture=void 0,this.texture2D=void 0,this.texture=e,this.texture2D=t}destroy(){this.texture2D&&this.texture2D.destroy()}}const us=new Uint16Array([0,0,0]);var fs=/*#__PURE__*/D("flags"),ps=/*#__PURE__*/D("aabb"),gs=/*#__PURE__*/D("offsetAABB"),vs=/*#__PURE__*/D("offset"),ms=/*#__PURE__*/D("colorizeUpdated"),Es=/*#__PURE__*/D("opacityUpdated");class Ts{constructor(e){this.id=void 0,this.model=void 0,this.sceneObject=void 0,this.layerId=void 0,this.rendererMeshes=void 0,Object.defineProperty(this,fs,{writable:!0,value:void 0}),Object.defineProperty(this,ps,{writable:!0,value:void 0}),Object.defineProperty(this,gs,{writable:!0,value:void 0}),Object.defineProperty(this,vs,{writable:!0,value:void 0}),Object.defineProperty(this,ms,{writable:!0,value:void 0}),Object.defineProperty(this,Es,{writable:!0,value:void 0}),this.id=e.id,this.rendererMeshes=e.rendererMeshes||[],A(this,fs)[fs]=0,A(this,ps)[ps]=e.aabb,A(this,gs)[gs]=Tt(e.aabb),A(this,vs)[vs]=h(),A(this,ms)[ms]=!1,A(this,Es)[Es]=!1,this.layerId=e.layerId||null;for(let e=0,t=this.rendererMeshes.length;e<t;e++)this.rendererMeshes[e].setSceneObject(this)}get aabb(){return A(this,gs)[gs]}setVisible(e,t){if(!!(A(this,fs)[fs]&Pt.VISIBLE)!==t){A(this,fs)[fs]=t?A(this,fs)[fs]|Pt.VISIBLE:A(this,fs)[fs]&~Pt.VISIBLE;for(let e=0,t=this.rendererMeshes.length;e<t;e++)this.rendererMeshes[e].setVisible(A(this,fs)[fs])}}setHighlighted(e,t){if(!!(A(this,fs)[fs]&Pt.HIGHLIGHTED)!==t){A(this,fs)[fs]=t?A(this,fs)[fs]|Pt.HIGHLIGHTED:A(this,fs)[fs]&~Pt.HIGHLIGHTED;for(let e=0,t=this.rendererMeshes.length;e<t;e++)this.rendererMeshes[e].setHighlighted(A(this,fs)[fs])}}setXRayed(e,t){if(!!(A(this,fs)[fs]&Pt.XRAYED)!==t){A(this,fs)[fs]=t?A(this,fs)[fs]|Pt.XRAYED:A(this,fs)[fs]&~Pt.XRAYED;for(let e=0,t=this.rendererMeshes.length;e<t;e++)this.rendererMeshes[e].setXRayed(A(this,fs)[fs])}}setSelected(e,t){if(!!(A(this,fs)[fs]&Pt.SELECTED)!==t){A(this,fs)[fs]=t?A(this,fs)[fs]|Pt.SELECTED:A(this,fs)[fs]&~Pt.SELECTED;for(let e=0,t=this.rendererMeshes.length;e<t;e++)this.rendererMeshes[e].setSelected(A(this,fs)[fs])}}setEdges(e,t){if(!!(A(this,fs)[fs]&Pt.EDGES)!==t){A(this,fs)[fs]=t?A(this,fs)[fs]|Pt.EDGES:A(this,fs)[fs]&~Pt.EDGES;for(let e=0,t=this.rendererMeshes.length;e<t;e++)this.rendererMeshes[e].setEdges(A(this,fs)[fs])}}setCulled(e,t){if(!!(A(this,fs)[fs]&Pt.CULLED)!==t){A(this,fs)[fs]=t?A(this,fs)[fs]|Pt.CULLED:A(this,fs)[fs]&~Pt.CULLED;for(let e=0,t=this.rendererMeshes.length;e<t;e++)this.rendererMeshes[e].setCulled(A(this,fs)[fs])}}setClippable(e,t){if(!!(A(this,fs)[fs]&Pt.CLIPPABLE)!==t){A(this,fs)[fs]=t?A(this,fs)[fs]|Pt.CLIPPABLE:A(this,fs)[fs]&~Pt.CLIPPABLE;for(let e=0,t=this.rendererMeshes.length;e<t;e++)this.rendererMeshes[e].setClippable(A(this,fs)[fs])}}setCollidable(e,t){if(!!(A(this,fs)[fs]&Pt.COLLIDABLE)!==t){A(this,fs)[fs]=t?A(this,fs)[fs]|Pt.COLLIDABLE:A(this,fs)[fs]&~Pt.COLLIDABLE;for(let e=0,t=this.rendererMeshes.length;e<t;e++)this.rendererMeshes[e].setCollidable(A(this,fs)[fs])}}setPickable(e,t){if(!!(A(this,fs)[fs]&Pt.PICKABLE)!==t){A(this,fs)[fs]=t?A(this,fs)[fs]|Pt.PICKABLE:A(this,fs)[fs]&~Pt.PICKABLE;for(let e=0,t=this.rendererMeshes.length;e<t;e++)this.rendererMeshes[e].setPickable(A(this,fs)[fs])}}setColorize(e,t){if(t){us[0]=Math.floor(255*t[0]),us[1]=Math.floor(255*t[1]),us[2]=Math.floor(255*t[2]);for(let e=0,t=this.rendererMeshes.length;e<t;e++)this.rendererMeshes[e].setColorize(us)}else for(let e=0,t=this.rendererMeshes.length;e<t;e++)this.rendererMeshes[e].setColorize(null)}setOpacity(e,t){if(0===this.rendererMeshes.length)return;const i=this.rendererMeshes[0].colorize[3];let r=255;if(null!=t){if(t<0?t=0:t>1&&(t=1),r=Math.floor(255*t),i===r)return}else if(r=255,i===r)return;for(let e=0,t=this.rendererMeshes.length;e<t;e++)this.rendererMeshes[e].setOpacity(r,A(this,fs)[fs])}setOffset(e,t){}build(){for(let e=0,t=this.rendererMeshes.length;e<t;e++)this.rendererMeshes[e].build(A(this,fs)[fs])}finalize2(){for(let e=0,t=this.rendererMeshes.length;e<t;e++)this.rendererMeshes[e].finalize2()}destroy(){for(let e=0,t=this.rendererMeshes.length;e<t;e++)this.rendererMeshes[e].destroy()}}const bs=t(),xs=t();class ws{constructor(e){this.id=void 0,this.color=void 0,this.rendererGeometry=void 0,this.rendererTextureSet=void 0,this.matrix=void 0,this.metallic=void 0,this.roughness=void 0,this.opacity=void 0,this.pickId=void 0,this.tileManager=void 0,this.tile=void 0,this.sceneObjectRenderer=void 0,this.aabb=void 0,this.layer=void 0,this.meshIndex=void 0,this.colorize=void 0,this.colorizing=void 0,this.transparent=void 0,this.sceneObjectRenderer=null,this.tileManager=e.tileManager,this.id=e.id,this.pickId=0,this.color=[e.color[0],e.color[1],e.color[2],e.opacity],this.colorize=[e.color[0],e.color[1],e.color[2],e.opacity],this.colorizing=!1,this.transparent=e.opacity<255,this.layer=e.layer,this.matrix=e.matrix,this.metallic=e.metallic,this.roughness=e.roughness,this.opacity=e.opacity,this.aabb=Tt(),this.rendererTextureSet=e.rendererTextureSet,this.rendererGeometry=e.rendererGeometry,this.meshIndex=e.meshIndex}delegatePickedEntity(){throw new Error("Method not implemented.")}setSceneObject(e){this.sceneObjectRenderer=e}build(e){this.layer.initFlags(this.meshIndex,e,this.transparent)}finalize2(){this.layer.flushInitFlags&&this.layer.flushInitFlags()}setVisible(e){this.layer.setMeshVisible(this.meshIndex,e,this.transparent)}setMatrix(e){const t=u(e,[0,0,0]),i=this.tile;this.tile=i?this.tileManager.updateTileCenter(i,t):this.tileManager.getTile(t);const r=!i||i.id!==this.tile.id,s=this.tile.center;this.layer.setMeshMatrix(this.meshIndex,0!==s[0]||0!==s[1]||0!==s[2]?f(e,p(-s[0],-s[1],-s[2],bs),xs):e),r&&this.layer.setMeshViewMatrixIndex(this.meshIndex,this.tile.index)}setMetallic(e){}setRoughness(e){}setColor(e){this.color[0]=e[0],this.color[1]=e[1],this.color[2]=e[2],this.colorizing||this.layer.setMeshColor(this.meshIndex,this.color)}setColorize(e){e?(this.colorize[0]=e[0],this.colorize[1]=e[1],this.colorize[2]=e[2],this.layer.setMeshColor(this.meshIndex,this.colorize,!1),this.colorizing=!0):(this.layer.setMeshColor(this.meshIndex,this.color,!1),this.colorizing=!1)}setOpacity(e,t){const i=e<255,r=this.transparent!==i;this.color[3]=e,this.colorize[3]=e,this.transparent=i,this.layer.setMeshColor(this.meshIndex,this.colorizing?this.colorize:this.color),r&&this.layer.setMeshTransparent(this.meshIndex,t,i)}setHighlighted(e){this.layer.setMeshHighlighted(this.meshIndex,e,this.transparent)}setXRayed(e){this.layer.setMeshXRayed(this.meshIndex,e,this.transparent)}setSelected(e){this.layer.setMeshSelected(this.meshIndex,e,this.transparent)}setEdges(e){this.layer.setMeshEdges(this.meshIndex,e,this.transparent)}setClippable(e){this.layer.setMeshClippable(this.meshIndex,e)}setCollidable(e){this.layer.setMeshCollidable(this.meshIndex,e)}setPickable(e){this.layer.setMeshPickable(this.meshIndex,e,this.transparent)}setCulled(e){this.layer.setMeshCulled(this.meshIndex,e,this.transparent)}canPickTriangle(){return!1}drawPickTriangles(e,t){}pickTriangleSurface(e){}canPickWorldPos(){return!0}drawPickNormals(e){}destroy(){this.tile&&this.tileManager&&this.tileManager.putTile(this.tile)}}class _s{constructor(e){this.id=void 0,this.colorTexture=void 0,this.metallicRoughnessTexture=void 0,this.emissiveTexture=void 0,this.occlusionTexture=void 0,this.id=e.id,this.colorTexture=e.colorTexture,this.metallicRoughnessTexture=e.metallicRoughnessTexture,this.emissiveTexture=e.emissiveTexture,this.occlusionTexture=e.occlusionTexture}}h(),t(),h([1,1,1]),h([0,0,0]),h([0,0,0]),g();const ys="defaultTextureSet";var Ms=/*#__PURE__*/D("view"),Ps=/*#__PURE__*/D("webglRenderer"),Cs=/*#__PURE__*/D("renderContext"),Is=/*#__PURE__*/D("position"),Rs=/*#__PURE__*/D("rotation"),Ss=/*#__PURE__*/D("quaternion"),Os=/*#__PURE__*/D("scale"),Ds=/*#__PURE__*/D("worldMatrix"),As=/*#__PURE__*/D("viewMatrix"),Bs=/*#__PURE__*/D("colorTextureEnabled"),Ls=/*#__PURE__*/D("backfaces"),Us=/*#__PURE__*/D("layers"),Fs=/*#__PURE__*/D("numGeometries"),js=/*#__PURE__*/D("numTriangles"),Gs=/*#__PURE__*/D("numLines"),Ns=/*#__PURE__*/D("numPoints"),ks=/*#__PURE__*/D("numViewerObjects"),Hs=/*#__PURE__*/D("textureTranscoder"),Xs=/*#__PURE__*/D("aabbDirty"),Vs=/*#__PURE__*/D("edgeThreshold"),Ws=/*#__PURE__*/D("currentLayers"),zs=/*#__PURE__*/D("aabb"),$s=/*#__PURE__*/D("viewMatrixDirty"),qs=/*#__PURE__*/D("worldMatrixNonIdentity"),Ys=/*#__PURE__*/D("onCameraViewMatrix"),Ks=/*#__PURE__*/D("layerId"),Zs=/*#__PURE__*/D("addModel"),Qs=/*#__PURE__*/D("addTexture"),Js=/*#__PURE__*/D("addGeometry"),en=/*#__PURE__*/D("addMesh"),tn=/*#__PURE__*/D("addObject"),rn=/*#__PURE__*/D("removeModel"),sn=/*#__PURE__*/D("createDefaultTextureSetRenderer"),nn=/*#__PURE__*/D("getLayer"),on=/*#__PURE__*/D("rebuildAABB");class hn extends M{constructor(i){super(i.view),Object.defineProperty(this,on,{value:vn}),Object.defineProperty(this,nn,{value:gn}),Object.defineProperty(this,sn,{value:pn}),Object.defineProperty(this,rn,{value:fn}),Object.defineProperty(this,tn,{value:un}),Object.defineProperty(this,en,{value:dn}),Object.defineProperty(this,Js,{value:cn}),Object.defineProperty(this,Qs,{value:ln}),Object.defineProperty(this,Zs,{value:an}),this.qualityRender=void 0,this.sceneModel=void 0,this.rendererGeometries=void 0,this.rendererTextures=void 0,this.rendererTextureSets=void 0,this.rendererMeshes=void 0,this.rendererObjects=void 0,this.rendererObjectsList=void 0,this.rendererViewObjects=void 0,this.viewer=void 0,this.layerList=void 0,this.onBuilt=void 0,Object.defineProperty(this,Ms,{writable:!0,value:void 0}),Object.defineProperty(this,Ps,{writable:!0,value:void 0}),Object.defineProperty(this,Cs,{writable:!0,value:void 0}),Object.defineProperty(this,Is,{writable:!0,value:void 0}),Object.defineProperty(this,Rs,{writable:!0,value:void 0}),Object.defineProperty(this,Ss,{writable:!0,value:void 0}),Object.defineProperty(this,Os,{writable:!0,value:void 0}),Object.defineProperty(this,Ds,{writable:!0,value:void 0}),Object.defineProperty(this,As,{writable:!0,value:void 0}),Object.defineProperty(this,Bs,{writable:!0,value:void 0}),Object.defineProperty(this,Ls,{writable:!0,value:void 0}),Object.defineProperty(this,Us,{writable:!0,value:void 0}),Object.defineProperty(this,Fs,{writable:!0,value:void 0}),Object.defineProperty(this,js,{writable:!0,value:void 0}),Object.defineProperty(this,Gs,{writable:!0,value:void 0}),Object.defineProperty(this,Ns,{writable:!0,value:void 0}),Object.defineProperty(this,ks,{writable:!0,value:void 0}),Object.defineProperty(this,Hs,{writable:!0,value:void 0}),Object.defineProperty(this,Xs,{writable:!0,value:void 0}),Object.defineProperty(this,Vs,{writable:!0,value:void 0}),Object.defineProperty(this,Ws,{writable:!0,value:void 0}),Object.defineProperty(this,zs,{writable:!0,value:void 0}),Object.defineProperty(this,$s,{writable:!0,value:void 0}),Object.defineProperty(this,qs,{writable:!0,value:void 0}),Object.defineProperty(this,Ys,{writable:!0,value:void 0}),Object.defineProperty(this,Ks,{writable:!0,value:void 0}),this.id=i.id,this.sceneModel=i.sceneModel,this.viewer=i.view.viewer,A(this,Ms)[Ms]=i.view,A(this,Ps)[Ps]=i.webglRenderer,A(this,Cs)[Cs]=i.renderContext,A(this,Hs)[Hs]=i.textureTranscoder,A(this,zs)[zs]=bt(),A(this,Xs)[Xs]=!1,A(this,Us)[Us]={},this.layerList=[],A(this,Ws)[Ws]={},this.rendererGeometries={},this.rendererTextures={},this.rendererTextureSets={},this.rendererMeshes={},this.rendererObjects={},this.rendererObjectsList=[],this.rendererViewObjects={},A(this,Fs)[Fs]=0,A(this,ks)[ks]=0,A(this,js)[js]=0,A(this,Gs)[Gs]=0,A(this,Ns)[Ns]=0,A(this,Vs)[Vs]=i.edgeThreshold||10,this.built=!1,A(this,Is)[Is]=h(i.position||[0,0,0]),A(this,Rs)[Rs]=h(i.rotation||[0,0,0]),A(this,Ss)[Ss]=e(i.quaternion||[0,0,0,1]),i.rotation&&v(A(this,Rs)[Rs],"XYZ",A(this,Ss)[Ss]),A(this,Os)[Os]=h(i.scale||[1,1,1]),A(this,Ds)[Ds]=t(),m(A(this,Is)[Is],A(this,Ss)[Ss],A(this,Os)[Os],A(this,Ds)[Ds]),(i.matrix||i.position||i.rotation||i.scale||i.quaternion)&&(A(this,As)[As]=t(),A(this,$s)[$s]=!0,A(this,qs)[qs]=!0),this.qualityRender=!1!==i.qualityRender,A(this,Ks)[Ks]=i.layerId,A(this,Ys)[Ys]=A(this,Ms)[Ms].camera.onViewMatrix.subscribe((e,t)=>{A(this,$s)[$s]=!0}),A(this,sn)[sn](),this.onBuilt=new P(new C),A(this,Zs)[Zs](i.sceneModel);for(let e=0,t=this.layerList.length;e<t;e++)this.layerList[e].layerIndex=e;A(this,Ws)[Ws]={},this.built=!0,A(this,Ps)[Ps].setImageDirty(),this.onBuilt.dispatch(this,null)}get position(){return A(this,Is)[Is]}get rotation(){return A(this,Rs)[Rs]}get quaternion(){return A(this,Ss)[Ss]}get scale(){return A(this,Os)[Os]}get worldMatrix(){return A(this,Ds)[Ds]}get viewMatrix(){return A(this,As)[As]?(A(this,$s)[$s]&&(f(A(this,Ms)[Ms].camera.viewMatrix,A(this,Ds)[Ds],A(this,As)[As]),A(this,$s)[$s]=!1),A(this,As)[As]):A(this,Ms)[Ms].camera.viewMatrix}get colorTextureEnabled(){return A(this,Bs)[Bs]}get backfaces(){return A(this,Ls)[Ls]}set backfaces(e){e=!!e,A(this,Ls)[Ls]=e,A(this,Ps)[Ps].setImageDirty()}get matrix(){return A(this,Ds)[Ds]}get aabb(){return A(this,Xs)[Xs]&&A(this,on)[on](),A(this,zs)[zs]}get numTriangles(){return A(this,js)[js]}get numLines(){return A(this,Gs)[Gs]}get numPoints(){return A(this,Ns)[Ns]}setVisible(e,t){for(let i=0,r=this.rendererObjectsList.length;i<r;i++)this.rendererObjectsList[i].setVisible(e,t);A(this,Ps)[Ps].setImageDirty(e)}setXRayed(e,t){for(let i=0,r=this.rendererObjectsList.length;i<r;i++)this.rendererObjectsList[i].setXRayed(e,t);A(this,Ps)[Ps].setImageDirty(e)}setHighlighted(e,t){for(let i=0,r=this.rendererObjectsList.length;i<r;i++)this.rendererObjectsList[i].setHighlighted(e,t);A(this,Ps)[Ps].setImageDirty(e)}setSelected(e,t){for(let i=0,r=this.rendererObjectsList.length;i<r;i++)this.rendererObjectsList[i].setSelected(e,t);A(this,Ps)[Ps].setImageDirty(e)}setEdges(e,t){for(let i=0,r=this.rendererObjectsList.length;i<r;i++)this.rendererObjectsList[i].setEdges(e,t);A(this,Ps)[Ps].setImageDirty(e)}setCulled(e,t){for(let i=0,r=this.rendererObjectsList.length;i<r;i++)this.rendererObjectsList[i].setCulled(e,t);A(this,Ps)[Ps].setImageDirty(e)}setClippable(e,t){for(let i=0,r=this.rendererObjectsList.length;i<r;i++)this.rendererObjectsList[i].setClippable(e,t);A(this,Ps)[Ps].setImageDirty(e)}setCollidable(e,t){for(let i=0,r=this.rendererObjectsList.length;i<r;i++)this.rendererObjectsList[i].setCollidable(e,t)}setPickable(e,t){for(let i=0,r=this.rendererObjectsList.length;i<r;i++)this.rendererObjectsList[i].setPickable(e,t)}setColorize(e,t){for(let i=0,r=this.rendererObjectsList.length;i<r;i++)this.rendererObjectsList[i].setColorize(e,t)}setOpacity(e,t){for(let i=0,r=this.rendererObjectsList.length;i<r;i++)this.rendererObjectsList[i].setOpacity(e,t)}destroy(){if(!this.destroyed){A(this,rn)[rn](),A(this,Ms)[Ms].camera.onViewMatrix.unsubscribe(A(this,Ys)[Ys]);for(let e in A(this,Ws)[Ws])A(this,Ws)[Ws].hasOwnProperty(e)&&A(this,Ws)[Ws][e].destroy();for(let e=0,t=this.layerList.length;e<t;e++)this.layerList[e].destroy();for(let e in this.rendererObjects)this.rendererObjects[e].destroy();A(this,Ws)[Ws]={},A(this,Us)[Us]={},this.layerList=[],this.rendererGeometries={},this.rendererTextures={},this.rendererTextureSets={},this.rendererMeshes={},this.rendererViewObjects={},this.onBuilt.clear(),super.destroy()}}}function an(e){const t=e.textures,i=e.geometries,r=e.meshes,s=e.objects;if(t)for(let e in t){const i=t[e];A(this,Qs)[Qs](i)}if(i)for(let e in i){const t=i[e];A(this,Js)[Js](t)}if(r)for(let e in r){const t=r[e];A(this,en)[en](t)}if(s)for(let e in s){const t=s[e];A(this,tn)[tn](t)}for(let e in A(this,Ws)[Ws])A(this,Ws)[Ws].hasOwnProperty(e)&&A(this,Ws)[Ws][e].build();for(let e=0,t=this.rendererObjectsList.length;e<t;e++)this.rendererObjectsList[e].build();for(let e=0,t=this.rendererObjectsList.length;e<t;e++)this.rendererObjectsList[e].finalize2()}function ln(e){const t=e.id;if(this.rendererTextures[t])throw new Error("RendererTexture already created: "+t);const i=new _({gl:A(this,Cs)[Cs].gl});if(e.preloadColor&&i.setPreloadColor(e.preloadColor),e.image){const t=e.image;t.crossOrigin="Anonymous",i.setImage(t,{minFilter:e.minFilter,magFilter:e.magFilter,wrapS:e.wrapS,wrapT:e.wrapT,wrapR:e.wrapR,flipY:e.flipY,encoding:e.encoding})}else if(e.src){const t=e.src.split(".").pop();switch(t){case"jpeg":case"jpg":case"png":case"gif":const r=new Image;r.onload=()=>{i.setImage(r,{minFilter:e.minFilter,magFilter:e.magFilter,wrapS:e.wrapS,wrapT:e.wrapT,wrapR:e.wrapR,flipY:e.flipY,encoding:e.encoding})},r.src=e.src;break;default:A(this,Hs)[Hs]?function(e,t,i){var r=function(e){};t=t||r,i=i||r;var s=e.match(/^data:(.*?)(;base64)?,(.*)$/);if(s){var n=!!s[2],o=s[3];o=window.decodeURIComponent(o),n&&(o=window.atob(o));try{for(var h=new ArrayBuffer(o.length),a=new Uint8Array(h),l=0;l<o.length;l++)a[l]=o.charCodeAt(l);window.setTimeout(function(){t(h)},0)}catch(e){window.setTimeout(function(){i(e)},0)}}else{var c=new XMLHttpRequest;c.open("GET",e,!0),c.responseType="arraybuffer",c.onreadystatechange=function(){4===c.readyState&&(200===c.status?t(c.response):i("loadArrayBuffer error : "+c.response))},c.send(null)}}(e.src,e=>{e.byteLength?A(this,Hs)[Hs].transcode([e]).then(e=>{i.setCompressedData(e),A(this,Ps)[Ps].setImageDirty()}):this.error("Can't create texture from 'src': file data is zero length")},e=>{this.error(`Can't create texture from 'src': ${e}`)}):this.error(`Can't create texture from 'src' - rendererModel needs to be configured with a TextureTranscoder for this file type ('${t}')`)}}else e.buffers&&(A(this,Hs)[Hs]?A(this,Hs)[Hs].transcode(e.buffers).then(e=>{i.setCompressedData(e),A(this,Ps)[Ps].setImageDirty()}):this.error("Can't create texture from 'buffers' - rendererModel needs to be configured with a TextureTranscoder for this option"));const r=new ds(e,i);e.rendererTexture=r,this.rendererTextures[t]=r}function cn(e){const t=e.id;if(this.rendererGeometries[t])throw new Error(`GeometryRenderer already created: ${t}`);const i=new cs;this.rendererGeometries[t]=i,e.rendererGeometry=i,A(this,Fs)[Fs]++}function dn(e){const t=this.rendererGeometries[e.geometry.id];if(!t)throw new Error("RendererGeometry not found");const i=this.rendererTextureSets[e.textureSet.id];if(!i)throw new Error("rendererTextureSet not found");const r=A(this,nn)[nn](e.textureSet.id,e.geometry);if(!r)return;let s;r.hasGeometry(e.geometry.id)||r.createGeometryCompressed(e.geometry),A(this,qs)[qs]&&A(this,Ds),s=e.matrix;const n=e.color?new Uint8Array([Math.floor(255*e.color[0]),Math.floor(255*e.color[1]),Math.floor(255*e.color[2])]):[255,255,255],o=null!=e.opacity?Math.floor(255*e.opacity):255,h=null!=e.metallic?Math.floor(255*e.metallic):0,a=null!=e.roughness?Math.floor(255*e.roughness):255,l=new ws({tileManager:A(this,Ps)[Ps].tileManager,id:e.id,layer:r,color:n,opacity:o,matrix:s,metallic:h,roughness:a,rendererTextureSet:i,rendererGeometry:t,meshIndex:0});l.pickId=A(this,Ps)[Ps].registerPickable(l);const c=new Uint8Array([255&l.pickId,l.pickId>>8&255,l.pickId>>16&255,l.pickId>>24&255]);bt(l.aabb);const d=r.createMesh({id:e.id,geometryId:e.geometry.id,color:n,opacity:o,metallic:h,roughness:a,matrix:s,pickColor:c});A(this,Fs)[Fs]++,xt(A(this,zs)[zs],l.aabb),l.layer=r,l.meshIndex=d,this.rendererMeshes[e.id]=l}function un(e){let t=e.id;void 0===t?t=N():this.rendererObjects[t]&&(this.error("[createObject] rendererModel already has a ViewerObject with this ID: "+t+" - will assign random ID"),t=N());const i=e.meshes;if(void 0===i)throw new Error("[createObject] Param expected: meshes");const r=[];for(let e=0,t=i.length;e<t;e++)r.push(this.rendererMeshes[i[e].id]);const s=new Ts({id:t,rendererModel:this,rendererMeshes:r,aabb:e.aabb,layerId:A(this,Ks)[Ks]});this.rendererObjectsList.push(s),this.rendererObjects[t]=s,this.rendererViewObjects[t]=s,A(this,ks)[ks]++}function fn(){const e=this.sceneModel;if(!e)return;const t=e.textures,i=e.geometries,r=e.meshes,s=e.objects;if(t)for(let e in t){const i=t[e];i.rendererTexture&&(i.rendererTexture=null)}if(i)for(let e in i){const t=i[e];t.rendererGeometry&&(t.rendererGeometry=null)}if(r)for(let e in r){const t=r[e];t.rendererMesh&&(t.rendererMesh=null)}if(s)for(let e in s){const t=s[e];t.rendererObject&&(t.rendererObject=null)}this.sceneModel=null}function pn(){const e=new ds(null,new _({gl:A(this,Cs)[Cs].gl,preloadColor:[1,1,1,1]})),t=new ds(null,new _({gl:A(this,Cs)[Cs].gl,preloadColor:[0,1,1,1]})),i=new ds(null,new _({gl:A(this,Cs)[Cs].gl,preloadColor:[0,0,0,0]})),r=new ds(null,new _({gl:A(this,Cs)[Cs].gl,preloadColor:[0,0,0,1]})),s=new ds(null,new _({gl:A(this,Cs)[Cs].gl,preloadColor:[1,1,1,1]}));this.rendererTextures.defaultColorTexture=e,this.rendererTextures.defaultMetalRoughTexture=t,this.rendererTextures.defaultNormalsTexture=i,this.rendererTextures.defaultEmissiveTexture=r,this.rendererTextures.defaultOcclusionTexture=s,this.rendererTextureSets[ys]=new _s({id:ys,colorTexture:e,metallicRoughnessTexture:t,emissiveTexture:r,occlusionTexture:s})}function gn(e,t){const i=`${e}_${t.primitive}`;let r,s=A(this,Ws)[Ws][i];if(s){if(s.canCreateMesh(t))return s;s.build(),delete A(this,Ws)[Ws][i]}if(!e||(r=this.rendererTextureSets[e],r))return s=new ns({gl:A(this,Cs)[Cs].gl,view:A(this,Ms)[Ms],rendererModel:this,primitive:t.primitive,textureSet:r,layerIndex:0}),A(this,Us)[Us][i]=s,this.layerList.push(s),A(this,Ws)[Ws][i]=s,s;this.error(`TextureSet not found: ${e} - ensure that you create it first with createTextureSet()`)}function vn(){bt(A(this,zs)[zs]);for(let e=0,t=this.rendererObjectsList.length;e<t;e++){const t=this.rendererObjectsList[e];xt(A(this,zs)[zs],t.aabb)}A(this,Xs)[Xs]=!1}h();var mn=new Float32Array(16),En=new Float64Array(4),Tn=new Float64Array(4);function bn(e,t,i){return void 0===i&&(i=mn),En[0]=t[0],En[1]=t[1],En[2]=t[2],En[3]=1,E(e,En,Tn),T(e,Tn,i),i}function xn(e,t,i){return void 0===i&&(i=200),t[0]=Math.round(e[0]/i)*i,t[1]=Math.round(e[1]/i)*i,t[2]=Math.round(e[2]/i)*i,t}const wn=2e3;var _n=/*#__PURE__*/D("gl"),yn=/*#__PURE__*/D("indexesUsed"),Mn=/*#__PURE__*/D("tiles"),Pn=/*#__PURE__*/D("dataTexture"),Cn=/*#__PURE__*/D("camera"),In=/*#__PURE__*/D("lastFreeIndex"),Rn=/*#__PURE__*/D("putFreeTile"),Sn=/*#__PURE__*/D("findFreeTile");class On{constructor(e){Object.defineProperty(this,Sn,{value:An}),Object.defineProperty(this,Rn,{value:Dn}),Object.defineProperty(this,_n,{writable:!0,value:void 0}),Object.defineProperty(this,yn,{writable:!0,value:void 0}),Object.defineProperty(this,Mn,{writable:!0,value:void 0}),Object.defineProperty(this,Pn,{writable:!0,value:void 0}),Object.defineProperty(this,Cn,{writable:!0,value:void 0}),Object.defineProperty(this,In,{writable:!0,value:void 0}),A(this,Cn)[Cn]=e.camera,A(this,_n)[_n]=e.gl,A(this,yn)[yn]=[],A(this,In)[In]=0,A(this,Mn)[Mn]={},A(this,Pn)[Pn]=function(e,t){const i=wn;if(0==i)throw"texture height == 0";const r=new Lr(48*i),s=e.createTexture();return s?(e.bindTexture(e.TEXTURE_2D,s),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA16F,12,i),e.texSubImage2D(e.TEXTURE_2D,0,0,0,12,i,e.RGBA,e.HALF_FLOAT,new Uint16Array(r.buffer),0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new w({gl:e,texture:s,textureWidth:12,textureHeight:i})):Fr}(A(this,_n)[_n])}getTile(e){const i=xn(e,h()),r=`${i[0]}-${i[1]}-${i[2]}`;let s=A(this,Mn)[Mn][r];return s||(s={id:r,index:A(this,Sn)[Sn](),useCount:0,center:h(),rtcViewMatrix:t()},A(this,Mn)[Mn][s.id]=s),s.useCount++,s}putTile(e){--e.useCount<=0&&(delete A(this,Mn)[Mn][e.id],A(this,Rn)[Rn](e.index))}updateTileCenter(e,i){const r=xn(i,h()),s=`${r[0]}-${r[1]}-${r[2]}`;if(s===e.id)return e;this.putTile(e);let n=A(this,Mn)[Mn][s];return n||(n={id:s,index:A(this,Sn)[Sn](),useCount:0,center:h(),rtcViewMatrix:t()},A(this,Mn)[Mn][n.id]=n),n.useCount++,n}refreshMatrices(){if(!A(this,Pn)[Pn].texture)return;const e=A(this,_n)[_n],t=A(this,Cn)[Cn].viewMatrix,i=Object.keys(A(this,Mn)[Mn]),r=new Float32Array(16*i.length);for(let e=0,s=i.length;e<s;e++){const s=i[e],n=A(this,Mn)[Mn][s];bn(t,n.center,n.rtcViewMatrix),r.set(n.rtcViewMatrix,16*n.index)}e.bindTexture(e.TEXTURE_2D,A(this,Pn)[Pn].texture),e.texSubImage2D(e.TEXTURE_2D,0,0,0,1,1,e.RGBA,e.FLOAT,r),e.bindTexture(e.TEXTURE_2D,null)}}function Dn(e){delete A(this,yn)[yn][e],A(this,In)[In]=e}function An(){for(let e=A(this,In)[In];;e=(e+1)%wn)if(!A(this,yn)[yn][e])return A(this,yn)[yn][e]=!0,e}const Bn=navigator.userAgent.match(/(opera|chrome|safari|firefox|msie|mobile)\/?\s*(\.?\d+(\.\d+)*)/i),Ln=Bn&&"safari"===Bn[1].toLowerCase();var Un=/*#__PURE__*/D("sceneModels"),Fn=/*#__PURE__*/D("viewer"),jn=/*#__PURE__*/D("view"),Gn=/*#__PURE__*/D("renderContext"),Nn=/*#__PURE__*/D("canvasTransparent"),kn=/*#__PURE__*/D("transparentEnabled"),Hn=/*#__PURE__*/D("edgesEnabled"),Xn=/*#__PURE__*/D("imageDirty"),Vn=/*#__PURE__*/D("saoEnabled"),Wn=/*#__PURE__*/D("pbrEnabled"),zn=/*#__PURE__*/D("backgroundColor"),$n=/*#__PURE__*/D("rendererModels"),qn=/*#__PURE__*/D("layerList"),Yn=/*#__PURE__*/D("layerListDirty"),Kn=/*#__PURE__*/D("stateSortDirty"),Zn=/*#__PURE__*/D("pickIDs"),Qn=/*#__PURE__*/D("saoDepthRenderBuffer"),Jn=/*#__PURE__*/D("renderBufferManager"),eo=/*#__PURE__*/D("extensionHandles"),to=/*#__PURE__*/D("logarithmicDepthBufferEnabled"),io=/*#__PURE__*/D("alphaDepthMask"),ro=/*#__PURE__*/D("occlusionTester"),so=/*#__PURE__*/D("textureTranscoder"),no=/*#__PURE__*/D("layerRenderers"),oo=/*#__PURE__*/D("viewMatrixDirty"),ho=/*#__PURE__*/D("registerRendererViewObjects"),ao=/*#__PURE__*/D("deregisterRendererViewObjects"),lo=/*#__PURE__*/D("updateLayerList"),co=/*#__PURE__*/D("buildLayerList"),uo=/*#__PURE__*/D("draw"),fo=/*#__PURE__*/D("activateExtensions"),po=/*#__PURE__*/D("drawSAOBuffers"),go=/*#__PURE__*/D("drawDepth"),vo=/*#__PURE__*/D("drawColor"),mo=/*#__PURE__*/D("drawLayer");class Eo{constructor(e){Object.defineProperty(this,mo,{value:Io}),Object.defineProperty(this,vo,{value:Co}),Object.defineProperty(this,go,{value:Po}),Object.defineProperty(this,po,{value:Mo}),Object.defineProperty(this,fo,{value:yo}),Object.defineProperty(this,uo,{value:_o}),Object.defineProperty(this,co,{value:wo}),Object.defineProperty(this,lo,{value:xo}),Object.defineProperty(this,ao,{value:bo}),Object.defineProperty(this,ho,{value:To}),this.rendererViewObjects=void 0,this.tileManager=void 0,Object.defineProperty(this,Un,{writable:!0,value:void 0}),Object.defineProperty(this,Fn,{writable:!0,value:void 0}),Object.defineProperty(this,jn,{writable:!0,value:void 0}),Object.defineProperty(this,Gn,{writable:!0,value:void 0}),Object.defineProperty(this,Nn,{writable:!0,value:void 0}),Object.defineProperty(this,kn,{writable:!0,value:void 0}),Object.defineProperty(this,Hn,{writable:!0,value:void 0}),Object.defineProperty(this,Xn,{writable:!0,value:void 0}),Object.defineProperty(this,Vn,{writable:!0,value:void 0}),Object.defineProperty(this,Wn,{writable:!0,value:void 0}),Object.defineProperty(this,zn,{writable:!0,value:void 0}),Object.defineProperty(this,$n,{writable:!0,value:void 0}),Object.defineProperty(this,qn,{writable:!0,value:void 0}),Object.defineProperty(this,Yn,{writable:!0,value:void 0}),Object.defineProperty(this,Kn,{writable:!0,value:void 0}),Object.defineProperty(this,Zn,{writable:!0,value:new G({})}),Object.defineProperty(this,Qn,{writable:!0,value:void 0}),Object.defineProperty(this,Jn,{writable:!0,value:void 0}),Object.defineProperty(this,eo,{writable:!0,value:void 0}),Object.defineProperty(this,to,{writable:!0,value:void 0}),Object.defineProperty(this,io,{writable:!0,value:void 0}),Object.defineProperty(this,ro,{writable:!0,value:void 0}),Object.defineProperty(this,so,{writable:!0,value:void 0}),Object.defineProperty(this,no,{writable:!0,value:void 0}),Object.defineProperty(this,oo,{writable:!0,value:void 0}),this.tileManager=null,A(this,Un)[Un]={},this.rendererViewObjects={},A(this,so)[so]=e.textureTranscoder||new ue({}),A(this,Nn)[Nn]=!1,A(this,io)[io]=!1,A(this,eo)[eo]={},A(this,Zn)[Zn]=new G({}),A(this,qn)[qn]=[],A(this,Yn)[Yn]=!0,A(this,Kn)[Kn]=!0,A(this,Xn)[Xn]=!0,A(this,kn)[kn]=!0,A(this,Hn)[Hn]=!0,A(this,Vn)[Vn]=!0,A(this,Wn)[Wn]=!0,A(this,zn)[zn]=h(),A(this,ro)[ro]=null,A(this,to)[to]=!1,A(this,$n)[$n]={},A(this,oo)[oo]=!0}init(e){A(this,Fn)[Fn]=e,A(this,so)[so].init(A(this,Fn)[Fn].capabilities)}getCapabilities(e){e.maxViews=1;const t=document.createElement("canvas");let i;try{i=t.getContext("webgl2")}catch(e){console.error("Failed to get a WebGL context")}i&&(e.astcSupported=!!y(i,"WEBGL_compressed_texture_astc"),e.etc1Supported=!0,e.etc2Supported=!!y(i,"WEBGL_compressed_texture_etc"),e.dxtSupported=!!y(i,"WEBGL_compressed_texture_s3tc"),e.bptcSupported=!!y(i,"EXT_texture_compression_bptc"),e.pvrtcSupported=!(!y(i,"WEBGL_compressed_texture_pvrtc")&&!y(i,"WEBKIT_WEBGL_compressed_texture_pvrtc")))}registerView(e){if(A(this,Gn)[Gn])throw"Only one View allowed with WebGLRenderer (see WebViewerCapabilities.maxViews)";A(this,jn)[jn]=e;const t=["webglutils"],i=e.canvasElement,r={};let s=null;for(let e=0;!s&&e<t.length;e++)try{s=i.getContext(t[e],r)}catch(e){}return s?(s&&s.hint(s.FRAGMENT_SHADER_DERIVATIVE_HINT,s.NICEST),A(this,Gn)[Gn]=new ge(A(this,Fn)[Fn],A(this,jn)[jn],s),this.tileManager=new On({camera:e.camera,gl:s}),A(this,no)[no]={colorTriangles:new Et(A(this,Gn)[Gn])},e.camera.onViewMatrix.sub(()=>{A(this,oo)[oo]=!0}),0):(console.error("Failed to get a WebGL2 context"),0)}deregisterView(e){}addModel(e){if(!A(this,Gn)[Gn])throw new Error("Must register a View before you add a SceneModel");const t=new hn(function(e,t){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t}({sceneModel:e.sceneModel,view:A(this,jn)[jn],textureTranscoder:A(this,so)[so],webglRenderer:this,renderContext:A(this,Gn)[Gn],layerId:e.layerId},e));A(this,$n)[$n][t.id]=t,A(this,ho)[ho](t),A(this,Yn)[Yn]=!0,t.onDestroyed.one(e=>{const t=A(this,$n)[$n][e.id];delete A(this,$n)[$n][e.id],A(this,ao)[ao](t),A(this,Yn)[Yn]=!0})}removeModel(e){if(A(this,Un)[Un][e]){const t=A(this,$n)[$n][e];delete A(this,$n)[$n][e],A(this,ao)[ao](t),A(this,Yn)[Yn]=!0}}registerPickable(e){return A(this,Zn)[Zn].addItem(e)}deregisterPickable(e){A(this,Zn)[Zn].removeItem(e)}setImageDirty(e){A(this,Xn)[Xn]=!0}setBackgroundColor(e,t){A(this,zn)[zn].set(t),A(this,Xn)[Xn]=!0}setEdgesEnabled(e,t){A(this,Hn)[Hn]=t,A(this,Xn)[Xn]=!0}setPBREnabled(e,t){A(this,Wn)[Wn]=t,A(this,Xn)[Xn]=!0}getSAOSupported(){return Ln&&b.SUPPORTED_EXTENSIONS.OES_standard_derivatives}setSAOEnabled(e,t){A(this,Vn)[Vn]=t,A(this,Xn)[Xn]=!0}setTransparentEnabled(e,t){A(this,kn)[kn]=t,A(this,Xn)[Xn]=!0}clear(e){const t=A(this,Gn)[Gn].gl;t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),A(this,Nn)[Nn]?t.clearColor(1,1,1,1):t.clearColor(A(this,zn)[zn][0],A(this,zn)[zn][1],A(this,zn)[zn][2],1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}needsRebuild(e){for(let e in A(this,no)[no])A(this,no)[no][e].needRebuild()}needsRender(e){return A(this,Xn)[Xn]||A(this,Yn)[Yn]||A(this,Kn)[Kn]}render(e,t){(t=t||{}).force&&(A(this,Xn)[Xn]=!0),A(this,oo)[oo]&&(this.tileManager.refreshMatrices(),A(this,oo)[oo]=!1),A(this,lo)[lo](),A(this,Xn)[Xn]&&(A(this,uo)[uo]({clear:!0}),A(this,Xn)[Xn]=!1)}pickSceneObject(e,t){return null}}function To(e){const t=e.rendererViewObjects;for(let e in t)this.rendererViewObjects[e]=t[e]}function bo(e){const t=e.rendererViewObjects;for(let e in t)delete this.rendererViewObjects[e]}function xo(){A(this,Yn)[Yn]&&(A(this,co)[co](),A(this,Yn)[Yn]=!1,A(this,Kn)[Kn]=!0),A(this,Kn)[Kn]&&(A(this,Kn)[Kn]=!1,A(this,Xn)[Xn]=!0)}function wo(){let e=0;for(let t in A(this,$n)[$n]){const i=A(this,$n)[$n][t];for(let t=0,r=i.layerList.length;t<r;t++)A(this,qn)[qn][e++]=i.layerList[t]}A(this,qn)[qn].length=e}function _o(e){A(this,fo)[fo](),A(this,Vn)[Vn]&&A(this,jn)[jn].sao.possible&&A(this,po)[po](e),A(this,vo)[vo](e)}function yo(){b.SUPPORTED_EXTENSIONS.OES_element_index_uint&&(A(this,eo)[eo].OES_element_index_uint=A(this,Gn)[Gn].gl.getExtension("OES_element_index_uint")),A(this,to)[to]&&b.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(A(this,eo)[eo].EXT_frag_depth=A(this,Gn)[Gn].gl.getExtension("EXT_frag_depth")),b.SUPPORTED_EXTENSIONS.WEBGL_depth_texture&&(A(this,eo)[eo].WEBGL_depth_texture=A(this,Gn)[Gn].gl.getExtension("WEBGL_depth_texture"))}function Mo(e){}function Po(e){A(this,Gn)[Gn].reset();const t=A(this,Gn)[Gn].gl;t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),t.clearColor(0,0,0,0),t.enable(t.DEPTH_TEST),t.frontFace(t.CCW),t.enable(t.CULL_FACE),t.depthMask(!0),!1!==e.clear&&t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}function Co(e){const t=A(this,jn)[jn],i=A(this,Gn)[Gn],r=i.gl,s=[],n=[],o=[],h=[],a=[],l=[],c=[],d=[],u=[],f=[],p=[],g=[],v=[],m=[],E=[],T=[];i.reset(),i.withSAO=!1,i.pbrEnabled=A(this,Wn)[Wn]&&!!t.qualityRender,r.viewport(0,0,r.drawingBufferWidth,r.drawingBufferHeight),A(this,Nn)[Nn]?r.clearColor(0,0,0,0):r.clearColor(A(this,zn)[zn][0],A(this,zn)[zn][1],A(this,zn)[zn][2],1),r.enable(r.DEPTH_TEST),r.frontFace(r.CCW),r.enable(r.CULL_FACE),r.depthMask(!0),r.lineWidth(1),i.lineWidth=1;const x=t.sao.possible;if(A(this,Vn)[Vn]&&x){const e=A(this,Jn)[Jn].getRenderBuffer("saoOcclusion",{depthTexture:!1,size:[r.drawingBufferWidth,r.drawingBufferHeight]});i.occlusionTexture=e?e.getTexture():null}else i.occlusionTexture=null;!1!==e.clear&&r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT);let w=0,_=0,y=0,M=0,P=0,C=0,I=0,R=0,S=0,O=0,D=0,B=0,L=0,U=0,F=0,j=0;for(let e=0,i=A(this,qn)[qn].length;e<i;e++){const i=A(this,qn)[qn][e],r=i.meshCounts;r.numCulled!==r.numMeshes&&0!==r.numVisible&&(r.numTransparent<r.numMeshes&&(A(this,Vn)[Vn]&&x&&i.rendererModel.qualityRender?s[w++]=i:A(this,mo)[mo](i,it.COLOR_OPAQUE,i.rendererModel.qualityRender)),A(this,kn)[kn]&&r.numTransparent&&(o[y++]=i),r.numXRayed>0&&t.xrayMaterial.fill&&(t.xrayMaterial.fillAlpha<1?c[I++]=i:a[P++]=i),r.numHighlighted>0&&t.highlightMaterial.fill&&(t.highlightMaterial.fillAlpha<1?p[D++]=i:u[S++]=i),r.numSelected>0&&t.selectedMaterial.fill&&(t.selectedMaterial.fillAlpha<1?E[F++]=i:v[L++]=i),A(this,Hn)[Hn]&&A(this,jn)[jn].edgeMaterial.edges&&r.numEdges>0&&(r.numTransparent<r.numMeshes&&(n[_++]=i),r.numTransparent>0&&(h[M++]=i),t.selectedMaterial.edgeAlpha<1?T[j++]=i:m[U++]=i,t.xrayMaterial.edgeAlpha<1?d[R++]=i:l[C++]=i,t.highlightMaterial.edgeAlpha<1?g[B++]=i:f[O++]=i))}w>0&&(i.withSAO=!0);for(let e=0;e<_;e++)A(this,mo)[mo](n[e],it.EDGES_COLOR_OPAQUE);for(let e=0;e<P;e++)A(this,mo)[mo](a[e],it.SILHOUETTE_XRAYED);for(let e=0;e<C;e++)A(this,mo)[mo](l[e],it.EDGES_XRAYED);if(I>0||R>0||y>0||M>0){r.enable(r.CULL_FACE),r.enable(r.BLEND),A(this,Nn)[Nn]?(r.blendEquation(r.FUNC_ADD),r.blendFuncSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA)):(r.blendEquation(r.FUNC_ADD),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA)),i.backfaces=!1,A(this,io)[io]||r.depthMask(!1);for(let e=0;e<R;e++)A(this,mo)[mo](d[e],it.EDGES_XRAYED);for(let e=0;e<I;e++)A(this,mo)[mo](c[e],it.SILHOUETTE_XRAYED);(y>0||M>0)&&r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA);for(let e=0;e<M;e++)A(this,mo)[mo](h[e],it.EDGES_COLOR_TRANSPARENT);for(let e=0;e<y;e++)A(this,mo)[mo](o[e],it.COLOR_TRANSPARENT);r.disable(r.BLEND),A(this,io)[io]||r.depthMask(!0)}if(S>0||O>0){i.lastProgramId=-1,r.clear(r.DEPTH_BUFFER_BIT);for(let e=0;e<O;e++)A(this,mo)[mo](f[e],it.EDGES_HIGHLIGHTED);for(let e=0;e<S;e++)A(this,mo)[mo](u[e],it.SILHOUETTE_HIGHLIGHTED)}if(D>0||B>0||S>0){i.lastProgramId=-1,r.clear(r.DEPTH_BUFFER_BIT),r.enable(r.CULL_FACE),r.enable(r.BLEND),A(this,Nn)[Nn]?(r.blendEquation(r.FUNC_ADD),r.blendFuncSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA)):r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA);for(let e=0;e<B;e++)A(this,mo)[mo](g[e],it.EDGES_HIGHLIGHTED);for(let e=0;e<D;e++)A(this,mo)[mo](p[e],it.SILHOUETTE_HIGHLIGHTED);r.disable(r.BLEND)}if(L>0||U>0){i.lastProgramId=-1,r.clear(r.DEPTH_BUFFER_BIT);for(let e=0;e<U;e++)A(this,mo)[mo](m[e],it.EDGES_SELECTED);for(let e=0;e<L;e++)A(this,mo)[mo](v[e],it.SILHOUETTE_SELECTED)}if(F>0||j>0){i.lastProgramId=-1,r.clear(r.DEPTH_BUFFER_BIT),r.enable(r.CULL_FACE),r.enable(r.BLEND),A(this,Nn)[Nn]?(r.blendEquation(r.FUNC_ADD),r.blendFuncSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA)):r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA);for(let e=0;e<j;e++)A(this,mo)[mo](T[e],it.EDGES_SELECTED);for(let e=0;e<F;e++)A(this,mo)[mo](E[e],it.SILHOUETTE_SELECTED);r.disable(r.BLEND)}const G=b.MAX_TEXTURE_UNITS;for(let e=0;e<G;e++)r.activeTexture(r.TEXTURE0+e);r.bindTexture(r.TEXTURE_CUBE_MAP,null),r.bindTexture(r.TEXTURE_2D,null);const N=b.MAX_VERTEX_ATTRIBS;for(let e=0;e<N;e++)r.disableVertexAttribArray(e)}function Io(e,t,i=!0){switch(e.renderState.primitive){case 20002:case 20004:case 20003:switch(t){case it.COLOR_OPAQUE:if(e.meshCounts.numTransparent===e.meshCounts.numMeshes||e.meshCounts.numXRayed===e.meshCounts.numMeshes)return;i||A(this,no)[no].colorTriangles.draw(e);break;case it.COLOR_TRANSPARENT:if(0===e.meshCounts.numTransparent)return;i||A(this,no)[no].colorTriangles.draw(e)}}}export{Eo as WebGLRenderer};
//# sourceMappingURL=index.modern.mjs.map
