!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("pako"),require("@xeokit/core")):"function"==typeof define&&define.amd?define(["exports","pako","@xeokit/core"],t):t((e||self).xkt={},e.pako,e.core)}(this,function(e,t,r){function i(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var i=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,i.get?i:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,t}var a=/*#__PURE__*/i(t);function o(e){function t(e,t){return 0===e.length?[]:a.inflate(e,t).buffer}return{metadata:JSON.parse(a.inflate(e.metadata,{to:"string"})),textureData:new Uint8Array(t(e.textureData)),eachTextureDataPortion:new Uint32Array(t(e.eachTextureDataPortion)),eachTextureAttributes:new Uint16Array(t(e.eachTextureAttributes)),positions:new Uint16Array(t(e.positions)),colors:new Uint8Array(t(e.colors)),uvs:new Float32Array(t(e.uvs)),indices8Bit:new Uint8Array(t(e.indices8Bit)),indices16Bit:new Uint16Array(t(e.indices16Bit)),indices32Bit:new Uint32Array(t(e.indices32Bit)),edgeIndices8Bit:new Uint8Array(t(e.edgeIndices8Bit)),edgeIndices16Bit:new Uint16Array(t(e.edgeIndices16Bit)),edgeIndices32Bit:new Uint32Array(t(e.edgeIndices32Bit)),eachTextureSetTextures:new Int32Array(t(e.eachTextureSetTextures)),decodeMatrices:new Float32Array(t(e.decodeMatrices)),eachBucketPositionsPortion:new Uint32Array(t(e.eachBucketPositionsPortion)),eachBucketColorsPortion:new Uint32Array(t(e.eachBucketColorsPortion)),eachBucketUVsPortion:new Uint32Array(t(e.eachBucketUVsPortion)),eachBucketIndicesPortion:new Uint32Array(t(e.eachBucketIndicesPortion)),eachBucketEdgeIndicesPortion:new Uint32Array(t(e.eachBucketEdgeIndicesPortion)),eachBucketIndicesBitness:new Uint8Array(t(e.eachBucketIndicesBitness)),eachGeometryPrimitiveType:new Uint8Array(t(e.eachGeometryPrimitiveType)),eachGeometryBucketPortion:new Uint32Array(t(e.eachGeometryBucketPortion)),eachGeometryDecodeMatricesPortion:new Uint32Array(t(e.eachGeometryDecodeMatricesPortion)),matrices:new Float32Array(t(e.matrices)),eachMeshGeometriesPortion:new Uint32Array(t(e.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(t(e.eachMeshMatricesPortion)),eachMeshTextureSet:new Uint32Array(t(e.eachMeshTextureSet)),eachMeshMaterialAttributes:new Uint8Array(t(e.eachMeshMaterialAttributes)),eachObjectId:JSON.parse(a.inflate(e.eachObjectId,{to:"string"})),eachObjectMeshesPortion:new Uint32Array(t(e.eachObjectMeshesPortion))}}function s(e){var t=new DataView(e),r=new Uint8Array(e);t.getUint32(0,!0);for(var i=t.getUint32(4,!0),a=[],o=4*(i+2),s=0;s<i;s++){var c=t.getUint32(4*(s+2),!0);a.push(r.subarray(o,o+c)),o+=c}var n=0;return{metadata:a[n++],textureData:a[n++],eachTextureDataPortion:a[n++],eachTextureAttributes:a[n++],positions:a[n++],colors:a[n++],uvs:a[n++],indices8Bit:a[n++],indices16Bit:a[n++],indices32Bit:a[n++],edgeIndices8Bit:a[n++],edgeIndices16Bit:a[n++],edgeIndices32Bit:a[n++],eachTextureSetTextures:a[n++],decodeMatrices:a[n++],eachBucketPositionsPortion:a[n++],eachBucketColorsPortion:a[n++],eachBucketUVsPortion:a[n++],eachBucketIndicesPortion:a[n++],eachBucketEdgeIndicesPortion:a[n++],eachBucketIndicesBitness:a[n++],eachGeometryPrimitiveType:a[n++],eachGeometryBucketPortion:a[n++],eachGeometryDecodeMatricesPortion:a[n++],matrices:a[n++],eachMeshGeometriesPortion:a[n++],eachMeshMatricesPortion:a[n++],eachMeshTextureSet:a[n++],eachMeshMaterialAttributes:a[n++],eachObjectId:a[n++],eachObjectMeshesPortion:a[n++]}}var c,n=1001,d=(c=new Float32Array(3),function(e){return c[0]=e[0]/255,c[1]=e[1]/255,c[2]=e[2]/255,c});e.loadXKT=function(e){if(e.sceneModel.destroyed)throw new Error("SceneModel already destroyed");if(e.sceneModel.built)throw new r.SDKError("SceneModel already built");if(e.dataModel){if(e.dataModel.destroyed)throw new r.SDKError("DataModel already destroyed");if(e.dataModel.built)throw new r.SDKError("DataModel already built")}return new Promise(function(t,r){!function(e){var t=e.xktData,r=e.sceneModel,i=e.dataModel;i&&t.metadata&&i.fromJSON(t.metadata);for(var a=t.eachTextureDataPortion.length,o=t.eachTextureSetTextures.length/5,s=t.eachBucketPositionsPortion.length,c=t.eachObjectMeshesPortion.length,n=0,u={},h=0;h<a;h++){var l=t.eachTextureDataPortion[h],f=h===a-1?t.textureData.length:t.eachTextureDataPortion[h+1],g=9*h,y=1===t.eachTextureAttributes[g],P=t.eachTextureAttributes[g+1],B=t.eachTextureAttributes[g+4],m=t.eachTextureAttributes[g+5],b=t.eachTextureAttributes[g+6],M=t.eachTextureAttributes[g+7],x=t.eachTextureAttributes[g+8];if(f-l>0){var T=new Uint8Array(t.textureData.subarray(l,f)).buffer,A="texture-"+h;if(y)r.createTexture({id:A,buffers:[T],minFilter:B,magFilter:m,wrapS:b,wrapT:M,wrapR:x});else{var w=new Blob([T],{type:10001===P?"image/jpeg":10002===P?"image/png":"image/gif"}),p=(window.URL||window.webkitURL).createObjectURL(w),k=document.createElement("img");k.src=p,r.createTexture({id:A,image:k,mediaType:P,minFilter:B,magFilter:m,wrapS:b,wrapT:M,wrapR:x})}}}for(var I=0;I<o;I++){var v=5*I,U=t.eachTextureSetTextures[v],S=t.eachTextureSetTextures[v+1],D=t.eachTextureSetTextures[v+2],G=t.eachTextureSetTextures[v+3],O=t.eachTextureSetTextures[v+4];r.createTextureSet({id:"textureSet-"+I,colorTextureId:U>=0?"texture-"+U:void 0,normalsTextureId:D>=0?"texture-"+D:void 0,metallicRoughnessTextureId:S>=0?"texture-"+S:void 0,emissiveTextureId:G>=0?"texture-"+G:void 0,occlusionTextureId:O>=0?"texture-"+O:void 0})}for(var j=0;j<=c;j++){for(var C=t.eachObjectId[j],F=j===c-1?t.eachMeshGeometriesPortion.length-1:t.eachObjectMeshesPortion[j+1]-1,E=[],K=t.eachObjectMeshesPortion[j];K<=F;K++){var R=t.eachMeshGeometriesPortion[K],V=t.eachMeshTextureSet[K],J=V>=0?"textureSet-"+V:void 0,N=d(t.eachMeshMaterialAttributes.subarray(6*K,6*K+3)),L=t.eachMeshMaterialAttributes[6*K+3]/255,q=t.eachMeshMaterialAttributes[6*K+4]/255,X=t.eachMeshMaterialAttributes[6*K+5]/255,_="mesh-"+n++,z=t.eachMeshMatricesPortion[K],H=t.matrices.slice(z,z+16),Q="geometry."+R;if(!u[Q]){var W={geometryBuckets:[]};W.primitive=t.eachGeometryPrimitiveType[R];var Y=t.eachGeometryDecodeMatricesPortion[R];W.positionsDecompressMatrix=t.eachGeometryDecodeMatricesPortion.slice(Y,Y+16);for(var Z=t.eachGeometryBucketPortion[R],$=Z===s-1,ee=$?t.eachMeshGeometriesPortion.length-1:t.eachObjectMeshesPortion[j+1]-1,te=Z;te<=ee;te++){var re={positionsCompressed:[],indices:[]},ie=t.eachBucketIndicesBitness[te],ae=8===ie?t.indices8Bit:16===ie?t.indices16Bit:t.indices32Bit,oe=8===ie?t.edgeIndices8Bit:16===ie?t.edgeIndices16Bit:t.edgeIndices32Bit,se=!1;switch(W.primitive){case 20002:re.positionsCompressed=t.positions.subarray(t.eachBucketPositionsPortion[te],$?t.positions.length:t.eachBucketPositionsPortion[te+1]),re.indices=ae.subarray(t.eachBucketIndicesPortion[te],$?ae.length:t.eachBucketIndicesPortion[te+1]),re.edgeIndices=oe.subarray(t.eachBucketEdgeIndicesPortion[te],$?oe.length:t.eachBucketEdgeIndicesPortion[te+1]),se=re.positionsCompressed.length>0&&re.indices.length>0;break;case 2e4:re.positionsCompressed=t.positions.subarray(t.eachBucketPositionsPortion[te],$?t.positions.length:t.eachBucketPositionsPortion[te+1]),se=re.positionsCompressed.length>0;break;case 20001:re.positionsCompressed=t.positions.subarray(t.eachBucketPositionsPortion[te],$?t.positions.length:t.eachBucketPositionsPortion[te+1]),re.indices=ae.subarray(t.eachBucketIndicesPortion[te],$?ae.length:t.eachBucketIndicesPortion[te+1]),se=re.positionsCompressed.length>0&&re.indices.length>0;break;default:continue}se&&W.geometryBuckets.push(re)}W.geometryBuckets.length>0&&(r.createGeometryCompressed(W),u[Q]=!0)}r.createMesh({id:_,geometryId:Q,textureSetId:J,matrix:H,color:N,metallic:q,roughness:X,opacity:L}),E.push(_)}E.length>0&&r.createObject({id:C,meshIds:E})}}({xktData:o(s(e.data)),sceneModel:e.sceneModel,dataModel:e.dataModel}),t()})},e.saveXKT=function(e){if(e.sceneModel.destroyed)throw new r.SDKError("SceneModel already destroyed");if(!e.sceneModel.built)throw new r.SDKError("SceneModel not yet built");if(e.dataModel){if(e.dataModel.destroyed)throw new r.SDKError("DataModel already destroyed");if(!e.dataModel.built)throw new r.SDKError("DataModel not yet built")}return i=function(e){for(var t,r=e.sceneModel,i=e.dataModel,a=Object.values(r.geometries),o=Object.values(r.textures),s=Object.values(r.textureSets),c=Object.values(r.meshes),d=Object.values(r.objects),u=a.length,h=o.length,l=s.length,f=c.length,g=d.length,y=0,P=0,B=0,m=0,b=0,M=0,x=0,T=0,A=0,w=0,p={},k={},I={},v=0;v<u;v++){var U=a[v].geometryBuckets;y+=U.length;for(var S=0,D=U.length;S<D;S++){var G=U[S];if(G.positionsCompressed){var O=G.positionsCompressed.length/3;P+=G.positionsCompressed.length,G.indices&&(O<=256?m+=G.indices.length:O<=65536?b+=G.indices.length:M+=G.indices.length),G.edgeIndices&&(O<=256?x+=G.edgeIndices.length:O<=65536?T+=G.edgeIndices.length:A+=G.edgeIndices.length),G.uvsCompressed&&(B+=G.uvsCompressed.length)}}}for(var j=0;j<h;j++)w+=o[j].imageData.byteLength;t=16*u;var C={metadata:i?i.getJSON():{},textureData:new Uint8Array(w),eachTextureDataPortion:new Uint32Array(h),eachTextureAttributes:new Uint16Array(9*h),positions:new Uint16Array(P),colors:new Uint8Array(0),uvs:new Float32Array(B),indices8Bit:new Uint8Array(m),indices16Bit:new Uint16Array(b),indices32Bit:new Uint32Array(M),edgeIndices8Bit:new Uint8Array(x),edgeIndices16Bit:new Uint16Array(T),edgeIndices32Bit:new Uint32Array(A),eachTextureSetTextures:new Int32Array(5*l),decodeMatrices:new Float32Array(t),eachBucketPositionsPortion:new Uint32Array(y),eachBucketColorsPortion:new Uint32Array(y),eachBucketUVsPortion:new Uint32Array(y),eachBucketIndicesPortion:new Uint32Array(y),eachBucketEdgeIndicesPortion:new Uint32Array(y),eachBucketIndicesBitness:new Uint8Array(y),eachGeometryPrimitiveType:new Uint8Array(u),eachGeometryBucketPortion:new Uint32Array(u),eachGeometryDecodeMatricesPortion:new Uint32Array(u),matrices:new Float32Array(0),eachMeshGeometriesPortion:new Uint32Array(f),eachMeshMatricesPortion:new Uint32Array(f),eachMeshTextureSet:new Uint32Array(f),eachMeshMaterialAttributes:new Uint8Array(6*f),eachObjectId:[],eachObjectMeshesPortion:new Uint32Array(g)},F=0,E=0,K=0,R=0,V=0,J=0,N=0,L=0,q=0,X=0,_=0,z=0;for(var H in r.geometries){var Q=r.geometries[H],W=Q.geometryBuckets;C.eachGeometryPrimitiveType[z]=Q.primitive,C.eachGeometryBucketPortion[z]=F,C.eachGeometryDecodeMatricesPortion[z]=_,C.decodeMatrices.set(Q.positionsDecompressMatrix,_),_+=16;for(var Y=0,Z=W.length;Y<Z;Y++){var $=W[Y],ee=$.positionsCompressed.length/3,te=ee<=256?0:ee<=65536?1:2;if(C.eachBucketPositionsPortion[F]=E,C.eachBucketColorsPortion[F]=K,C.eachBucketUVsPortion[F]=R,C.eachBucketIndicesBitness[F]=te,C.positions.set($.positionsCompressed,E),E+=$.positionsCompressed.length,$.indices)switch(te){case 0:C.indices8Bit.set($.indices,V),C.eachBucketIndicesPortion[z]=V,V+=$.indices.length;break;case 1:C.indices16Bit.set($.indices,J),C.eachBucketIndicesPortion[z]=J,J+=$.indices.length;break;case 2:C.indices32Bit.set($.indices,N),C.eachBucketIndicesPortion[z]=N,N+=$.indices.length}if($.edgeIndices)switch(te){case 0:C.edgeIndices8Bit.set($.edgeIndices,L),C.eachBucketEdgeIndicesPortion[z]=L,L+=$.edgeIndices.length;break;case 1:C.edgeIndices16Bit.set($.edgeIndices,q),C.eachBucketEdgeIndicesPortion[z]=q,q+=$.edgeIndices.length;break;case 2:C.edgeIndices32Bit.set($.edgeIndices,X),C.eachBucketEdgeIndicesPortion[z]=X,X+=$.edgeIndices.length}$.colorsCompressed&&(C.colors.set($.colorsCompressed,K),K+=$.colorsCompressed.length),$.uvsCompressed&&(C.uvs.set($.uvsCompressed,R),R+=$.uvsCompressed.length),F++}p[Q.id]=z,z++}for(var re=0,ie=o.length,ae=0;re<ie;re++){var oe=o[re],se=oe.imageData;C.textureData.set(se,ae),C.eachTextureDataPortion[re]=ae,ae+=se.byteLength;var ce=9*re;C.eachTextureAttributes[ce++]=oe.compressed?1:0,C.eachTextureAttributes[ce++]=oe.mediaType||0,C.eachTextureAttributes[ce++]=oe.width,C.eachTextureAttributes[ce++]=oe.height,C.eachTextureAttributes[ce++]=oe.minFilter||1008,C.eachTextureAttributes[ce++]=oe.magFilter||1008,C.eachTextureAttributes[ce++]=oe.wrapS||n,C.eachTextureAttributes[ce++]=oe.wrapT||n,C.eachTextureAttributes[ce++]=oe.wrapR||n,k[oe.id]=re}for(var ne=0,de=s.length,ue=0;ne<de;ne++){var he=s[ne];C.eachTextureSetTextures[ue++]=he.colorTexture?k[he.colorTexture.id]:-1,C.eachTextureSetTextures[ue++]=he.metallicRoughnessTexture?k[he.metallicRoughnessTexture.id]:-1,C.eachTextureSetTextures[ue++]=he.emissiveTexture?k[he.emissiveTexture.id]:-1,C.eachTextureSetTextures[ue++]=he.occlusionTexture?k[he.occlusionTexture.id]:-1,I[he.id]=ne}for(var le=0,fe=0,ge=0,ye=0;ye<g;ye++){var Pe=d[ye],Be=Pe.meshes.length;C.eachObjectId[ye]=Pe.id,C.eachObjectMeshesPortion[ye]=ge;for(var me=0;me<Be;me++){var be=Pe.meshes[me];C.eachMeshGeometriesPortion[me]=p[be.geometry.id],C.eachMeshMatricesPortion[me]=fe,C.matrices.set(be.matrix,fe),fe+=16,C.eachMeshTextureSet[me]=be.textureSet?I[be.textureSet.id]:-1,C.eachMeshMaterialAttributes[le++]=255*be.color[0],C.eachMeshMaterialAttributes[le++]=255*be.color[1],C.eachMeshMaterialAttributes[le++]=255*be.color[2],C.eachMeshMaterialAttributes[le++]=255*be.opacity,C.eachMeshMaterialAttributes[le++]=255*be.metallic,C.eachMeshMaterialAttributes[le++]=255*be.roughness}ge+=Be}return C}({sceneModel:e.sceneModel,dataModel:e.dataModel}),o=JSON.stringify(["{}"]).replace(/[\u007F-\uFFFF]/g,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).substr(-4)}),function(e){var t=new Uint32Array(e.length+2);t[0]=11,t[1]=e.length;for(var r=0,i=0,a=e.length;i<a;i++){var o=e[i].length;t[i+2]=o,r+=o}var s=new Uint8Array(t.buffer),c=new Uint8Array(s.length+r);c.set(s);for(var n=s.length,d=0,u=e.length;d<u;d++){var h=e[d];c.set(h,n),n+=h.length}return c.buffer}([(t={metadata:a.deflate(o),textureData:a.deflate(i.textureData.buffer),eachTextureDataPortion:a.deflate(i.eachTextureDataPortion.buffer),eachTextureAttributes:a.deflate(i.eachTextureAttributes.buffer),positions:a.deflate(i.positions.buffer),colors:a.deflate(i.colors.buffer),uvs:a.deflate(i.uvs.buffer),indices8Bit:a.deflate(i.indices8Bit.buffer),indices16Bit:a.deflate(i.indices16Bit.buffer),indices32Bit:a.deflate(i.indices32Bit.buffer),edgeIndices8Bit:a.deflate(i.edgeIndices8Bit.buffer),edgeIndices16Bit:a.deflate(i.edgeIndices16Bit.buffer),edgeIndices32Bit:a.deflate(i.edgeIndices32Bit.buffer),eachTextureSetTextures:a.deflate(i.eachTextureSetTextures.buffer),decodeMatrices:a.deflate(i.decodeMatrices.buffer),eachBucketPositionsPortion:a.deflate(i.eachBucketPositionsPortion.buffer),eachBucketColorsPortion:a.deflate(i.eachBucketColorsPortion.buffer),eachBucketUVsPortion:a.deflate(i.eachBucketUVsPortion.buffer),eachBucketIndicesPortion:a.deflate(i.eachBucketIndicesPortion.buffer),eachBucketEdgeIndicesPortion:a.deflate(i.eachBucketEdgeIndicesPortion.buffer),eachBucketIndicesBitness:a.deflate(i.eachBucketIndicesBitness.buffer),eachGeometryPrimitiveType:a.deflate(i.eachGeometryPrimitiveType.buffer),eachGeometryBucketPortion:a.deflate(i.eachGeometryBucketPortion.buffer),eachGeometryDecodeMatricesPortion:a.deflate(i.eachGeometryDecodeMatricesPortion.buffer),matrices:a.deflate(i.matrices.buffer),eachMeshGeometriesPortion:a.deflate(i.eachMeshGeometriesPortion.buffer),eachMeshMatricesPortion:a.deflate(i.eachMeshMatricesPortion.buffer),eachMeshTextureSet:a.deflate(i.eachMeshTextureSet.buffer),eachMeshMaterialAttributes:a.deflate(i.eachMeshMaterialAttributes.buffer),eachObjectId:a.deflate(JSON.stringify(i.eachObjectId).replace(/[\u007F-\uFFFF]/g,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).substr(-4)})),eachObjectMeshesPortion:a.deflate(i.eachObjectMeshesPortion.buffer)}).metadata,t.textureData,t.eachTextureDataPortion,t.eachTextureAttributes,t.positions,t.colors,t.uvs,t.indices8Bit,t.indices16Bit,t.indices32Bit,t.edgeIndices8Bit,t.edgeIndices16Bit,t.edgeIndices32Bit,t.eachTextureSetTextures,t.decodeMatrices,t.eachBucketPositionsPortion,t.eachBucketColorsPortion,t.eachBucketUVsPortion,t.eachBucketIndicesPortion,t.eachBucketEdgeIndicesPortion,t.eachBucketIndicesBitness,t.eachGeometryPrimitiveType,t.eachGeometryBucketPortion,t.eachGeometryDecodeMatricesPortion,t.matrices,t.eachMeshGeometriesPortion,t.eachMeshMatricesPortion,t.eachMeshTextureSet,t.eachMeshMaterialAttributes,t.eachObjectId,t.eachObjectMeshesPortion]);var t,i,o}});
//# sourceMappingURL=index.umd.js.map
