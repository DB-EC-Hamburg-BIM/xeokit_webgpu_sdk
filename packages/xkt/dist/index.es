import*as e from"pako";import{SDKError as t}from"@xeokit/core";function r(t){function r(t,r){return 0===t.length?[]:e.inflate(t,r).buffer}return{metadata:JSON.parse(e.inflate(t.metadata,{to:"string"})),textureData:new Uint8Array(r(t.textureData)),eachTextureDataPortion:new Uint32Array(r(t.eachTextureDataPortion)),eachTextureAttributes:new Uint16Array(r(t.eachTextureAttributes)),positions:new Uint16Array(r(t.positions)),colors:new Uint8Array(r(t.colors)),uvs:new Float32Array(r(t.uvs)),indices8Bit:new Uint8Array(r(t.indices8Bit)),indices16Bit:new Uint16Array(r(t.indices16Bit)),indices32Bit:new Uint32Array(r(t.indices32Bit)),edgeIndices8Bit:new Uint8Array(r(t.edgeIndices8Bit)),edgeIndices16Bit:new Uint16Array(r(t.edgeIndices16Bit)),edgeIndices32Bit:new Uint32Array(r(t.edgeIndices32Bit)),eachTextureSetTextures:new Int32Array(r(t.eachTextureSetTextures)),decodeMatrices:new Float32Array(r(t.decodeMatrices)),eachBucketPositionsPortion:new Uint32Array(r(t.eachBucketPositionsPortion)),eachBucketColorsPortion:new Uint32Array(r(t.eachBucketColorsPortion)),eachBucketUVsPortion:new Uint32Array(r(t.eachBucketUVsPortion)),eachBucketIndicesPortion:new Uint32Array(r(t.eachBucketIndicesPortion)),eachBucketEdgeIndicesPortion:new Uint32Array(r(t.eachBucketEdgeIndicesPortion)),eachBucketIndicesBitness:new Uint8Array(r(t.eachBucketIndicesBitness)),eachGeometryPrimitiveType:new Uint8Array(r(t.eachGeometryPrimitiveType)),eachGeometryBucketPortion:new Uint32Array(r(t.eachGeometryBucketPortion)),eachGeometryDecodeMatricesPortion:new Uint32Array(r(t.eachGeometryDecodeMatricesPortion)),matrices:new Float32Array(r(t.matrices)),eachMeshGeometriesPortion:new Uint32Array(r(t.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(r(t.eachMeshMatricesPortion)),eachMeshTextureSet:new Uint32Array(r(t.eachMeshTextureSet)),eachMeshMaterialAttributes:new Uint8Array(r(t.eachMeshMaterialAttributes)),eachObjectId:JSON.parse(e.inflate(t.eachObjectId,{to:"string"})),eachObjectMeshesPortion:new Uint32Array(r(t.eachObjectMeshesPortion))}}function i(e){var t=new DataView(e),r=new Uint8Array(e);t.getUint32(0,!0);for(var i=t.getUint32(4,!0),a=[],s=4*(i+2),o=0;o<i;o++){var c=t.getUint32(4*(o+2),!0);a.push(r.subarray(s,s+c)),s+=c}var n=0;return{metadata:a[n++],textureData:a[n++],eachTextureDataPortion:a[n++],eachTextureAttributes:a[n++],positions:a[n++],colors:a[n++],uvs:a[n++],indices8Bit:a[n++],indices16Bit:a[n++],indices32Bit:a[n++],edgeIndices8Bit:a[n++],edgeIndices16Bit:a[n++],edgeIndices32Bit:a[n++],eachTextureSetTextures:a[n++],decodeMatrices:a[n++],eachBucketPositionsPortion:a[n++],eachBucketColorsPortion:a[n++],eachBucketUVsPortion:a[n++],eachBucketIndicesPortion:a[n++],eachBucketEdgeIndicesPortion:a[n++],eachBucketIndicesBitness:a[n++],eachGeometryPrimitiveType:a[n++],eachGeometryBucketPortion:a[n++],eachGeometryDecodeMatricesPortion:a[n++],matrices:a[n++],eachMeshGeometriesPortion:a[n++],eachMeshMatricesPortion:a[n++],eachMeshTextureSet:a[n++],eachMeshMaterialAttributes:a[n++],eachObjectId:a[n++],eachObjectMeshesPortion:a[n++]}}var a,s=1001,o=(a=new Float32Array(3),function(e){return a[0]=e[0]/255,a[1]=e[1]/255,a[2]=e[2]/255,a});function c(e){if(e.sceneModel.destroyed)throw new Error("SceneModel already destroyed");if(e.sceneModel.built)throw new t("SceneModel already built");if(e.dataModel){if(e.dataModel.destroyed)throw new t("DataModel already destroyed");if(e.dataModel.built)throw new t("DataModel already built")}return new Promise(function(t,a){!function(e){var t=e.xktData,r=e.sceneModel,i=e.dataModel;i&&t.metadata&&i.fromJSON(t.metadata);for(var a=t.eachTextureDataPortion.length,s=t.eachTextureSetTextures.length/5,c=t.eachBucketPositionsPortion.length,n=t.eachObjectMeshesPortion.length,d=0,h={},u=0;u<a;u++){var l=t.eachTextureDataPortion[u],f=u===a-1?t.textureData.length:t.eachTextureDataPortion[u+1],g=9*u,m=1===t.eachTextureAttributes[g],y=t.eachTextureAttributes[g+1],B=t.eachTextureAttributes[g+4],P=t.eachTextureAttributes[g+5],M=t.eachTextureAttributes[g+6],b=t.eachTextureAttributes[g+7],x=t.eachTextureAttributes[g+8];if(f-l>0){var T=new Uint8Array(t.textureData.subarray(l,f)).buffer,A="texture-"+u;if(m)r.createTexture({id:A,buffers:[T],minFilter:B,magFilter:P,wrapS:M,wrapT:b,wrapR:x});else{var w=new Blob([T],{type:10001===y?"image/jpeg":10002===y?"image/png":"image/gif"}),p=(window.URL||window.webkitURL).createObjectURL(w),I=document.createElement("img");I.src=p,r.createTexture({id:A,image:I,mediaType:y,minFilter:B,magFilter:P,wrapS:M,wrapT:b,wrapR:x})}}}for(var k=0;k<s;k++){var v=5*k,U=t.eachTextureSetTextures[v],S=t.eachTextureSetTextures[v+1],D=t.eachTextureSetTextures[v+2],G=t.eachTextureSetTextures[v+3],O=t.eachTextureSetTextures[v+4];r.createTextureSet({id:"textureSet-"+k,colorTextureId:U>=0?"texture-"+U:void 0,normalsTextureId:D>=0?"texture-"+D:void 0,metallicRoughnessTextureId:S>=0?"texture-"+S:void 0,emissiveTextureId:G>=0?"texture-"+G:void 0,occlusionTextureId:O>=0?"texture-"+O:void 0})}for(var C=0;C<=n;C++){for(var j=t.eachObjectId[C],F=C===n-1?t.eachMeshGeometriesPortion.length-1:t.eachObjectMeshesPortion[C+1]-1,E=[],R=t.eachObjectMeshesPortion[C];R<=F;R++){var V=t.eachMeshGeometriesPortion[R],J=t.eachMeshTextureSet[R],N=J>=0?"textureSet-"+J:void 0,L=o(t.eachMeshMaterialAttributes.subarray(6*R,6*R+3)),q=t.eachMeshMaterialAttributes[6*R+3]/255,z=t.eachMeshMaterialAttributes[6*R+4]/255,H=t.eachMeshMaterialAttributes[6*R+5]/255,K="mesh-"+d++,Q=t.eachMeshMatricesPortion[R],W=t.matrices.slice(Q,Q+16),X="geometry."+V;if(!h[X]){var Y={geometryBuckets:[]};Y.primitive=t.eachGeometryPrimitiveType[V];var Z=t.eachGeometryDecodeMatricesPortion[V];Y.positionsDecompressMatrix=t.eachGeometryDecodeMatricesPortion.slice(Z,Z+16);for(var $=t.eachGeometryBucketPortion[V],_=$===c-1,ee=_?t.eachMeshGeometriesPortion.length-1:t.eachObjectMeshesPortion[C+1]-1,te=$;te<=ee;te++){var re={positionsCompressed:[],indices:[]},ie=t.eachBucketIndicesBitness[te],ae=8===ie?t.indices8Bit:16===ie?t.indices16Bit:t.indices32Bit,se=8===ie?t.edgeIndices8Bit:16===ie?t.edgeIndices16Bit:t.edgeIndices32Bit,oe=!1;switch(Y.primitive){case 20002:re.positionsCompressed=t.positions.subarray(t.eachBucketPositionsPortion[te],_?t.positions.length:t.eachBucketPositionsPortion[te+1]),re.indices=ae.subarray(t.eachBucketIndicesPortion[te],_?ae.length:t.eachBucketIndicesPortion[te+1]),re.edgeIndices=se.subarray(t.eachBucketEdgeIndicesPortion[te],_?se.length:t.eachBucketEdgeIndicesPortion[te+1]),oe=re.positionsCompressed.length>0&&re.indices.length>0;break;case 2e4:re.positionsCompressed=t.positions.subarray(t.eachBucketPositionsPortion[te],_?t.positions.length:t.eachBucketPositionsPortion[te+1]),oe=re.positionsCompressed.length>0;break;case 20001:re.positionsCompressed=t.positions.subarray(t.eachBucketPositionsPortion[te],_?t.positions.length:t.eachBucketPositionsPortion[te+1]),re.indices=ae.subarray(t.eachBucketIndicesPortion[te],_?ae.length:t.eachBucketIndicesPortion[te+1]),oe=re.positionsCompressed.length>0&&re.indices.length>0;break;default:continue}oe&&Y.geometryBuckets.push(re)}Y.geometryBuckets.length>0&&(r.createGeometryCompressed(Y),h[X]=!0)}r.createMesh({id:K,geometryId:X,textureSetId:N,matrix:W,color:L,metallic:z,roughness:H,opacity:q}),E.push(K)}E.length>0&&r.createObject({id:j,meshIds:E})}}({xktData:r(i(e.data)),sceneModel:e.sceneModel,dataModel:e.dataModel}),t()})}function n(r){if(r.sceneModel.destroyed)throw new t("SceneModel already destroyed");if(!r.sceneModel.built)throw new t("SceneModel not yet built");if(r.dataModel){if(r.dataModel.destroyed)throw new t("DataModel already destroyed");if(!r.dataModel.built)throw new t("DataModel not yet built")}return a=function(e){for(var t,r=e.sceneModel,i=e.dataModel,a=Object.values(r.geometries),o=Object.values(r.textures),c=Object.values(r.textureSets),n=Object.values(r.meshes),d=Object.values(r.objects),h=a.length,u=o.length,l=c.length,f=n.length,g=d.length,m=0,y=0,B=0,P=0,M=0,b=0,x=0,T=0,A=0,w=0,p={},I={},k={},v=0;v<h;v++){var U=a[v].geometryBuckets;m+=U.length;for(var S=0,D=U.length;S<D;S++){var G=U[S];if(G.positionsCompressed){var O=G.positionsCompressed.length/3;y+=G.positionsCompressed.length,G.indices&&(O<=256?P+=G.indices.length:O<=65536?M+=G.indices.length:b+=G.indices.length),G.edgeIndices&&(O<=256?x+=G.edgeIndices.length:O<=65536?T+=G.edgeIndices.length:A+=G.edgeIndices.length),G.uvsCompressed&&(B+=G.uvsCompressed.length)}}}for(var C=0;C<u;C++)w+=o[C].imageData.byteLength;t=16*h;var j={metadata:i?i.getJSON():{},textureData:new Uint8Array(w),eachTextureDataPortion:new Uint32Array(u),eachTextureAttributes:new Uint16Array(9*u),positions:new Uint16Array(y),colors:new Uint8Array(0),uvs:new Float32Array(B),indices8Bit:new Uint8Array(P),indices16Bit:new Uint16Array(M),indices32Bit:new Uint32Array(b),edgeIndices8Bit:new Uint8Array(x),edgeIndices16Bit:new Uint16Array(T),edgeIndices32Bit:new Uint32Array(A),eachTextureSetTextures:new Int32Array(5*l),decodeMatrices:new Float32Array(t),eachBucketPositionsPortion:new Uint32Array(m),eachBucketColorsPortion:new Uint32Array(m),eachBucketUVsPortion:new Uint32Array(m),eachBucketIndicesPortion:new Uint32Array(m),eachBucketEdgeIndicesPortion:new Uint32Array(m),eachBucketIndicesBitness:new Uint8Array(m),eachGeometryPrimitiveType:new Uint8Array(h),eachGeometryBucketPortion:new Uint32Array(h),eachGeometryDecodeMatricesPortion:new Uint32Array(h),matrices:new Float32Array(0),eachMeshGeometriesPortion:new Uint32Array(f),eachMeshMatricesPortion:new Uint32Array(f),eachMeshTextureSet:new Uint32Array(f),eachMeshMaterialAttributes:new Uint8Array(6*f),eachObjectId:[],eachObjectMeshesPortion:new Uint32Array(g)},F=0,E=0,R=0,V=0,J=0,N=0,L=0,q=0,z=0,H=0,K=0,Q=0;for(var W in r.geometries){var X=r.geometries[W],Y=X.geometryBuckets;j.eachGeometryPrimitiveType[Q]=X.primitive,j.eachGeometryBucketPortion[Q]=F,j.eachGeometryDecodeMatricesPortion[Q]=K,j.decodeMatrices.set(X.positionsDecompressMatrix,K),K+=16;for(var Z=0,$=Y.length;Z<$;Z++){var _=Y[Z],ee=_.positionsCompressed.length/3,te=ee<=256?0:ee<=65536?1:2;if(j.eachBucketPositionsPortion[F]=E,j.eachBucketColorsPortion[F]=R,j.eachBucketUVsPortion[F]=V,j.eachBucketIndicesBitness[F]=te,j.positions.set(_.positionsCompressed,E),E+=_.positionsCompressed.length,_.indices)switch(te){case 0:j.indices8Bit.set(_.indices,J),j.eachBucketIndicesPortion[Q]=J,J+=_.indices.length;break;case 1:j.indices16Bit.set(_.indices,N),j.eachBucketIndicesPortion[Q]=N,N+=_.indices.length;break;case 2:j.indices32Bit.set(_.indices,L),j.eachBucketIndicesPortion[Q]=L,L+=_.indices.length}if(_.edgeIndices)switch(te){case 0:j.edgeIndices8Bit.set(_.edgeIndices,q),j.eachBucketEdgeIndicesPortion[Q]=q,q+=_.edgeIndices.length;break;case 1:j.edgeIndices16Bit.set(_.edgeIndices,z),j.eachBucketEdgeIndicesPortion[Q]=z,z+=_.edgeIndices.length;break;case 2:j.edgeIndices32Bit.set(_.edgeIndices,H),j.eachBucketEdgeIndicesPortion[Q]=H,H+=_.edgeIndices.length}_.colorsCompressed&&(j.colors.set(_.colorsCompressed,R),R+=_.colorsCompressed.length),_.uvsCompressed&&(j.uvs.set(_.uvsCompressed,V),V+=_.uvsCompressed.length),F++}p[X.id]=Q,Q++}for(var re=0,ie=o.length,ae=0;re<ie;re++){var se=o[re],oe=se.imageData;j.textureData.set(oe,ae),j.eachTextureDataPortion[re]=ae,ae+=oe.byteLength;var ce=9*re;j.eachTextureAttributes[ce++]=se.compressed?1:0,j.eachTextureAttributes[ce++]=se.mediaType||0,j.eachTextureAttributes[ce++]=se.width,j.eachTextureAttributes[ce++]=se.height,j.eachTextureAttributes[ce++]=se.minFilter||1008,j.eachTextureAttributes[ce++]=se.magFilter||1008,j.eachTextureAttributes[ce++]=se.wrapS||s,j.eachTextureAttributes[ce++]=se.wrapT||s,j.eachTextureAttributes[ce++]=se.wrapR||s,I[se.id]=re}for(var ne=0,de=c.length,he=0;ne<de;ne++){var ue=c[ne];j.eachTextureSetTextures[he++]=ue.colorTexture?I[ue.colorTexture.id]:-1,j.eachTextureSetTextures[he++]=ue.metallicRoughnessTexture?I[ue.metallicRoughnessTexture.id]:-1,j.eachTextureSetTextures[he++]=ue.emissiveTexture?I[ue.emissiveTexture.id]:-1,j.eachTextureSetTextures[he++]=ue.occlusionTexture?I[ue.occlusionTexture.id]:-1,k[ue.id]=ne}for(var le=0,fe=0,ge=0,me=0;me<g;me++){var ye=d[me],Be=ye.meshes.length;j.eachObjectId[me]=ye.id,j.eachObjectMeshesPortion[me]=ge;for(var Pe=0;Pe<Be;Pe++){var Me=ye.meshes[Pe];j.eachMeshGeometriesPortion[Pe]=p[Me.geometry.id],j.eachMeshMatricesPortion[Pe]=fe,j.matrices.set(Me.matrix,fe),fe+=16,j.eachMeshTextureSet[Pe]=Me.textureSet?k[Me.textureSet.id]:-1,j.eachMeshMaterialAttributes[le++]=255*Me.color[0],j.eachMeshMaterialAttributes[le++]=255*Me.color[1],j.eachMeshMaterialAttributes[le++]=255*Me.color[2],j.eachMeshMaterialAttributes[le++]=255*Me.opacity,j.eachMeshMaterialAttributes[le++]=255*Me.metallic,j.eachMeshMaterialAttributes[le++]=255*Me.roughness}ge+=Be}return j}({sceneModel:r.sceneModel,dataModel:r.dataModel}),o=JSON.stringify(["{}"]).replace(/[\u007F-\uFFFF]/g,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).substr(-4)}),function(e){var t=new Uint32Array(e.length+2);t[0]=11,t[1]=e.length;for(var r=0,i=0,a=e.length;i<a;i++){var s=e[i].length;t[i+2]=s,r+=s}var o=new Uint8Array(t.buffer),c=new Uint8Array(o.length+r);c.set(o);for(var n=o.length,d=0,h=e.length;d<h;d++){var u=e[d];c.set(u,n),n+=u.length}return c.buffer}([(i={metadata:e.deflate(o),textureData:e.deflate(a.textureData.buffer),eachTextureDataPortion:e.deflate(a.eachTextureDataPortion.buffer),eachTextureAttributes:e.deflate(a.eachTextureAttributes.buffer),positions:e.deflate(a.positions.buffer),colors:e.deflate(a.colors.buffer),uvs:e.deflate(a.uvs.buffer),indices8Bit:e.deflate(a.indices8Bit.buffer),indices16Bit:e.deflate(a.indices16Bit.buffer),indices32Bit:e.deflate(a.indices32Bit.buffer),edgeIndices8Bit:e.deflate(a.edgeIndices8Bit.buffer),edgeIndices16Bit:e.deflate(a.edgeIndices16Bit.buffer),edgeIndices32Bit:e.deflate(a.edgeIndices32Bit.buffer),eachTextureSetTextures:e.deflate(a.eachTextureSetTextures.buffer),decodeMatrices:e.deflate(a.decodeMatrices.buffer),eachBucketPositionsPortion:e.deflate(a.eachBucketPositionsPortion.buffer),eachBucketColorsPortion:e.deflate(a.eachBucketColorsPortion.buffer),eachBucketUVsPortion:e.deflate(a.eachBucketUVsPortion.buffer),eachBucketIndicesPortion:e.deflate(a.eachBucketIndicesPortion.buffer),eachBucketEdgeIndicesPortion:e.deflate(a.eachBucketEdgeIndicesPortion.buffer),eachBucketIndicesBitness:e.deflate(a.eachBucketIndicesBitness.buffer),eachGeometryPrimitiveType:e.deflate(a.eachGeometryPrimitiveType.buffer),eachGeometryBucketPortion:e.deflate(a.eachGeometryBucketPortion.buffer),eachGeometryDecodeMatricesPortion:e.deflate(a.eachGeometryDecodeMatricesPortion.buffer),matrices:e.deflate(a.matrices.buffer),eachMeshGeometriesPortion:e.deflate(a.eachMeshGeometriesPortion.buffer),eachMeshMatricesPortion:e.deflate(a.eachMeshMatricesPortion.buffer),eachMeshTextureSet:e.deflate(a.eachMeshTextureSet.buffer),eachMeshMaterialAttributes:e.deflate(a.eachMeshMaterialAttributes.buffer),eachObjectId:e.deflate(JSON.stringify(a.eachObjectId).replace(/[\u007F-\uFFFF]/g,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).substr(-4)})),eachObjectMeshesPortion:e.deflate(a.eachObjectMeshesPortion.buffer)}).metadata,i.textureData,i.eachTextureDataPortion,i.eachTextureAttributes,i.positions,i.colors,i.uvs,i.indices8Bit,i.indices16Bit,i.indices32Bit,i.edgeIndices8Bit,i.edgeIndices16Bit,i.edgeIndices32Bit,i.eachTextureSetTextures,i.decodeMatrices,i.eachBucketPositionsPortion,i.eachBucketColorsPortion,i.eachBucketUVsPortion,i.eachBucketIndicesPortion,i.eachBucketEdgeIndicesPortion,i.eachBucketIndicesBitness,i.eachGeometryPrimitiveType,i.eachGeometryBucketPortion,i.eachGeometryDecodeMatricesPortion,i.matrices,i.eachMeshGeometriesPortion,i.eachMeshMatricesPortion,i.eachMeshTextureSet,i.eachMeshMaterialAttributes,i.eachObjectId,i.eachObjectMeshesPortion]);var i,a,o}export{c as loadXKT,n as saveXKT};
//# sourceMappingURL=index.es.map
