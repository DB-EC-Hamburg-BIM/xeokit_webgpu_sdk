import{createMat4 as e,createVec3 as t,transformPositions3 as r}from"@xeokit/matrix";import*as a from"web-ifc/web-ifc-api-node";import{IfcRelAggregates as o}from"@xeokit/ifctypes";import{worldToRTCPositions as i}from"@xeokit/rtc";import{TrianglesPrimitive as d}from"@xeokit/constants";function l(o){if(!o.ifcAPI)throw new Error("Argument missing: ifcAPI");if(o.sceneModel.destroyed)throw new Error("SceneModel already destroyed");if(o.sceneModel.built)throw new Error("SceneModel already built");if(o.dataModel){if(o.dataModel.destroyed)throw new Error("DataModel already destroyed");if(o.dataModel.built)throw new Error("DataModel already built")}return new Promise(function(l,c){var s,I=new Uint8Array(o.data),f=o.ifcAPI.OpenModel(I),p=o.ifcAPI.GetLineIDsWithType(f,a.IFCPROJECT),m=p.get(0);(s={data:o.data,modelId:f,lines:p,ifcProjectId:m,ifcAPI:o.ifcAPI,sceneModel:o.sceneModel,dataModel:o.dataModel,nextId:0}).dataModel&&function(e){var t=e.ifcAPI.GetLineIDsWithType(e.modelId,a.IFCPROJECT).get(0),r=e.ifcAPI.GetLine(e.modelId,t);(function(e){for(var t=e.ifcAPI.GetLineIDsWithType(e.modelId,a.IFCRELDEFINESBYPROPERTIES),r=0;r<t.size();r++){var o=t.get(r),i=e.ifcAPI.GetLine(e.modelId,o,!0);if(i){var d=i.RelatingPropertyDefinition;if(!d)continue;var l=d.GlobalId.value,n=d.HasProperties;if(n&&n.length>0){for(var c=d.Name.value,s=[],I=0,f=n.length;I<f;I++){var p=n[I],m=p.Name,u=p.NominalValue;m&&u&&s.push({name:m.value,type:u.type,value:u.value,valueType:u.valueType,description:p.Description?p.Description.value:u.description?u.description:""})}e.dataModel.createPropertySet({id:l,type:"Default",name:c,properties:s});var v=i.RelatedObjects;if(!v||0===v.length)return;for(var y=0,A=v.length;y<A;y++){var P=e.dataObjects[v[y].GlobalId.value];P&&(P.propertySetIds||(P.propertySetIds=[]),P.propertySetIds.push(l))}}}}})(e),n(e,r)}(s),s.sceneModel&&function(a){a.ifcAPI.StreamAllMeshes(a.modelId,function(o){for(var l=o.geometries,n=[],c=a.ifcAPI.GetLine(a.modelId,o.expressID).GlobalId.value,s=e(),I=t(),f=0,p=l.size();f<p;f++){for(var m=l.get(f),u=a.ifcAPI.GetGeometry(a.modelId,m.geometryExpressID),v=a.ifcAPI.GetVertexArray(u.GetVertexData(),u.GetVertexDataSize()),y=a.ifcAPI.GetIndexArray(u.GetIndexData(),u.GetIndexDataSize()),A=new Float64Array(v.length/2),P=0,G=0,M=v.length/6;P<M;P++,G+=3)A[G+0]=v[6*P+0],A[G+1]=v[6*P+1],A[G+2]=v[6*P+2];s.set(m.flatTransformation),r(s,A),i(A,A,I);var h=""+a.nextId++;a.sceneModel.createGeometry({id:h,primitive:d,positions:A,indices:y});var E=""+a.nextId++;a.sceneModel.createMesh({id:E,geometryId:h,color:[m.color.x,m.color.y,m.color.z],opacity:m.color.w}),n.push(E)}a.sceneModel.createObject({id:c,meshIds:n})})}(s),l()})}function n(e,t,r){!function(e,t,r){var a=t.GlobalId.value,i=t.__proto__.constructor.name;e.dataModel.createObject({id:a,name:t.Name&&""!==t.Name.value?t.Name.value:i,type:i}),r&&e.dataModel.createRelationship({type:o,relatingObjectId:r,relatedObjectId:a})}(e,t,r);var i=t.GlobalId.value;c(e,t.expressID,"RelatingObject","RelatedObjects",a.IFCRELAGGREGATES,i),c(e,t.expressID,"RelatingStructure","RelatedElements",a.IFCRELCONTAINEDINSPATIALSTRUCTURE,i)}function c(e,t,r,a,o,i){for(var d=e.ifcAPI.GetLineIDsWithType(e.modelId,o),l=0;l<d.size();l++){var c=d.get(l),s=e.ifcAPI.GetLine(e.modelId,c),I=s[r];if(Array.isArray(I)?I.map(function(e){return e.value}).includes(t):I.value===t){var f=s[a];if(Array.isArray(f))f.forEach(function(t){var r=e.ifcAPI.GetLine(e.modelId,t.value);n(e,r,i)});else{var p=e.ifcAPI.GetLine(e.modelId,f.value);n(e,p,i)}}}}export{l as loadWebIFC};
//# sourceMappingURL=index.es.map
