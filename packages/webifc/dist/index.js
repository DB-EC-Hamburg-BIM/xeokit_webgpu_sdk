var e=require("@xeokit/matrix"),t=require("web-ifc/web-ifc-api-node"),r=require("@xeokit/ifctypes"),a=require("@xeokit/rtc"),i=require("@xeokit/constants");function o(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var a=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,a.get?a:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,t}var n=/*#__PURE__*/o(t);function d(e,t,a){!function(e,t,a){var i=t.GlobalId.value,o=t.__proto__.constructor.name;e.dataModel.createObject({id:i,name:t.Name&&""!==t.Name.value?t.Name.value:o,type:o}),a&&e.dataModel.createRelationship({type:r.IfcRelAggregates,relatingObjectId:a,relatedObjectId:i})}(e,t,a);var i=t.GlobalId.value;l(e,t.expressID,"RelatingObject","RelatedObjects",n.IFCRELAGGREGATES,i),l(e,t.expressID,"RelatingStructure","RelatedElements",n.IFCRELCONTAINEDINSPATIALSTRUCTURE,i)}function l(e,t,r,a,i,o){for(var n=e.ifcAPI.GetLineIDsWithType(e.modelId,i),l=0;l<n.size();l++){var c=n.get(l),s=e.ifcAPI.GetLine(e.modelId,c),I=s[r];if(Array.isArray(I)?I.map(function(e){return e.value}).includes(t):I.value===t){var f=s[a];if(Array.isArray(f))f.forEach(function(t){var r=e.ifcAPI.GetLine(e.modelId,t.value);d(e,r,o)});else{var u=e.ifcAPI.GetLine(e.modelId,f.value);d(e,u,o)}}}}exports.loadWebIFC=function(t){if(!t.ifcAPI)throw new Error("Argument missing: ifcAPI");if(t.sceneModel.destroyed)throw new Error("SceneModel already destroyed");if(t.sceneModel.built)throw new Error("SceneModel already built");if(t.dataModel){if(t.dataModel.destroyed)throw new Error("DataModel already destroyed");if(t.dataModel.built)throw new Error("DataModel already built")}return new Promise(function(r,o){var l,c=new Uint8Array(t.data),s=t.ifcAPI.OpenModel(c),I=t.ifcAPI.GetLineIDsWithType(s,n.IFCPROJECT),f=I.get(0);(l={data:t.data,modelId:s,lines:I,ifcProjectId:f,ifcAPI:t.ifcAPI,sceneModel:t.sceneModel,dataModel:t.dataModel,nextId:0}).dataModel&&function(e){var t=e.ifcAPI.GetLineIDsWithType(e.modelId,n.IFCPROJECT).get(0),r=e.ifcAPI.GetLine(e.modelId,t);(function(e){for(var t=e.ifcAPI.GetLineIDsWithType(e.modelId,n.IFCRELDEFINESBYPROPERTIES),r=0;r<t.size();r++){var a=t.get(r),i=e.ifcAPI.GetLine(e.modelId,a,!0);if(i){var o=i.RelatingPropertyDefinition;if(!o)continue;var d=o.GlobalId.value,l=o.HasProperties;if(l&&l.length>0){for(var c=o.Name.value,s=[],I=0,f=l.length;I<f;I++){var u=l[I],p=u.Name,v=u.NominalValue;p&&v&&s.push({name:p.value,type:v.type,value:v.value,valueType:v.valueType,description:u.Description?u.Description.value:v.description?v.description:""})}e.dataModel.createPropertySet({id:d,type:"Default",name:c,properties:s});var y=i.RelatedObjects;if(!y||0===y.length)return;for(var m=0,A=y.length;m<A;m++){var P=e.dataObjects[y[m].GlobalId.value];P&&(P.propertySetIds||(P.propertySetIds=[]),P.propertySetIds.push(d))}}}}})(e),d(e,r)}(l),l.sceneModel&&function(t){t.ifcAPI.StreamAllMeshes(t.modelId,function(r){for(var o=r.geometries,n=[],d=t.ifcAPI.GetLine(t.modelId,r.expressID).GlobalId.value,l=e.createMat4(),c=e.createVec3(),s=0,I=o.size();s<I;s++){for(var f=o.get(s),u=t.ifcAPI.GetGeometry(t.modelId,f.geometryExpressID),p=t.ifcAPI.GetVertexArray(u.GetVertexData(),u.GetVertexDataSize()),v=t.ifcAPI.GetIndexArray(u.GetIndexData(),u.GetIndexDataSize()),y=new Float64Array(p.length/2),m=0,A=0,P=p.length/6;m<P;m++,A+=3)y[A+0]=p[6*m+0],y[A+1]=p[6*m+1],y[A+2]=p[6*m+2];l.set(f.flatTransformation),e.transformPositions3(l,y),a.worldToRTCPositions(y,y,c);var g=""+t.nextId++;t.sceneModel.createGeometry({id:g,primitive:i.TrianglesPrimitive,positions:y,indices:v});var G=""+t.nextId++;t.sceneModel.createMesh({id:G,geometryId:g,color:[f.color.x,f.color.y,f.color.z],opacity:f.color.w}),n.push(G)}t.sceneModel.createObject({id:d,meshIds:n})})}(l),r()})};
//# sourceMappingURL=index.js.map
