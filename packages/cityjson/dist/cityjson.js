var e=require("@xeokit/math"),n=require("@xeokit/core");function t(e,n){return e[0]*n[0]+e[1]*n[1]+e[2]*n[2]}function r(e){return new FloatArrayClass(e||2)}function i(e){return new Float64Array(e||3)}function o(e){return new FloatArrayClass(e||4)}function a(e,n,t){return t||(t=e),t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function u(e){return Math.sqrt(function(e){return t(e,e)}(e))}function l(e,n){return a(e,1/u(e),n)}function s(n){return e.newFloatArray(n||16)}function x(e,n,t){t=t||2;var r,i,o,a,u,l,s,x=n&&n.length,d=x?n[0]*t:e.length,y=f(e,0,d,t,!0),h=[];if(!y||y.next===y.prev)return h;if(x&&(y=function(e,n,t,r){var i,o,a,u=[];for(i=0,o=n.length;i<o;i++)(a=f(e,n[i]*r,i<o-1?n[i+1]*r:e.length,r,!1))===a.next&&(a.steiner=!0),u.push(b(a));for(u.sort(g),i=0;i<u.length;i++)M(u[i],t),t=v(t,t.next);return t}(e,n,y,t)),e.length>80*t){r=o=e[0],i=a=e[1];for(var p=t;p<d;p+=t)(u=e[p])<r&&(r=u),(l=e[p+1])<i&&(i=l),u>o&&(o=u),l>a&&(a=l);s=0!==(s=Math.max(o-r,a-i))?1/s:0}return c(y,h,t,r,i,s),h}function f(e,n,t,r,i){var o,a;if(i===j(e,n,t,r)>0)for(o=n;o<t;o+=r)a=k(o,e[o],e[o+1],a);else for(o=t-r;o>=n;o-=r)a=k(o,e[o],e[o+1],a);return a&&C(a,a.next)&&(P(a),a=a.next),a}function v(e,n){if(!e)return e;n||(n=e);var t,r=e;do{if(t=!1,r.steiner||!C(r,r.next)&&0!==Z(r.prev,r,r.next))r=r.next;else{if(P(r),(r=n=r.prev)===r.next)break;t=!0}}while(t||r!==n);return n}function c(e,n,t,r,i,o,a){if(e){!a&&o&&function(e,n,t,r){var i=e;do{null===i.z&&(i.z=w(i.x,i.y,n,t,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==e);i.prevZ.nextZ=null,i.prevZ=null,function(e){var n,t,r,i,o,a,u,l,s=1;do{for(t=e,e=null,o=null,a=0;t;){for(a++,r=t,u=0,n=0;n<s&&(u++,r=r.nextZ);n++);for(l=s;u>0||l>0&&r;)0!==u&&(0===l||!r||t.z<=r.z)?(i=t,t=t.nextZ,u--):(i=r,r=r.nextZ,l--),o?o.nextZ=i:e=i,i.prevZ=o,o=i;t=r}o.nextZ=null,s*=2}while(a>1)}(i)}(e,r,i,o);for(var u,l,s=e;e.prev!==e.next;)if(u=e.prev,l=e.next,o?y(e,r,i,o):d(e))n.push(u.i/t),n.push(e.i/t),n.push(l.i/t),P(e),e=l.next,s=l.next;else if((e=l)===s){a?1===a?c(e=h(v(e),n,t),n,t,r,i,o,2):2===a&&p(e,n,t,r,i,o):c(v(e),n,t,r,i,o,1);break}}}function d(e){var n=e.prev,t=e,r=e.next;if(Z(n,t,r)>=0)return!1;for(var i=e.next.next;i!==e.prev;){if(B(n.x,n.y,t.x,t.y,r.x,r.y,i.x,i.y)&&Z(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function y(e,n,t,r){var i=e.prev,o=e,a=e.next;if(Z(i,o,a)>=0)return!1;for(var u=i.x>o.x?i.x>a.x?i.x:a.x:o.x>a.x?o.x:a.x,l=i.y>o.y?i.y>a.y?i.y:a.y:o.y>a.y?o.y:a.y,s=w(i.x<o.x?i.x<a.x?i.x:a.x:o.x<a.x?o.x:a.x,i.y<o.y?i.y<a.y?i.y:a.y:o.y<a.y?o.y:a.y,n,t,r),x=w(u,l,n,t,r),f=e.prevZ,v=e.nextZ;f&&f.z>=s&&v&&v.z<=x;){if(f!==e.prev&&f!==e.next&&B(i.x,i.y,o.x,o.y,a.x,a.y,f.x,f.y)&&Z(f.prev,f,f.next)>=0)return!1;if(f=f.prevZ,v!==e.prev&&v!==e.next&&B(i.x,i.y,o.x,o.y,a.x,a.y,v.x,v.y)&&Z(v.prev,v,v.next)>=0)return!1;v=v.nextZ}for(;f&&f.z>=s;){if(f!==e.prev&&f!==e.next&&B(i.x,i.y,o.x,o.y,a.x,a.y,f.x,f.y)&&Z(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;v&&v.z<=x;){if(v!==e.prev&&v!==e.next&&B(i.x,i.y,o.x,o.y,a.x,a.y,v.x,v.y)&&Z(v.prev,v,v.next)>=0)return!1;v=v.nextZ}return!0}function h(e,n,t){var r=e;do{var i=r.prev,o=r.next.next;!C(i,o)&&I(i,r,r.next,o)&&F(i,o)&&F(o,i)&&(n.push(i.i/t),n.push(r.i/t),n.push(o.i/t),P(r),P(r.next),r=e=o),r=r.next}while(r!==e);return v(r)}function p(e,n,t,r,i,o){var a=e;do{for(var u=a.next.next;u!==a.prev;){if(a.i!==u.i&&S(a,u)){var l=O(a,u);return a=v(a,a.next),l=v(l,l.next),c(a,n,t,r,i,o),void c(l,n,t,r,i,o)}u=u.next}a=a.next}while(a!==e)}function g(e,n){return e.x-n.x}function M(e,n){if(n=function(e,n){var t,r=n,i=e.x,o=e.y,a=-Infinity;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var u=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(u<=i&&u>a){if(a=u,u===i){if(o===r.y)return r;if(o===r.next.y)return r.next}t=r.x<r.next.x?r:r.next}}r=r.next}while(r!==n);if(!t)return null;if(i===a)return t;var l,s=t,x=t.x,f=t.y,v=Infinity;r=t;do{i>=r.x&&r.x>=x&&i!==r.x&&B(o<f?i:a,o,x,f,o<f?a:i,o,r.x,r.y)&&(l=Math.abs(o-r.y)/(i-r.x),F(r,e)&&(l<v||l===v&&(r.x>t.x||r.x===t.x&&m(t,r)))&&(t=r,v=l)),r=r.next}while(r!==s);return t}(e,n),n){var t=O(n,e);v(n,n.next),v(t,t.next)}}function m(e,n){return Z(e.prev,e,n.prev)<0&&Z(n.next,e,e.next)<0}function w(e,n,t,r,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-t)*i)|e<<8))|e<<4))|e<<2))|e<<1))|(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=32767*(n-r)*i)|n<<8))|n<<4))|n<<2))|n<<1))<<1}function b(e){var n=e,t=e;do{(n.x<t.x||n.x===t.x&&n.y<t.y)&&(t=n),n=n.next}while(n!==e);return t}function B(e,n,t,r,i,o,a,u){return(i-a)*(n-u)-(e-a)*(o-u)>=0&&(e-a)*(r-u)-(t-a)*(n-u)>=0&&(t-a)*(o-u)-(i-a)*(r-u)>=0}function S(e,n){return e.next.i!==n.i&&e.prev.i!==n.i&&!function(e,n){var t=e;do{if(t.i!==e.i&&t.next.i!==e.i&&t.i!==n.i&&t.next.i!==n.i&&I(t,t.next,e,n))return!0;t=t.next}while(t!==e);return!1}(e,n)&&(F(e,n)&&F(n,e)&&function(e,n){var t=e,r=!1,i=(e.x+n.x)/2,o=(e.y+n.y)/2;do{t.y>o!=t.next.y>o&&t.next.y!==t.y&&i<(t.next.x-t.x)*(o-t.y)/(t.next.y-t.y)+t.x&&(r=!r),t=t.next}while(t!==e);return r}(e,n)&&(Z(e.prev,e,n.prev)||Z(e,n.prev,n))||C(e,n)&&Z(e.prev,e,e.next)>0&&Z(n.prev,n,n.next)>0)}function Z(e,n,t){return(n.y-e.y)*(t.x-n.x)-(n.x-e.x)*(t.y-n.y)}function C(e,n){return e.x===n.x&&e.y===n.y}function I(e,n,t,r){var i=T(Z(e,n,t)),o=T(Z(e,n,r)),a=T(Z(t,r,e)),u=T(Z(t,r,n));return i!==o&&a!==u||!(0!==i||!z(e,t,n))||!(0!==o||!z(e,r,n))||!(0!==a||!z(t,e,r))||!(0!==u||!z(t,n,r))}function z(e,n,t){return n.x<=Math.max(e.x,t.x)&&n.x>=Math.min(e.x,t.x)&&n.y<=Math.max(e.y,t.y)&&n.y>=Math.min(e.y,t.y)}function T(e){return e>0?1:e<0?-1:0}function F(e,n){return Z(e.prev,e,e.next)<0?Z(e,n,e.next)>=0&&Z(e,e.prev,n)>=0:Z(e,n,e.prev)<0||Z(e,e.next,n)<0}function O(e,n){var t=new R(e.i,e.x,e.y),r=new R(n.i,n.x,n.y),i=e.next,o=n.prev;return e.next=n,n.prev=e,t.next=i,i.prev=t,r.next=t,t.prev=r,o.next=r,r.prev=o,r}function k(e,n,t,r){var i=new R(e,n,t);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function P(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function R(e,n,t){this.i=e,this.x=n,this.y=t,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function j(e,n,t,r){for(var i=0,o=n,a=t-r;o<t;o+=r)i+=(e[a]-e[o])*(e[o+1]+e[a+1]),a=o;return i}o(),o(),r(),s(),s(),e.newFloatArray(3),i(),s(),e.newFloatArray(3),x.deviation=function(e,n,t,r){var i=n&&n.length,o=Math.abs(j(e,0,i?n[0]*t:e.length,t));if(i)for(var a=0,u=n.length;a<u;a++)o-=Math.abs(j(e,n[a]*t,a<u-1?n[a+1]*t:e.length,t));var l=0;for(a=0;a<r.length;a+=3){var s=r[a]*t,x=r[a+1]*t,f=r[a+2]*t;l+=Math.abs((e[s]-e[f])*(e[x+1]-e[s+1])-(e[s]-e[x])*(e[f+1]-e[s+1]))}return 0===o&&0===l?0:Math.abs((l-o)/o)},x.flatten=function(e){for(var n=e[0][0].length,t={vertices:[],holes:[],dimensions:n},r=0,i=0;i<e.length;i++){for(var o=0;o<e[i].length;o++)for(var a=0;a<n;a++)t.vertices.push(e[i][o][a]);i>0&&t.holes.push(r+=e[i-1].length)}return t};var D,E,A=20002;(D={})[1e3]="BasicEntity",D[1001]="BasicAggregation",(E={})[2e3]="Bridge",E[2001]="BridgePart",E[2002]="BridgeInstallation",E[2003]="BridgeConstructiveElement",E[2004]="BridgeRoom",E[2005]="BridgeFurniture",E[2006]="Building",E[2007]="BuildingPart",E[2008]="BuildingInstallation",E[2009]="BuildingConstructiveElement",E[2010]="BuildingFurniture",E[2011]="BuildingStorey",E[2012]="BuildingRoom",E[2013]="BuildingUnit",E[2014]="CityFurniture",E[2015]="CityObjectGroup",E[2016]="LandUse",E[2017]="OtherConstruction",E[2018]="PlantCover",E[2019]="SolitaryVegetationObject",E[2020]="TINRelief",E[2021]="TransportationSquare",E[2022]="Railway",E[2023]="Road",E[2024]="Tunnel",E[2025]="TunnelPart",E[2026]="TunnelInstallation",E[2027]="TunnelInstallation",E[2028]="TunnelHollowSpace",E[2029]="TunnelFurniture",E[2030]="WaterBody",E[2031]="Waterway";var q={Bridge:2e3,BridgePart:2001,BridgeInstallation:2002,BridgeConstructiveElement:2003,BridgeRoom:2004,BridgeFurniture:2005,Building:2006,BuildingPart:2007,BuildingInstallation:2008,BuildingConstructiveElement:2009,BuildingFurniture:2010,BuildingStorey:2011,BuildingRoom:2012,BuildingUnit:2013,CityFurniture:2014,CityObjectGroup:2015,LandUse:2016,OtherConstruction:2017,PlantCover:2018,SolitaryVegetationObject:2019,TINRelief:2020,TransportationSquare:2021,Railway:2022,Road:2023,Tunnel:2024,TunnelPart:2025,TunnelInstallation:2026,TunnelConstructiveElement:2026,TunnelHollowSpace:2028,TunnelFurniture:2029,WaterBody:2030,Waterway:2031},G=r(),K=i(),L=i(),U=i();function W(e,n,t){for(var r=[],o=n.scale||i([1,1,1]),a=n.translate||i([0,0,0]),u=0,l=0;u<e.length;u++,l+=3){var s=e[u][0]*o[0]+a[0],x=e[u][1]*o[1]+a[1],f=e[u][2]*o[2]+a[2];r.push(t?[s,f,x]:[s,x,f])}return r}function N(e,n,t){if(e.dataModel&&e.dataModel.createObject({id:t,name:n.type+" : "+t,type:0|q[n.type],parent:n.parents?n.parents[0]:null}),e.sceneModel){if(!(n.geometry&&n.geometry.length>0))return;for(var r=[],i=0,o=n.geometry.length;i<o;i++){var a=n.geometry[i],u=void 0,l=void 0,s=e.fileData.appearance;if(s){var x=s.materials;if(x){var f=a.material;if(f){var v=Object.keys(f);if(v.length>0){var c=f[v[0]];if(void 0!==c.value)u=x[c.value];else{var d=c.values;if(d){l=[];for(var y=0,h=d.length;y<h;y++)l.push(x[d[i]])}}}}}}l?V(e,a,l,r):J(e,a,u,r)}r.length>0&&e.sceneModel.createObject({id:t,meshIds:r})}}function H(e,n,t){n.parents&&e.dataModel.createRelationship({relatingObjectId:n.parents[0],relatedObjectId:t,type:1001})}function V(e,n,t,r){switch(n.type){case"MultiPoint":case"MultiLineString":break;case"MultiSurface":case"CompositeSurface":X(e,t,n.boundaries,r);break;case"Solid":for(var i=n.boundaries,o=0;o<i.length;o++)X(e,t,i[o],r);break;case"MultiSolid":case"CompositeSolid":for(var a=n.boundaries,u=0;u<a.length;u++)for(var l=0;l<a[u].length;l++)X(e,t,a[u][l],r)}}function X(e,n,t,r){for(var o=e.vertices,a=e.sceneModel,u=0;u<t.length;u++){for(var l=t[u],s=n[u]||{diffuseColor:[.8,.8,.8],transparency:1},f=[],v=[],c=[],d={positions:[],indices:[]},y=0;y<l.length;y++){f.length>0&&v.push(f.length);var h=Y(e,l[y],c,d);f.push.apply(f,h)}if(3===f.length)d.indices.push(f[0]),d.indices.push(f[1]),d.indices.push(f[2]);else if(f.length>3){for(var p=[],g=0;g<f.length;g++)p.push({x:o[c[f[g]]][0],y:o[c[f[g]]][1],z:o[c[f[g]]][2]});for(var M=$(p,i()),m=[],w=0;w<p.length;w++)_(p[w],M,G),m.unshift(G[0]),m.unshift(G[1]);for(var b=x(m,v,2),B=0;B<b.length;B+=3)d.indices.unshift(f[b[B]]),d.indices.unshift(f[b[B+1]]),d.indices.unshift(f[b[B+2]])}var S=""+e.nextId++;a.createGeometry({id:S,primitive:A,positions:d.positions,indices:d.indices});var Z=""+e.nextId++;a.createMesh({id:Z,geometryId:S,color:s&&s.diffuseColor?s.diffuseColor:[.8,.8,.8],opacity:s&&void 0!==s.transparency?1-s.transparency:1}),r.push(Z)}}function J(e,n,t,r){var i=e.sceneModel,o=[],a={positions:[],indices:[]};switch(n.type){case"MultiPoint":case"MultiLineString":break;case"MultiSurface":case"CompositeSurface":Q(e,n.boundaries,o,a);break;case"Solid":for(var u=n.boundaries,l=0;l<u.length;l++)Q(e,u[l],o,a);break;case"MultiSolid":case"CompositeSolid":for(var s=n.boundaries,x=0;x<s.length;x++)for(var f=0;f<s[x].length;f++)Q(e,s[x][f],o,a)}if(a.positions.length>0&&a.indices.length>0){var v=""+e.nextId++;i.createGeometry({id:v,primitive:A,positions:a.positions,indices:a.indices});var c=""+e.nextId++;i.createMesh({id:c,geometryId:v,color:t&&t.diffuseColor?t.diffuseColor:[.8,.8,.8],opacity:1}),r.push(c)}}function Q(e,n,t,r){for(var o=e.vertices,a=0;a<n.length;a++){for(var u=[],l=[],s=0;s<n[a].length;s++){u.length>0&&l.push(u.length);var f=Y(e,n[a][s],t,r);u.push.apply(u,f)}if(3===u.length)r.indices.push(u[0]),r.indices.push(u[1]),r.indices.push(u[2]);else if(u.length>3){for(var v=[],c=0;c<u.length;c++)v.push({x:o[t[u[c]]][0],y:o[t[u[c]]][1],z:o[t[u[c]]][2]});for(var d=$(v,i()),y=[],h=0;h<v.length;h++)_(v[h],d,G),y.unshift(G[0]),y.unshift(G[1]);for(var p=x(y,l,2),g=0;g<p.length;g+=3)r.indices.unshift(u[p[g]]),r.indices.unshift(u[p[g+1]]),r.indices.unshift(u[p[g+2]])}}}function Y(e,n,t,r){for(var i=e.vertices,o=[],a=0,u=n.length;a<u;a++){var l=n[a];if(t.includes(l)){var s=t.indexOf(l);o.push(s)}else r.positions.push(i[l][0]),r.positions.push(i[l][1]),r.positions.push(i[l][2]),o.push(t.length),t.push(l)}return o}function $(e,n){for(var t=0;t<e.length;t++){var r=t+1;r===e.length&&(r=0),n[0]+=(e[t].y-e[r].y)*(e[t].z+e[r].z),n[1]+=(e[t].z-e[r].z)*(e[t].x+e[r].x),n[2]+=(e[t].x-e[r].x)*(e[t].y+e[r].y)}return l(n)}function _(e,n,r){var o=K,s=L,x=U;o[0]=e.x,o[1]=e.y,o[2]=e.z,s[0]=n.x,s[1]=n.y,s[2]=n.z,x[0]=1.1,x[1]=1.1,x[2]=1.1;var f=u(function(e,n,t){return t||(t=e),t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}(x,s));f<.01&&(x[0]+=1,x[1]+=2,x[2]+=3);var v=a(s,t(x,s),i());x[0]-=v[0],x[1]-=v[1],x[2]-=v[2],l(x);var c=function(e,n,t){t||(t=e);var r=e[0],i=e[1],o=e[2],a=n[0],u=n[1],l=n[2];return t[0]=i*l-o*u,t[1]=o*a-r*l,t[2]=r*u-i*a,t}(s,x,i()),d=t(o,x),y=t(o,c);r[0]=d,r[1]=y}exports.loadCityJSON=function(e,t){if(void 0===t&&(t={rotateX:!1}),e.sceneModel){if(e.sceneModel.destroyed)throw new n.SDKError("SceneModel already destroyed");if(e.sceneModel.built)throw new n.SDKError("SceneModel already built")}if(e.dataModel){if(e.dataModel.destroyed)throw new n.SDKError("DataModel already destroyed");if(e.dataModel.built)throw new n.SDKError("DataModel already built")}return new Promise(function(n,r){var i=e.fileData;!function(e){var n=e.fileData.CityObjects;for(var t in n)N(e,n[t],t);if(e.dataModel)for(var r in n)H(e,n[r],r)}({fileData:i,vertices:i.transform&&e.sceneModel?W(i.vertices,i.transform,t.rotateX):i.vertices,sceneModel:e.sceneModel,dataModel:e.dataModel,nextId:0}),n()})};
//# sourceMappingURL=cityjson.js.map
