import{newFloatArray as e}from"@xeokit/math";import{SDKError as t}from"@xeokit/core";function n(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function r(e){return new FloatArrayClass(e||2)}function i(e){return new Float64Array(e||3)}function o(e){return new FloatArrayClass(e||4)}function u(e,t,n){return n||(n=e),n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n}function l(e){return Math.sqrt(function(e){return n(e,e)}(e))}function s(e,t){return u(e,1/l(e),t)}function a(t){return e(t||16)}function x(e,t,n){n=n||2;var r,i,o,u,l,s,a,x=t&&t.length,h=x?t[0]*n:e.length,y=c(e,0,h,n,!0),p=[];if(!y||y.next===y.prev)return p;if(x&&(y=function(e,t,n,r){var i,o,u,l=[];for(i=0,o=t.length;i<o;i++)(u=c(e,t[i]*r,i<o-1?t[i+1]*r:e.length,r,!1))===u.next&&(u.steiner=!0),l.push(w(u));for(l.sort(g),i=0;i<l.length;i++)M(l[i],n),n=f(n,n.next);return n}(e,t,y,n)),e.length>80*n){r=o=e[0],i=u=e[1];for(var v=n;v<h;v+=n)(l=e[v])<r&&(r=l),(s=e[v+1])<i&&(i=s),l>o&&(o=l),s>u&&(u=s);a=0!==(a=Math.max(o-r,u-i))?1/a:0}return d(y,p,n,r,i,a),p}function c(e,t,n,r,i){var o,u;if(i===j(e,t,n,r)>0)for(o=t;o<n;o+=r)u=F(o,e[o],e[o+1],u);else for(o=n-r;o>=t;o-=r)u=F(o,e[o],e[o+1],u);return u&&S(u,u.next)&&(P(u),u=u.next),u}function f(e,t){if(!e)return e;t||(t=e);var n,r=e;do{if(n=!1,r.steiner||!S(r,r.next)&&0!==C(r.prev,r,r.next))r=r.next;else{if(P(r),(r=t=r.prev)===r.next)break;n=!0}}while(n||r!==t);return t}function d(e,t,n,r,i,o,u){if(e){!u&&o&&function(e,t,n,r){var i=e;do{null===i.z&&(i.z=b(i.x,i.y,t,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==e);i.prevZ.nextZ=null,i.prevZ=null,function(e){var t,n,r,i,o,u,l,s,a=1;do{for(n=e,e=null,o=null,u=0;n;){for(u++,r=n,l=0,t=0;t<a&&(l++,r=r.nextZ);t++);for(s=a;l>0||s>0&&r;)0!==l&&(0===s||!r||n.z<=r.z)?(i=n,n=n.nextZ,l--):(i=r,r=r.nextZ,s--),o?o.nextZ=i:e=i,i.prevZ=o,o=i;n=r}o.nextZ=null,a*=2}while(u>1)}(i)}(e,r,i,o);for(var l,s,a=e;e.prev!==e.next;)if(l=e.prev,s=e.next,o?y(e,r,i,o):h(e))t.push(l.i/n),t.push(e.i/n),t.push(s.i/n),P(e),e=s.next,a=s.next;else if((e=s)===a){u?1===u?d(e=p(f(e),t,n),t,n,r,i,o,2):2===u&&v(e,t,n,r,i,o):d(f(e),t,n,r,i,o,1);break}}}function h(e){var t=e.prev,n=e,r=e.next;if(C(t,n,r)>=0)return!1;for(var i=e.next.next;i!==e.prev;){if(B(t.x,t.y,n.x,n.y,r.x,r.y,i.x,i.y)&&C(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function y(e,t,n,r){var i=e.prev,o=e,u=e.next;if(C(i,o,u)>=0)return!1;for(var l=i.x>o.x?i.x>u.x?i.x:u.x:o.x>u.x?o.x:u.x,s=i.y>o.y?i.y>u.y?i.y:u.y:o.y>u.y?o.y:u.y,a=b(i.x<o.x?i.x<u.x?i.x:u.x:o.x<u.x?o.x:u.x,i.y<o.y?i.y<u.y?i.y:u.y:o.y<u.y?o.y:u.y,t,n,r),x=b(l,s,t,n,r),c=e.prevZ,f=e.nextZ;c&&c.z>=a&&f&&f.z<=x;){if(c!==e.prev&&c!==e.next&&B(i.x,i.y,o.x,o.y,u.x,u.y,c.x,c.y)&&C(c.prev,c,c.next)>=0)return!1;if(c=c.prevZ,f!==e.prev&&f!==e.next&&B(i.x,i.y,o.x,o.y,u.x,u.y,f.x,f.y)&&C(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(;c&&c.z>=a;){if(c!==e.prev&&c!==e.next&&B(i.x,i.y,o.x,o.y,u.x,u.y,c.x,c.y)&&C(c.prev,c,c.next)>=0)return!1;c=c.prevZ}for(;f&&f.z<=x;){if(f!==e.prev&&f!==e.next&&B(i.x,i.y,o.x,o.y,u.x,u.y,f.x,f.y)&&C(f.prev,f,f.next)>=0)return!1;f=f.nextZ}return!0}function p(e,t,n){var r=e;do{var i=r.prev,o=r.next.next;!S(i,o)&&I(i,r,r.next,o)&&O(i,o)&&O(o,i)&&(t.push(i.i/n),t.push(r.i/n),t.push(o.i/n),P(r),P(r.next),r=e=o),r=r.next}while(r!==e);return f(r)}function v(e,t,n,r,i,o){var u=e;do{for(var l=u.next.next;l!==u.prev;){if(u.i!==l.i&&Z(u,l)){var s=k(u,l);return u=f(u,u.next),s=f(s,s.next),d(u,t,n,r,i,o),void d(s,t,n,r,i,o)}l=l.next}u=u.next}while(u!==e)}function g(e,t){return e.x-t.x}function M(e,t){if(t=function(e,t){var n,r=t,i=e.x,o=e.y,u=-Infinity;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var l=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(l<=i&&l>u){if(u=l,l===i){if(o===r.y)return r;if(o===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!n)return null;if(i===u)return n;var s,a=n,x=n.x,c=n.y,f=Infinity;r=n;do{i>=r.x&&r.x>=x&&i!==r.x&&B(o<c?i:u,o,x,c,o<c?u:i,o,r.x,r.y)&&(s=Math.abs(o-r.y)/(i-r.x),O(r,e)&&(s<f||s===f&&(r.x>n.x||r.x===n.x&&m(n,r)))&&(n=r,f=s)),r=r.next}while(r!==a);return n}(e,t),t){var n=k(t,e);f(t,t.next),f(n,n.next)}}function m(e,t){return C(e.prev,e,t.prev)<0&&C(t.next,e,e.next)<0}function b(e,t,n,r,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*i)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*i)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function w(e){var t=e,n=e;do{(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),t=t.next}while(t!==e);return n}function B(e,t,n,r,i,o,u,l){return(i-u)*(t-l)-(e-u)*(o-l)>=0&&(e-u)*(r-l)-(n-u)*(t-l)>=0&&(n-u)*(o-l)-(i-u)*(r-l)>=0}function Z(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&I(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&(O(e,t)&&O(t,e)&&function(e,t){var n=e,r=!1,i=(e.x+t.x)/2,o=(e.y+t.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==e);return r}(e,t)&&(C(e.prev,e,t.prev)||C(e,t.prev,t))||S(e,t)&&C(e.prev,e,e.next)>0&&C(t.prev,t,t.next)>0)}function C(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function S(e,t){return e.x===t.x&&e.y===t.y}function I(e,t,n,r){var i=T(C(e,t,n)),o=T(C(e,t,r)),u=T(C(n,r,e)),l=T(C(n,r,t));return i!==o&&u!==l||!(0!==i||!z(e,n,t))||!(0!==o||!z(e,r,t))||!(0!==u||!z(n,e,r))||!(0!==l||!z(n,t,r))}function z(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}function T(e){return e>0?1:e<0?-1:0}function O(e,t){return C(e.prev,e,e.next)<0?C(e,t,e.next)>=0&&C(e,e.prev,t)>=0:C(e,t,e.prev)<0||C(e,e.next,t)<0}function k(e,t){var n=new R(e.i,e.x,e.y),r=new R(t.i,t.x,t.y),i=e.next,o=t.prev;return e.next=t,t.prev=e,n.next=i,i.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function F(e,t,n,r){var i=new R(e,t,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function P(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function R(e,t,n){this.i=e,this.x=t,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function j(e,t,n,r){for(var i=0,o=t,u=n-r;o<n;o+=r)i+=(e[u]-e[o])*(e[o+1]+e[u+1]),u=o;return i}o(),o(),r(),a(),a(),e(3),i(),a(),e(3),x.deviation=function(e,t,n,r){var i=t&&t.length,o=Math.abs(j(e,0,i?t[0]*n:e.length,n));if(i)for(var u=0,l=t.length;u<l;u++)o-=Math.abs(j(e,t[u]*n,u<l-1?t[u+1]*n:e.length,n));var s=0;for(u=0;u<r.length;u+=3){var a=r[u]*n,x=r[u+1]*n,c=r[u+2]*n;s+=Math.abs((e[a]-e[c])*(e[x+1]-e[a+1])-(e[a]-e[x])*(e[c+1]-e[a+1]))}return 0===o&&0===s?0:Math.abs((s-o)/o)},x.flatten=function(e){for(var t=e[0][0].length,n={vertices:[],holes:[],dimensions:t},r=0,i=0;i<e.length;i++){for(var o=0;o<e[i].length;o++)for(var u=0;u<t;u++)n.vertices.push(e[i][o][u]);i>0&&n.holes.push(r+=e[i-1].length)}return n};var D,E,A=20002,G=1001;(D={})[1e3]="BasicEntity",D[1001]="BasicAggregation",(E={})[2e3]="Bridge",E[2001]="BridgePart",E[2002]="BridgeInstallation",E[2003]="BridgeConstructiveElement",E[2004]="BridgeRoom",E[2005]="BridgeFurniture",E[2006]="Building",E[2007]="BuildingPart",E[2008]="BuildingInstallation",E[2009]="BuildingConstructiveElement",E[2010]="BuildingFurniture",E[2011]="BuildingStorey",E[2012]="BuildingRoom",E[2013]="BuildingUnit",E[2014]="CityFurniture",E[2015]="CityObjectGroup",E[2016]="LandUse",E[2017]="OtherConstruction",E[2018]="PlantCover",E[2019]="SolitaryVegetationObject",E[2020]="TINRelief",E[2021]="TransportationSquare",E[2022]="Railway",E[2023]="Road",E[2024]="Tunnel",E[2025]="TunnelPart",E[2026]="TunnelInstallation",E[2027]="TunnelInstallation",E[2028]="TunnelHollowSpace",E[2029]="TunnelFurniture",E[2030]="WaterBody",E[2031]="Waterway";var L={Bridge:2e3,BridgePart:2001,BridgeInstallation:2002,BridgeConstructiveElement:2003,BridgeRoom:2004,BridgeFurniture:2005,Building:2006,BuildingPart:2007,BuildingInstallation:2008,BuildingConstructiveElement:2009,BuildingFurniture:2010,BuildingStorey:2011,BuildingRoom:2012,BuildingUnit:2013,CityFurniture:2014,CityObjectGroup:2015,LandUse:2016,OtherConstruction:2017,PlantCover:2018,SolitaryVegetationObject:2019,TINRelief:2020,TransportationSquare:2021,Railway:2022,Road:2023,Tunnel:2024,TunnelPart:2025,TunnelInstallation:2026,TunnelConstructiveElement:2026,TunnelHollowSpace:2028,TunnelFurniture:2029,WaterBody:2030,Waterway:2031};const U=r(),W=i(),q=i(),H=i();function N(e,n={rotateX:!1}){if(e.sceneModel){if(e.sceneModel.destroyed)throw new t("SceneModel already destroyed");if(e.sceneModel.built)throw new t("SceneModel already built")}if(e.dataModel){if(e.dataModel.destroyed)throw new t("DataModel already destroyed");if(e.dataModel.built)throw new t("DataModel already built")}return new Promise(function(t,r){const i=e.fileData;!function(e){const t=e.fileData.CityObjects;for(const n in t)X(e,t[n],n);if(e.dataModel)for(const n in t)J(e,t[n],n)}({fileData:i,vertices:i.transform&&e.sceneModel?V(i.vertices,i.transform,n.rotateX):i.vertices,sceneModel:e.sceneModel,dataModel:e.dataModel,nextId:0}),t()})}function V(e,t,n){const r=[],o=t.scale||i([1,1,1]),u=t.translate||i([0,0,0]);for(let t=0,i=0;t<e.length;t++,i+=3){const i=e[t][0]*o[0]+u[0],l=e[t][1]*o[1]+u[1],s=e[t][2]*o[2]+u[2];r.push(n?[i,s,l]:[i,l,s])}return r}function X(e,t,n){if(e.dataModel&&e.dataModel.createObject({id:n,name:t.type+" : "+n,type:0|L[t.type],parent:t.parents?t.parents[0]:null}),e.sceneModel){if(!(t.geometry&&t.geometry.length>0))return;const r=[];for(let n=0,i=t.geometry.length;n<i;n++){const i=t.geometry[n];let o,u;const l=e.fileData.appearance;if(l){const e=l.materials;if(e){const t=i.material;if(t){const r=Object.keys(t);if(r.length>0){const i=t[r[0]];if(void 0!==i.value)o=e[i.value];else{const t=i.values;if(t){u=[];for(let r=0,i=t.length;r<i;r++)u.push(e[t[n]])}}}}}}u?K(e,i,u,r):Y(e,i,o,r)}r.length>0&&e.sceneModel.createObject({id:n,meshIds:r})}}function J(e,t,n){t.parents&&e.dataModel.createRelationship({relatingObjectId:t.parents[0],relatedObjectId:n,type:G})}function K(e,t,n,r){switch(t.type){case"MultiPoint":case"MultiLineString":break;case"MultiSurface":case"CompositeSurface":Q(e,n,t.boundaries,r);break;case"Solid":const i=t.boundaries;for(let t=0;t<i.length;t++)Q(e,n,i[t],r);break;case"MultiSolid":case"CompositeSolid":const o=t.boundaries;for(let t=0;t<o.length;t++)for(let i=0;i<o[t].length;i++)Q(e,n,o[t][i],r)}}function Q(e,t,n,r){const o=e.vertices,u=e.sceneModel;for(let l=0;l<n.length;l++){const s=n[l],a=t[l]||{diffuseColor:[.8,.8,.8],transparency:1},c=[],f=[],d=[],h={positions:[],indices:[]};for(let t=0;t<s.length;t++){c.length>0&&f.push(c.length);const n=_(e,s[t],d,h);c.push(...n)}if(3===c.length)h.indices.push(c[0]),h.indices.push(c[1]),h.indices.push(c[2]);else if(c.length>3){const e=[];for(let t=0;t<c.length;t++)e.push({x:o[d[c[t]]][0],y:o[d[c[t]]][1],z:o[d[c[t]]][2]});const t=ee(e,i());let n=[];for(let r=0;r<e.length;r++)te(e[r],t,U),n.unshift(U[0]),n.unshift(U[1]);const r=x(n,f,2);for(let e=0;e<r.length;e+=3)h.indices.unshift(c[r[e]]),h.indices.unshift(c[r[e+1]]),h.indices.unshift(c[r[e+2]])}const y=""+e.nextId++;u.createGeometry({id:y,primitive:A,positions:h.positions,indices:h.indices});const p=""+e.nextId++;u.createMesh({id:p,geometryId:y,color:a&&a.diffuseColor?a.diffuseColor:[.8,.8,.8],opacity:a&&void 0!==a.transparency?1-a.transparency:1}),r.push(p)}}function Y(e,t,n,r){const i=e.sceneModel,o=[],u={positions:[],indices:[]};switch(t.type){case"MultiPoint":case"MultiLineString":break;case"MultiSurface":case"CompositeSurface":$(e,t.boundaries,o,u);break;case"Solid":const n=t.boundaries;for(let t=0;t<n.length;t++)$(e,n[t],o,u);break;case"MultiSolid":case"CompositeSolid":const r=t.boundaries;for(let t=0;t<r.length;t++)for(let n=0;n<r[t].length;n++)$(e,r[t][n],o,u)}if(u.positions.length>0&&u.indices.length>0){const t=""+e.nextId++;i.createGeometry({id:t,primitive:A,positions:u.positions,indices:u.indices});const o=""+e.nextId++;i.createMesh({id:o,geometryId:t,color:n&&n.diffuseColor?n.diffuseColor:[.8,.8,.8],opacity:1}),r.push(o)}}function $(e,t,n,r){const o=e.vertices;for(let u=0;u<t.length;u++){let l=[],s=[];for(let i=0;i<t[u].length;i++){l.length>0&&s.push(l.length);const o=_(e,t[u][i],n,r);l.push(...o)}if(3===l.length)r.indices.push(l[0]),r.indices.push(l[1]),r.indices.push(l[2]);else if(l.length>3){let e=[];for(let t=0;t<l.length;t++)e.push({x:o[n[l[t]]][0],y:o[n[l[t]]][1],z:o[n[l[t]]][2]});const t=ee(e,i());let u=[];for(let n=0;n<e.length;n++)te(e[n],t,U),u.unshift(U[0]),u.unshift(U[1]);const a=x(u,s,2);for(let e=0;e<a.length;e+=3)r.indices.unshift(l[a[e]]),r.indices.unshift(l[a[e+1]]),r.indices.unshift(l[a[e+2]])}}}function _(e,t,n,r){const i=e.vertices,o=[];for(let e=0,u=t.length;e<u;e++){const u=t[e];if(n.includes(u)){const e=n.indexOf(u);o.push(e)}else r.positions.push(i[u][0]),r.positions.push(i[u][1]),r.positions.push(i[u][2]),o.push(n.length),n.push(u)}return o}function ee(e,t){for(let n=0;n<e.length;n++){let r=n+1;r===e.length&&(r=0),t[0]+=(e[n].y-e[r].y)*(e[n].z+e[r].z),t[1]+=(e[n].z-e[r].z)*(e[n].x+e[r].x),t[2]+=(e[n].x-e[r].x)*(e[n].y+e[r].y)}return s(t)}function te(e,t,r){const o=W,a=q,x=H;o[0]=e.x,o[1]=e.y,o[2]=e.z,a[0]=t.x,a[1]=t.y,a[2]=t.z,x[0]=1.1,x[1]=1.1,x[2]=1.1;const c=l(function(e,t,n){return n||(n=e),n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n}(x,a));c<.01&&(x[0]+=1,x[1]+=2,x[2]+=3);const f=u(a,n(x,a),i());x[0]-=f[0],x[1]-=f[1],x[2]-=f[2],s(x);const d=function(e,t,n){n||(n=e);var r=e[0],i=e[1],o=e[2],u=t[0],l=t[1],s=t[2];return n[0]=i*s-o*l,n[1]=o*u-r*s,n[2]=r*l-i*u,n}(a,x,i()),h=n(o,x),y=n(o,d);r[0]=h,r[1]=y}export{N as loadCityJSON};
//# sourceMappingURL=cityjson.modern.mjs.map
